
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Explaining XGBoost model predictions with SHAP values: Analysis of hopsital SHAP values &#8212; Using explainable machine learning to understand variation in thrombolysis practice</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Describing model predictions, using SHAP values and SHAP interactions" href="12a_xgb_shap_interactions.html" />
    <link rel="prev" title="Explaining XGBoost model predictions with SHAP values" href="03_xgb_combined_shap_key_features.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Using explainable machine learning to understand variation in thrombolysis practice</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/intro.html">
                    Summary and outline
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introductory content
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../key_notebooks_redundant/outline.html">
   Outline of notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/glossary.html">
   Glossary of technical terms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/odds_prob.html">
   Probability, odds, and SHAP values (log odds shifts)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/shap_worked_example.html">
   A simple worked example of Shap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="90_shap_interactions_on_titanic.html">
   Examining interactions between features with SHAP interactions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Predicting thrombolysis use and explaining the predictions with Shap
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_xgb_combined_fit_feature_selection.html">
   XGBoost feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_correlation.html">
   Check correlation between features selected for the model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_xgb_combined_fit_accuracy_key_features.html">
   Measuring accuracy of XGBoost models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02a_xgb_combined_fit_most_thrombolysable_patients.html">
   An anlysis of the characteristics of the most thrombolysable patient at each hopsital
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_xgb_combined_shap_key_features.html">
   Explaining XGBoost model predictions with SHAP values
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Explaining XGBoost model predictions with SHAP values: Analysis of hopsital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12a_xgb_shap_interactions.html">
   Describing model predictions, using SHAP values and SHAP interactions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Comparing thrombolysis decisions between hospitals
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="04_compare_10k_cohort_key_features.html">
   A comparison of 10k cohort thrombolysis rates across hospitals, and comparison with hospital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_compare_benchmark_decisions_key_features.html">
   Compare local thrombolysis decisions with benchmark decisions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_predict_differences_between_local_and_benchmark_key_features.html">
   Predicting differences between local and benchmark decisions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units.html">
   Comparing Shap values between high and low thrombolysing hospitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_plot_thrombolysis_at_high_vs_low_thrombolysing_units.html">
   Plotting thrombolysis rate by feature value for low and high thrombolysing hopsitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="20_synthetic_patients.html">
   Investigating the effect of patient features by varying feature values in artificial patients
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="50_bagging_variation.html">
   Evaluating variation in model predictions and predicted 10k thrombolysis rate using bootstrap models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="91_learning_rate_optimisation.html">
   Evaluation of XGBoost learning rates on distribution of 10k thrombolysis rates
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/xgb_10_features/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-modules">
   Import modules
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-filenames">
   Set filenames
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-list-of-feature-names">
   Get list of feature names
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#edit-data">
   Edit data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">
     Divide into X (features) and y (labels)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-hot-encode-hospital-feature">
     One-hot encode hospital feature
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-xgboost-model">
   Load XGBoost model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-values">
   SHAP values
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-shap-values">
     Get SHAP values
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#format-the-shap-values-data">
       Format the SHAP values data
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-interaction-values">
   SHAP interaction values
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-shap-interaction-values">
     Get SHAP interaction values
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#format-the-shap-interaction-data">
       Format the SHAP interaction data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#boxplot-all-hospitals-together">
       Boxplot (all hospitals together)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#boxplot-individual-hospitals">
       Boxplot (individual hospitals)
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Observations
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Explaining XGBoost model predictions with SHAP values: Analysis of hopsital SHAP values</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-modules">
   Import modules
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-filenames">
   Set filenames
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-list-of-feature-names">
   Get list of feature names
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#edit-data">
   Edit data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">
     Divide into X (features) and y (labels)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-hot-encode-hospital-feature">
     One-hot encode hospital feature
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-xgboost-model">
   Load XGBoost model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-values">
   SHAP values
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-shap-values">
     Get SHAP values
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#format-the-shap-values-data">
       Format the SHAP values data
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-interaction-values">
   SHAP interaction values
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-shap-interaction-values">
     Get SHAP interaction values
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#format-the-shap-interaction-data">
       Format the SHAP interaction data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#boxplot-all-hospitals-together">
       Boxplot (all hospitals together)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#boxplot-individual-hospitals">
       Boxplot (individual hospitals)
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Observations
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="explaining-xgboost-model-predictions-with-shap-values-analysis-of-hopsital-shap-values">
<h1>Explaining XGBoost model predictions with SHAP values: Analysis of hopsital SHAP values<a class="headerlink" href="#explaining-xgboost-model-predictions-with-shap-values-analysis-of-hopsital-shap-values" title="Permalink to this headline">#</a></h1>
<p>Isolating the SHAP value (and SHAP main effect) for patients that attend a hospital, from the SHAP value (and SHAP main effect) for patients that do not attend a hospital</p>
<section id="plain-english-summary">
<h2>Plain English summary<a class="headerlink" href="#plain-english-summary" title="Permalink to this headline">#</a></h2>
<p>When fitting a machine learning model to data to make a prediction, it is now possible, with the use of the SHAP library, to allocate contributions of the prediction onto the feature values. This means that we can now turn these black box methods into transparent models and describe what the model used to obtain it’s prediction.</p>
<p>SHAP values are calculated for each feature of each instance for a fitted model. In addition there is the SHAP base value which is the same value for all of the instances. The base value represents the models best guess for any instance without any extra knowledge about the instance (this can also be thought of as the “expected value”). It is possible to obtain the models prediction of an instance by taking the sum of the SHAP base value and each of the SHAP values for the features. This allows the prediction from a model to be transparant, and we can rank the features by their importance in determining the prediction for each instance.</p>
<p>In two other detailed notebooks (see GitHub repo for these notebooks: <a class="reference external" href="https://github.com/samuel-book/samuel_shap_paper_1">https://github.com/samuel-book/samuel_shap_paper_1</a>), we looked at SHAP values (03a_xgb_shap_values_focus_on_ohe_hospitals.ipynb) and SHAP main effect (3b_xgb_combined_shap_key_features.ipynb) for the one-hot encoded hospital features. We looked at the values for patients that attend the hospital, and for those that do not (as we have seen that the hospital has a SHAP value when a patient attend another one, so there is a contribution to the prediction based on <em>not</em> attending a hospital).</p>
<p>SHAP values are in the same units as the model output (for XGBoost these are in log odds).</p>
<p>Here we load an already fitted XGBoost model to the SAMueL dataset (in notebook 03a_xgb_shap_values_focus_on_ohe_hospitals.ipynb), to predict whether a patient recieves thrombolysis from the values of eight features. We calculate the SHAP values of this fitted model and explore the SHAP values and SHAP main effect values for each of the one-hot encoded hospital features.</p>
</section>
<section id="model-and-data">
<h2>Model and data<a class="headerlink" href="#model-and-data" title="Permalink to this headline">#</a></h2>
<p>XGBoost model was trained on all of the data (no test set used). The 10 features in the model are:</p>
<ul class="simple">
<li><p>Arrival-to-scan time: Time from arrival at hospital to scan (mins)</p></li>
<li><p>Infarction: Stroke type (1 = infarction, 0 = haemorrhage)</p></li>
<li><p>Stroke severity: Stroke severity (NIHSS) on arrival</p></li>
<li><p>Precise onset time: Onset time type (1 = precise, 0 = best estimate)</p></li>
<li><p>Prior disability level: Disability level (modified Rankin Scale) before stroke</p></li>
<li><p>Use of AF anticoagulents: Use of atrial fibrillation anticoagulant (0 = No, 1 = Yes)</p></li>
<li><p>Onset-to-arrival time: Time from onset of stroke to arrival at hospital (mins)</p></li>
<li><p>Onset during sleep: Did stroke occur in sleep?</p></li>
<li><p>Age: Age (as middle of 5 year age bands)</p></li>
<li><p>Stroke team: Represented as one-hot encoded features</p></li>
</ul>
<p>And one target feature:</p>
<ul class="simple">
<li><p>Thrombolysis: Did the patient recieve thrombolysis (0 = No, 1 = Yes)</p></li>
</ul>
</section>
<section id="aims">
<h2>Aims<a class="headerlink" href="#aims" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Fit XGBoost model using feature data to predict whether patient gets thrombolysis</p></li>
<li><p>Calculate the SHAP values of the features</p></li>
<li><p>Understand the SHAP values for the hospital one-hot encoded features</p></li>
</ul>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Both of the SHAP values and SHAP main effect values for the one-hot encoded hospital features are very dependent on whether the instance attended the hospital or not</p></li>
<li><p>For the instances that attend a hospital, the SHAP main effect values are a narrower range than the equivalent SHAP values (due to the SHAP values being made up of the main effect and the pair-wise feature interactions).</p></li>
<li><p>56% of the variability in hospital thrombolysis rate can be explained by the SHAP main effect value for the one-hot encoded hospital feature (the median of those instances that attend the hospital).</p></li>
<li><p>58% of the variability in hospital thrombolysis rate can be explained by the SHAP main effect value for the one-hot encoded hospital feature (the median of those instances that attend the hospital).</p></li>
</ul>
</section>
<section id="import-modules">
<h2>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Import machine learning methods</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="c1"># Import shap for shapley values</span>
<span class="kn">import</span> <span class="nn">shap</span> <span class="c1"># `pip install shap` if neeed</span>

<span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">math</span> <span class="c1"># to .floor and .ceil</span>

<span class="c1"># So can take deep copy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1">#import scipy.stats</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/michael/miniconda3/envs/samuel/lib/python3.8/site-packages/xgboost/compat.py:36: FutureWarning: pandas.Int64Index is deprecated and will be removed from pandas in a future version. Use pandas.Index with the appropriate dtype instead.
  from pandas import MultiIndex, Int64Index
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-filenames">
<h2>Set filenames<a class="headerlink" href="#set-filenames" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set model type (used in file save, e.g. xgb_combined_calibrated_oversampled)</span>
<span class="n">number_of_features_to_use</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xgb_</span><span class="si">{</span><span class="n">number_of_features_to_use</span><span class="si">}</span><span class="s1">_features&#39;</span>
<span class="n">notebook</span> <span class="o">=</span> <span class="s1">&#39;03c&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-output-folders-if-needed">
<h2>Create output folders if needed<a class="headerlink" href="#create-output-folders-if-needed" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./saved_models&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./output&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./predictions&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>   
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-json-file">
<h2>Read in JSON file<a class="headerlink" href="#read-in-json-file" title="Permalink to this headline">#</a></h2>
<p>Contains a dictionary for plain English feature names for the 8 features selected in the model. Use these as the column titles in the DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./output/01_feature_name_dict.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">dict_feature_name</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline">#</a></h2>
<p>Data has previously been split into 5 stratified k-fold splits.</p>
<p>For this exercise, we will fit a model using all of the data (rather than train/test splits used to assess accuracy). We will join up all of the test data (by definition, each instance exists only once across all of the 5 test sets)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;../data/kfold_5fold/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise empty list</span>
<span class="n">test_data_kfold</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Read in the names of the selected features for the model</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./output/01_feature_selection.csv&#39;</span><span class="p">)</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])[:</span><span class="n">number_of_features_to_use</span><span class="p">]</span>
<span class="c1"># And add the target feature name: S2Thrombolysis</span>
<span class="n">key_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">)</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Read in test set, restrict to chosen features, rename titles, &amp; store</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;test_</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">key_features</span><span class="p">]</span>
    <span class="n">test</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dict_feature_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_data_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="c1"># Join all the test sets. Set &quot;ignore_index = True&quot; to reset the index in the</span>
<span class="c1">#   new dataframe (to run from 0 to n-1), otherwise get duplicate index values</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">test_data_kfold</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-list-of-feature-names">
<h2>Get list of feature names<a class="headerlink" href="#get-list-of-feature-names" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data_kfold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="edit-data">
<h2>Edit data<a class="headerlink" href="#edit-data" title="Permalink to this headline">#</a></h2>
<section id="divide-into-x-features-and-y-labels">
<h3>Divide into X (features) and y (labels)<a class="headerlink" href="#divide-into-x-features-and-y-labels" title="Permalink to this headline">#</a></h3>
<p>We will separate out our features (the data we use to make a prediction) from our label (what we are trying to predict).
By convention our features are called <code class="docutils literal notranslate"><span class="pre">X</span></code> (usually upper case to denote multiple features), and the label (thrombolysis or not) <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Average thromboylsis (this is the expected outcome of each patient, without knowing anything about the patient)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average treatment: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average treatment: 0.3
</pre></div>
</div>
</div>
</div>
</section>
<section id="one-hot-encode-hospital-feature">
<h3>One-hot encode hospital feature<a class="headerlink" href="#one-hot-encode-hospital-feature" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep copy of original, with &#39;Stroke team&#39; not one-hot encoded</span>
<span class="n">X_combined</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># One-hot encode &#39;Stroke team&#39;</span>
<span class="n">X_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">X_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="load-xgboost-model">
<h2>Load XGBoost model<a class="headerlink" href="#load-xgboost-model" title="Permalink to this headline">#</a></h2>
<p>An XGBoost model was trained on the full dataset (rather than train/test splits used to assess accuracy) in notebook 03a_xgb_shap_values_focus_on_ohe_hospitals.ipynb</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load models</span>
<span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./saved_models/03a_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">.p&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
        
<span class="c1"># Get the predictions for each patient </span>
<span class="c1">#   (the classification, and the probability of being in either class)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Calculate the models accuracy</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model accuracy: 0.878
</pre></div>
</div>
</div>
</div>
</section>
<section id="shap-values">
<h2>SHAP values<a class="headerlink" href="#shap-values" title="Permalink to this headline">#</a></h2>
<p>SHAP values give the contribution that each feature has on the models prediction, per instance. A SHAP value is returned for each feature, for each instance.</p>
<p>We will use the shap library: <a class="reference external" href="https://shap.readthedocs.io/en/latest/index.html">https://shap.readthedocs.io/en/latest/index.html</a></p>
<p>‘Raw’ SHAP values from XGBoost model are log odds ratios.</p>
<section id="get-shap-values">
<h3>Get SHAP values<a class="headerlink" href="#get-shap-values" title="Permalink to this headline">#</a></h3>
<p>TreeExplainer is a fast and exact method to estimate SHAP values for tree models and ensembles of trees.
Using this we can calculate the SHAP values.</p>
<p>Load from pickle (saved from notebook 3a)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#filename = f&#39;./output/03a_{model_text}_shap_explainer_object.p&#39;</span>
<span class="c1">#file_exists = exists(filename)</span>

<span class="c1">#if file_exists:</span>
<span class="c1">#    # Load explainer</span>
<span class="c1">#    with open(filename, &#39;rb&#39;) as filehandler:</span>
<span class="c1">#        explainer = pickle.load(filehandler)</span>
<span class="c1">#else:</span>
<span class="c1">#    print(&quot;Run notebook 03a_xgb_shap_values_focus_on_ohe_hospitals.ipynb&quot;)</span>
<span class="c1">##    end</span>

<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03a_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_explainer_object.p&#39;</span>
<span class="n">file_exists</span> <span class="o">=</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
    <span class="c1"># Load SHAP values</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run notebook 03a_xgb_shap_values_focus_on_ohe_hospitals.ipynb&quot;</span><span class="p">)</span>
<span class="c1">#    end</span>
</pre></div>
</div>
</div>
</div>
<p>The explainer returns the base value which is the same value for all instances [shap_value.base_values], the shap values per feature [shap_value.values]. It also returns the feature dataset values [shap_values.data]. You can (sometimes!) access the feature names from the explainer [explainer.data_feature_names].</p>
<p>Let’s take a look at the data held for the first instance:</p>
<ul class="simple">
<li><p>.values has the SHAP value for each of the four features.</p></li>
<li><p>.base_values has the best guess value without knowing anything about the instance.</p></li>
<li><p>.data has each of the feature values</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.values =
array([ 7.56502628e-01,  4.88319576e-01,  1.10273695e+00,  4.40223962e-01,
        4.98975307e-01,  2.02812225e-01, -2.62601525e-01,  3.69181409e-02,
        2.30234995e-01,  3.20923195e-04, -6.03703642e-03, -7.17267860e-04,
        0.00000000e+00, -4.91688668e-04,  1.20360847e-03,  1.77788886e-03,
       -4.34198463e-03, -2.76021136e-04, -2.79896380e-03,  3.52182891e-03,
       -2.73969141e-04,  8.53505917e-03, -5.28220041e-03, -8.25227005e-04,
        6.20208494e-03,  6.92215608e-03, -6.32244349e-03, -3.35367222e-04,
        7.81939551e-03, -4.71850217e-06, -4.25534381e-05,  6.48253039e-03,
        8.43156071e-04, -6.28353562e-04, -1.25156669e-02, -7.92063680e-03,
       -1.99409085e-03, -5.05548809e-03, -3.90118686e-03,  1.30317558e-03,
        0.00000000e+00, -6.48246554e-04,  1.19629130e-03,  8.26304778e-04,
        1.28053436e-02,  2.55714403e-03, -3.20375757e-03,  4.23251512e-03,
       -7.19791185e-03,  4.02670400e-03,  3.75146419e-03,  8.31848301e-04,
        3.45067866e-03,  3.92199913e-03,  1.05317042e-04,  9.53648426e-03,
        2.34490633e-03, -1.05699897e-03, -7.75758363e-03,  1.09220366e-03,
        0.00000000e+00,  5.15310653e-03, -1.28013985e-02,  7.28079583e-03,
        1.98326469e-03,  2.40865033e-04,  6.70310017e-03,  1.18395500e-03,
        8.82393331e-04,  2.83133984e-03,  2.06021918e-03, -8.22589453e-03,
        5.11038816e-03, -3.25066457e-03, -1.15480982e-02,  9.36000666e-04,
        2.03671609e-03, -2.02708528e-03, -5.31264208e-03,  2.42300611e-03,
        3.16989725e-04,  3.67143471e-03, -5.07418578e-03, -2.68517504e-03,
        3.30522249e-04, -6.63852552e-03, -1.63316587e-03,  1.75383547e-03,
       -4.12231544e-03,  1.20234396e-03, -6.25999365e-03,  0.00000000e+00,
       -1.00428164e-02, -1.76329317e-03,  3.12283775e-03,  4.69124934e-04,
       -1.22163491e-03,  2.30912305e-03,  9.43152234e-04,  1.22348359e-03,
        5.29656609e-05, -9.66969132e-03,  3.44762520e-06, -5.46710449e-04,
        4.26546484e-03,  4.65912558e-03,  1.30611981e-04, -2.89813057e-03,
       -2.98934802e-03, -1.47398096e-03, -2.31104009e-02, -3.47609469e-03,
       -5.73671749e-03,  3.97895870e-04,  9.02379164e-04, -5.86819311e-04,
       -1.79305486e-03, -5.28960605e-04, -2.10736915e-02,  3.50499223e-03,
       -2.04754542e-04, -2.86527374e-03,  1.52953295e-03, -3.72403156e-06,
        1.42271689e-03, -2.97368824e-04,  5.06201060e-04,  5.77868486e-04,
       -1.44459037e-02,  3.30785802e-03, -2.37809308e-03, -7.35214865e-03,
        3.36531224e-03,  1.49519066e-03, -2.46208580e-03,  7.20066251e-04,
        6.83251710e-04, -1.92034326e-03,  2.39002449e-03, -8.96935933e-04,
        4.85493708e-03], dtype=float32)

.base_values =
-1.1629876

.data =
array([ 17. ,   1. ,  14. ,   1. ,   0. ,   0. , 186. ,   0. ,  47.5,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   1. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ])
</pre></div>
</div>
</div>
</div>
<p>There is one of these for each instance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_values</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(88792, 141)
</pre></div>
</div>
</div>
</div>
<section id="format-the-shap-values-data">
<h4>Format the SHAP values data<a class="headerlink" href="#format-the-shap-values-data" title="Permalink to this headline">#</a></h4>
<p>Features are in the same order in shap_values as they are in the original dataset.</p>
<p>Use this fact to extract the SHAP values for the one-hot encoded hospital features. Create a dataframe containing the SHAP values: an instance per row, and a one-hot encoded hospital feature per column.</p>
<p>Also include a column containing the Stroke team that each instance attended.</p>
<p>And three further columns:</p>
<ol class="simple">
<li><p>contribution from all the hospital features</p></li>
<li><p>contribution from attending the hospital</p></li>
<li><p>contribution from not attending the rest</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get list of hospital one hot encoded column titles</span>
<span class="n">hospital_names_ohe</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^team&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
<span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hospital_names_ohe</span><span class="p">)</span>

<span class="c1"># Get list of hospital names without the prefix &quot;team_&quot;</span>
<span class="n">hospital_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names_ohe</span><span class="p">]</span>

<span class="c1"># Create list of column index for these hospital column titles</span>
<span class="n">hospital_columns_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">hospital_names_ohe</span><span class="p">]</span>

<span class="c1"># Use this index list to access the hosptial shap values (as array)</span>
<span class="n">hosp_shap_values</span> <span class="o">=</span> <span class="n">shap_values</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="n">hospital_columns_index</span><span class="p">]</span>
<span class="c1"># Put in dataframe with hospital as column title</span>
<span class="n">df_hosp_shap_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hosp_shap_values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">hospital_names</span><span class="p">)</span>
<span class="c1"># Include Stroke team that each instance attended</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_combined</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Store the sum of the SHAP values (for all of the hospital features)</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;all_stroke_teams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Initialise list for 1) SHAP value for attended hospital 2) SHAP value for </span>
<span class="c1">#   the sum of the rest of the hospitals</span>
<span class="n">shap_values_attended_hospital</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">shap_values_not_attend_these_hospitals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each patient</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

    <span class="c1"># Get stroke team attended</span>
    <span class="n">stroke_team</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span>
    
    <span class="c1"># Get SHAP value for the stroke team attended</span>
    <span class="n">shap_values_attended_hospital</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">])</span>

    <span class="c1"># Calculate sum of SHAP values for the stroke teams not attend </span>
    <span class="n">sum_rest</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;all_stroke_teams&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">]</span>
    <span class="n">shap_values_not_attend_these_hospitals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_rest</span><span class="p">)</span>

<span class="c1"># Store two new columns in dataframe</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;attended_stroke_team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shap_values_attended_hospital</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;not_attended_stroke_teams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shap_values_not_attend_these_hospitals</span>
                   
<span class="c1"># View preview</span>
<span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AGNOF1041H</th>
      <th>AKCGO9726K</th>
      <th>AOBTM3098N</th>
      <th>APXEE8191H</th>
      <th>ATDID5461S</th>
      <th>BBXPQ0212O</th>
      <th>BICAW1125K</th>
      <th>BQZGT7491V</th>
      <th>BXXZS5063A</th>
      <th>CNBGF2713O</th>
      <th>...</th>
      <th>YEXCH8391J</th>
      <th>YPKYH1768F</th>
      <th>YQMZV4284N</th>
      <th>ZBVSO0975W</th>
      <th>ZHCLE1578P</th>
      <th>ZRRCV7012C</th>
      <th>Stroke team</th>
      <th>all_stroke_teams</th>
      <th>attended_stroke_team</th>
      <th>not_attended_stroke_teams</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000321</td>
      <td>-0.006037</td>
      <td>-0.000717</td>
      <td>0.0</td>
      <td>-0.000492</td>
      <td>0.001204</td>
      <td>0.001778</td>
      <td>-0.004342</td>
      <td>-0.000276</td>
      <td>-0.002799</td>
      <td>...</td>
      <td>0.000720</td>
      <td>0.000683</td>
      <td>-0.001920</td>
      <td>0.002390</td>
      <td>-0.000897</td>
      <td>0.004855</td>
      <td>TXHRP7672C</td>
      <td>-0.084398</td>
      <td>-0.023110</td>
      <td>-0.061287</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.001207</td>
      <td>-0.002507</td>
      <td>0.000081</td>
      <td>0.0</td>
      <td>-0.001356</td>
      <td>0.001547</td>
      <td>0.003449</td>
      <td>-0.006348</td>
      <td>-0.000127</td>
      <td>-0.002576</td>
      <td>...</td>
      <td>0.000148</td>
      <td>0.000683</td>
      <td>-0.001825</td>
      <td>0.000454</td>
      <td>-0.001445</td>
      <td>0.003970</td>
      <td>SQGXB9559U</td>
      <td>-0.760522</td>
      <td>-0.671515</td>
      <td>-0.089007</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.001492</td>
      <td>-0.015246</td>
      <td>0.002635</td>
      <td>0.0</td>
      <td>-0.000272</td>
      <td>0.001399</td>
      <td>0.002737</td>
      <td>-0.007848</td>
      <td>-0.000605</td>
      <td>-0.002614</td>
      <td>...</td>
      <td>0.000135</td>
      <td>0.000262</td>
      <td>-0.000928</td>
      <td>0.001229</td>
      <td>-0.001506</td>
      <td>0.003792</td>
      <td>LFPMM4706C</td>
      <td>-1.204099</td>
      <td>-1.084834</td>
      <td>-0.119265</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.001255</td>
      <td>0.002451</td>
      <td>0.002644</td>
      <td>0.0</td>
      <td>-0.001359</td>
      <td>0.000008</td>
      <td>0.003055</td>
      <td>-0.003141</td>
      <td>-0.000131</td>
      <td>-0.002352</td>
      <td>...</td>
      <td>0.000705</td>
      <td>0.000683</td>
      <td>-0.003016</td>
      <td>0.003507</td>
      <td>-0.000939</td>
      <td>0.002133</td>
      <td>MHMYL4920B</td>
      <td>0.684426</td>
      <td>0.737010</td>
      <td>-0.052583</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.006129</td>
      <td>-0.004731</td>
      <td>0.002644</td>
      <td>0.0</td>
      <td>-0.001359</td>
      <td>0.000302</td>
      <td>0.002677</td>
      <td>-0.004384</td>
      <td>0.000272</td>
      <td>-0.002281</td>
      <td>...</td>
      <td>0.000892</td>
      <td>0.000010</td>
      <td>-0.001976</td>
      <td>0.001467</td>
      <td>-0.000799</td>
      <td>0.002244</td>
      <td>EQZZZ5658G</td>
      <td>-0.088429</td>
      <td>0.028813</td>
      <td>-0.117242</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 136 columns</p>
</div></div></div>
</div>
</section>
</section>
</section>
<section id="shap-interaction-values">
<h2>SHAP interaction values<a class="headerlink" href="#shap-interaction-values" title="Permalink to this headline">#</a></h2>
<p>A SHAP interaction value is returned for each pair of features (including with itself, which is known as the main effect), for each instance. The SHAP value for a feature is the sum of it’s pair-wise feature interactions.</p>
<p>We will use the shap library: <a class="reference external" href="https://shap.readthedocs.io/en/latest/index.html">https://shap.readthedocs.io/en/latest/index.html</a></p>
<p>‘Raw’ SHAP interaction values from XGBoost model are log odds ratios.</p>
<section id="get-shap-interaction-values">
<h3>Get SHAP interaction values<a class="headerlink" href="#get-shap-interaction-values" title="Permalink to this headline">#</a></h3>
<p>Use the TreeExplainer to also calculate the SHAP main effect and SHAP interaction values (the sum of which give the SHAP values for each feature)</p>
<p>Use these values to access the main effect for each of the one-hot encoded hospital features.</p>
<p>Load from pickle (saved from notebook 03b_xgb_shap_interaction_values_focus_on_ohe_hospitals.ipynb)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03b_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_interaction_array.p&#39;</span>
<span class="n">file_exists</span> <span class="o">=</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
    <span class="c1"># Load SHAP interaction</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">shap_interaction</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run notebook 03b_xgb_shap_values_focus_on_ohe_hospitals.ipynb&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 0 ns, sys: 3.6 s, total: 3.6 s
Wall time: 3.6 s
</pre></div>
</div>
</div>
</div>
<p>SHAP interaction values have a matrix of values (per pair of features) per instance.<br />
In this case, each of the 88792 instances has a 139x139 matrix of SHAP interaction values (with the SHAP main effect on the diagonal positions).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_interaction</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(88792, 141, 141)
</pre></div>
</div>
</div>
</div>
<p>Show SHAP interation matrix (with main effect on the diagonal positions) for the first instance. Notice how the SHAP interation for pairs of features are symmetrical across the diagonal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_interaction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 6.76276624e-01,  4.08733338e-02,  1.05852485e-02, ...,
         1.75262336e-04,  1.55542511e-05, -3.98763688e-04],
       [ 4.08733785e-02,  3.38386327e-01,  5.30318618e-02, ...,
         0.00000000e+00,  0.00000000e+00,  6.54254109e-07],
       [ 1.05856061e-02,  5.30319214e-02,  8.62581849e-01, ...,
         1.82669377e-04,  3.62747931e-04,  8.75864644e-05],
       ...,
       [ 1.75237656e-04,  0.00000000e+00,  1.82688236e-04, ...,
         3.14869266e-03,  0.00000000e+00,  3.90200876e-06],
       [ 1.55568123e-05,  0.00000000e+00,  3.62753868e-04, ...,
         0.00000000e+00, -1.80786219e-03,  0.00000000e+00],
       [-3.98725271e-04,  6.55651093e-07,  8.76188278e-05, ...,
         3.90200876e-06,  0.00000000e+00,  3.13467532e-03]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<section id="format-the-shap-interaction-data">
<h4>Format the SHAP interaction data<a class="headerlink" href="#format-the-shap-interaction-data" title="Permalink to this headline">#</a></h4>
<p>Features are in the same order in shap_interaction as they are in the original dataset.</p>
<p>Use this fact to extract the SHAP main effect values for the one-hot encoded hospital features. Create a dataframe containing the SHAP values: an instance per row, and a one-hot encoded hospital feature per column.</p>
<p>Also include a column containing the Stroke team that each instance attended.</p>
<p>And three further columns:</p>
<ol class="simple">
<li><p>contribution from all the hospital features</p></li>
<li><p>contribution from attending the hospital</p></li>
<li><p>contribution from not attending the rest</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hosp_shap_main_effects</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Use this index list to access the hosptial shap values (as array) in the loop below</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shap_interaction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="c1"># Get the main effect value for each of the features</span>
    <span class="n">main_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">shap_interaction</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">hosp_shap_main_effects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_effects</span><span class="p">[</span><span class="n">hospital_columns_index</span><span class="p">])</span>
    
<span class="c1"># Put in dataframe with hospital as column title</span>
<span class="n">df_hosp_shap_main_effects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hosp_shap_main_effects</span><span class="p">,</span> 
                                         <span class="n">columns</span> <span class="o">=</span> <span class="n">hospital_names</span><span class="p">)</span>

<span class="c1"># Include Stroke team that each instance attended</span>
<span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_combined</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Store the sum of the SHAP values (for all of the hospital features)</span>
<span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="s2">&quot;all_stroke_teams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">df_hosp_shap_main_effects</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Initialise list for 1) SHAP value for attended hospital 2) SHAP value for </span>
<span class="c1">#   the sum of the rest of the hospitals</span>
<span class="n">shap_me_attended_hospital</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">shap_me_not_attend_these_hospitals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each patient</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_hosp_shap_main_effects</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

    <span class="c1"># Get stroke team attended</span>
    <span class="n">stroke_team</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span>
    
    <span class="c1"># Get SHAP value for the stroke team attended</span>
    <span class="n">shap_me_attended_hospital</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">])</span>

    <span class="c1"># Calculate sum of SHAP values for the stroke teams not attend </span>
    <span class="n">sum_rest</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;all_stroke_teams&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">]</span>
    <span class="n">shap_me_not_attend_these_hospitals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_rest</span><span class="p">)</span>

<span class="c1"># Store two new columns in dataframe</span>
<span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="s2">&quot;attended_stroke_team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shap_me_attended_hospital</span>
<span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="s2">&quot;not_attended_stroke_teams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">shap_me_not_attend_these_hospitals</span><span class="p">)</span>
                   
<span class="c1"># View preview</span>
<span class="n">df_hosp_shap_main_effects</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AGNOF1041H</th>
      <th>AKCGO9726K</th>
      <th>AOBTM3098N</th>
      <th>APXEE8191H</th>
      <th>ATDID5461S</th>
      <th>BBXPQ0212O</th>
      <th>BICAW1125K</th>
      <th>BQZGT7491V</th>
      <th>BXXZS5063A</th>
      <th>CNBGF2713O</th>
      <th>...</th>
      <th>YEXCH8391J</th>
      <th>YPKYH1768F</th>
      <th>YQMZV4284N</th>
      <th>ZBVSO0975W</th>
      <th>ZHCLE1578P</th>
      <th>ZRRCV7012C</th>
      <th>Stroke team</th>
      <th>all_stroke_teams</th>
      <th>attended_stroke_team</th>
      <th>not_attended_stroke_teams</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.001171</td>
      <td>-0.007868</td>
      <td>0.002866</td>
      <td>0.0</td>
      <td>-0.000882</td>
      <td>0.001910</td>
      <td>0.002818</td>
      <td>-0.004191</td>
      <td>-0.000530</td>
      <td>-0.002555</td>
      <td>...</td>
      <td>0.000343</td>
      <td>0.000520</td>
      <td>-0.001912</td>
      <td>0.003149</td>
      <td>-0.001808</td>
      <td>0.003135</td>
      <td>TXHRP7672C</td>
      <td>-0.280340</td>
      <td>-0.187852</td>
      <td>-0.092488</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.002057</td>
      <td>-0.011158</td>
      <td>0.002381</td>
      <td>0.0</td>
      <td>-0.000742</td>
      <td>0.001681</td>
      <td>0.002762</td>
      <td>-0.003978</td>
      <td>-0.000381</td>
      <td>-0.002564</td>
      <td>...</td>
      <td>0.000422</td>
      <td>0.000520</td>
      <td>-0.001846</td>
      <td>0.002632</td>
      <td>-0.001676</td>
      <td>0.004031</td>
      <td>SQGXB9559U</td>
      <td>-0.668289</td>
      <td>-0.580359</td>
      <td>-0.087931</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.002480</td>
      <td>-0.009465</td>
      <td>0.002425</td>
      <td>0.0</td>
      <td>-0.001077</td>
      <td>0.001824</td>
      <td>0.002767</td>
      <td>-0.003166</td>
      <td>-0.000859</td>
      <td>-0.002645</td>
      <td>...</td>
      <td>0.000321</td>
      <td>0.000522</td>
      <td>-0.001428</td>
      <td>0.003050</td>
      <td>-0.001737</td>
      <td>0.004724</td>
      <td>LFPMM4706C</td>
      <td>-1.278658</td>
      <td>-1.192582</td>
      <td>-0.086076</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.002105</td>
      <td>-0.009234</td>
      <td>0.002305</td>
      <td>0.0</td>
      <td>-0.000745</td>
      <td>0.002322</td>
      <td>0.002844</td>
      <td>-0.003517</td>
      <td>-0.000385</td>
      <td>-0.002717</td>
      <td>...</td>
      <td>0.000328</td>
      <td>0.000520</td>
      <td>-0.001788</td>
      <td>0.002736</td>
      <td>-0.001850</td>
      <td>0.003941</td>
      <td>MHMYL4920B</td>
      <td>0.910882</td>
      <td>0.977001</td>
      <td>-0.066120</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000452</td>
      <td>-0.008371</td>
      <td>0.002305</td>
      <td>0.0</td>
      <td>-0.000745</td>
      <td>0.002055</td>
      <td>0.002782</td>
      <td>-0.003513</td>
      <td>-0.000565</td>
      <td>-0.002647</td>
      <td>...</td>
      <td>0.000326</td>
      <td>0.000524</td>
      <td>-0.001853</td>
      <td>0.002636</td>
      <td>-0.001710</td>
      <td>0.004052</td>
      <td>EQZZZ5658G</td>
      <td>-0.004142</td>
      <td>0.070702</td>
      <td>-0.074844</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 136 columns</p>
</div></div></div>
</div>
</section>
<section id="boxplot-all-hospitals-together">
<h4>Boxplot (all hospitals together)<a class="headerlink" href="#boxplot-all-hospitals-together" title="Permalink to this headline">#</a></h4>
<p>Analyse the range of SHAP values amd SHAP main effect values for the one-hot encoded hospital features. Show as two populations: the attended hospital, the sum of the hospitals not attended</p>
<p>To create a grouped boxplot, used code from <a class="reference external" href="https://stackoverflow.com/questions/16592222/matplotlib-group-boxplots">https://stackoverflow.com/questions/16592222/matplotlib-group-boxplots</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_box_color</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;whiskers&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;caps&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;medians&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="k">return</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Attended hospital&quot;</span><span class="p">,</span> <span class="s2">&quot;Not attend these hospitals&quot;</span><span class="p">]</span>

<span class="n">plot_data_sv</span> <span class="o">=</span> <span class="p">[</span><span class="n">shap_values_attended_hospital</span><span class="p">,</span> <span class="n">shap_values_not_attend_these_hospitals</span><span class="p">]</span>
<span class="n">bp_sv</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">plot_data_sv</span><span class="p">,</span> 
                  <span class="n">positions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_data_sv</span><span class="p">)))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> 
                  <span class="n">sym</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">set_box_color</span><span class="p">(</span><span class="n">bp_sv</span><span class="p">,</span> <span class="s1">&#39;#2C7BB6&#39;</span><span class="p">)</span>

<span class="n">plot_data_me</span> <span class="o">=</span> <span class="p">[</span><span class="n">shap_me_attended_hospital</span><span class="p">,</span> <span class="n">shap_me_not_attend_these_hospitals</span><span class="p">]</span>
<span class="n">bp_me</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">plot_data_me</span><span class="p">,</span> 
                  <span class="n">positions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_data_me</span><span class="p">)))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">+</span><span class="mf">0.4</span><span class="p">,</span> 
                  <span class="n">sym</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">set_box_color</span><span class="p">(</span><span class="n">bp_me</span><span class="p">,</span> <span class="s1">&#39;#D7191C&#39;</span><span class="p">)</span> <span class="c1"># colors are from http://colorbrewer2.org/</span>

<span class="c1"># draw temporary red and blue lines and use them to create a legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#2C7BB6&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SHAP value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#D7191C&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SHAP main effect&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The range of SHAP (values, or main effect) for the one-hot encoded &quot;</span>
         <span class="s2">&quot; hospital features</span><span class="se">\n</span><span class="s2">depending on whether attend the hospital, or not&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SHAP (values or main effect) of one-hot encoded feature&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Patient population&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_hosp_shap_value_and_main_effect_attend_vs_notattend_boxplot.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_40_0.png" src="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_40_0.png" />
</div>
</div>
</section>
<section id="boxplot-individual-hospitals">
<h4>Boxplot (individual hospitals)<a class="headerlink" href="#boxplot-individual-hospitals" title="Permalink to this headline">#</a></h4>
<p>Create a boxplot to show the range of SHAP values and SHAP main effect values for each individual one-hot encoded hospital feature.</p>
<p>Show the SHAP value as two populations: 1) the group of instances that attend the hospital [black], and 2) the group of instances that do not attend the hosptial [orange].</p>
<p>Order the hospitals in descending order of median SHAP value for the hospital the instance attended (so those that more often contribute to a yes-thrombolysis decision, through to those that most often contribute to a no-thrombolysis decision).</p>
<p>Firstly, to order the hospitals, create a dataframe containing the median SHAP main effect, and median SHAP values for each hosptial (for those instances that attended the hospital)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">shap_descriptive_stats</span><span class="p">(</span><span class="n">hospital_names</span><span class="p">,</span> <span class="n">df_hosp_shap</span><span class="p">,</span> <span class="n">prefix_text</span><span class="p">):</span>
    <span class="c1"># Create list of SHAP main effect values (one per hospital) for those instances</span>
    <span class="c1">#   that attend the hospital</span>
    <span class="n">attend_stroketeam_min</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attend_stroketeam_q1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attend_stroketeam_median</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attend_stroketeam_q3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attend_stroketeam_max</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
        <span class="n">data_stroke_team</span> <span class="o">=</span> <span class="n">df_hosp_shap</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span><span class="mi">75</span><span class="p">])</span>
        <span class="n">attend_stroketeam_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">attend_stroketeam_q1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
        <span class="n">attend_stroketeam_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
        <span class="n">attend_stroketeam_q3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span>
        <span class="n">attend_stroketeam_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># Create dataframe with six columns (hospital and descriptive stats)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hospital_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;hospital_</span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;shap_min_</span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_min</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;shap_q1_</span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_q1</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;shap_median_</span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_median</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;shap_q3_</span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_q3</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;shap_max_</span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_max</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_me</span> <span class="o">=</span> <span class="n">shap_descriptive_stats</span><span class="p">(</span><span class="n">hospital_names</span><span class="p">,</span> <span class="n">df_hosp_shap_main_effects</span><span class="p">,</span> <span class="s2">&quot;me&quot;</span><span class="p">)</span>
<span class="n">df_sv</span> <span class="o">=</span> <span class="n">shap_descriptive_stats</span><span class="p">(</span><span class="n">hospital_names</span><span class="p">,</span> <span class="n">df_hosp_shap_values</span><span class="p">,</span> <span class="s2">&quot;sv&quot;</span><span class="p">)</span>

<span class="n">df_hosp_shap_descriptive_stats</span> <span class="o">=</span> <span class="n">df_me</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_sv</span><span class="p">)</span>
<span class="n">df_hosp_shap_descriptive_stats</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hospital_sv&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_hosp_shap_descriptive_stats</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hospital_me&quot;</span><span class="p">:</span> <span class="s2">&quot;hospital&quot;</span><span class="p">},</span> 
                                      <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sort in descending SHAP main effect value order</span>
<span class="n">df_hosp_shap_descriptive_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;shap_median_me&quot;</span><span class="p">,</span> 
                                           <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                
<span class="n">df_hosp_shap_descriptive_stats</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hospital</th>
      <th>shap_min_me</th>
      <th>shap_q1_me</th>
      <th>shap_median_me</th>
      <th>shap_q3_me</th>
      <th>shap_max_me</th>
      <th>shap_min_sv</th>
      <th>shap_q1_sv</th>
      <th>shap_median_sv</th>
      <th>shap_q3_sv</th>
      <th>shap_max_sv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9</th>
      <td>CNBGF2713O</td>
      <td>1.195877</td>
      <td>1.314107</td>
      <td>1.343996</td>
      <td>1.393786</td>
      <td>1.508929</td>
      <td>0.648626</td>
      <td>1.160532</td>
      <td>1.365023</td>
      <td>1.513107</td>
      <td>1.989456</td>
    </tr>
    <tr>
      <th>25</th>
      <td>GKONI0110I</td>
      <td>0.767646</td>
      <td>1.057928</td>
      <td>1.109612</td>
      <td>1.168451</td>
      <td>1.358355</td>
      <td>0.046286</td>
      <td>0.888337</td>
      <td>1.097658</td>
      <td>1.286739</td>
      <td>1.779779</td>
    </tr>
    <tr>
      <th>65</th>
      <td>NTPQZ0829K</td>
      <td>0.797407</td>
      <td>0.978037</td>
      <td>1.001405</td>
      <td>1.050939</td>
      <td>1.206905</td>
      <td>0.209000</td>
      <td>0.763998</td>
      <td>0.941907</td>
      <td>1.126985</td>
      <td>1.599991</td>
    </tr>
    <tr>
      <th>62</th>
      <td>MHMYL4920B</td>
      <td>0.753430</td>
      <td>0.946048</td>
      <td>0.973336</td>
      <td>0.986911</td>
      <td>1.103224</td>
      <td>0.130139</td>
      <td>0.786147</td>
      <td>0.951004</td>
      <td>1.059232</td>
      <td>1.476519</td>
    </tr>
    <tr>
      <th>32</th>
      <td>HPWIF9956L</td>
      <td>0.750452</td>
      <td>0.902049</td>
      <td>0.946469</td>
      <td>1.008806</td>
      <td>1.169653</td>
      <td>0.206888</td>
      <td>0.652731</td>
      <td>0.870145</td>
      <td>1.152177</td>
      <td>1.624375</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Add admission figures to xlabel in boxplot</p>
<p>Create dataframe with admissions and thrombolysis rate per stroke team (index)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get Stroke team name, the stroke team admission numbers, and list of SHAP </span>
<span class="c1"># values for each instance that attended the stroke team</span>
<span class="n">unique_stroketeams_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">X_combined</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]))</span>
<span class="n">admissions</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;team_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">unique_stroketeams_list</span><span class="p">]</span>

<span class="n">df_stroketeam_ivt_adms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">unique_stroketeams_list</span><span class="p">,</span> 
                                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span>
<span class="n">df_stroketeam_ivt_adms</span><span class="p">[</span><span class="s2">&quot;Admissions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">admissions</span>
<span class="n">df_stroketeam_ivt_adms</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_stroketeam_ivt_adms</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Admissions&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Calculate IVT rate per hosptial</span>
<span class="n">hosp_ivt_rate</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s2">&quot;Thrombolysis&quot;</span><span class="p">]</span>

<span class="c1"># Join IVT rate with admissions per hosptial</span>
<span class="n">df_stroketeam_ivt_adms</span> <span class="o">=</span> <span class="n">df_stroketeam_ivt_adms</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hosp_ivt_rate</span><span class="p">)</span>

<span class="n">df_stroketeam_ivt_adms</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Admissions</th>
      <th>Thrombolysis</th>
    </tr>
    <tr>
      <th>Stroke team</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>JXJYG0100P</th>
      <td>120</td>
      <td>0.233333</td>
    </tr>
    <tr>
      <th>VVDIY0129H</th>
      <td>130</td>
      <td>0.192308</td>
    </tr>
    <tr>
      <th>YEXCH8391J</th>
      <td>149</td>
      <td>0.228188</td>
    </tr>
    <tr>
      <th>CNBGF2713O</th>
      <td>152</td>
      <td>0.480263</td>
    </tr>
    <tr>
      <th>XPABC1435F</th>
      <td>166</td>
      <td>0.216867</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>JINXD0311F</th>
      <td>1377</td>
      <td>0.368192</td>
    </tr>
    <tr>
      <th>AKCGO9726K</th>
      <td>1428</td>
      <td>0.369748</td>
    </tr>
    <tr>
      <th>OFKDF3720W</th>
      <td>1488</td>
      <td>0.228495</td>
    </tr>
    <tr>
      <th>FPTBM7594G</th>
      <td>1645</td>
      <td>0.321581</td>
    </tr>
    <tr>
      <th>FAJKD7118X</th>
      <td>1980</td>
      <td>0.275758</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 2 columns</p>
</div></div></div>
</div>
<p>Create data for boxplot</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Go through to order of hospital in</span>
<span class="n">hospital_order</span> <span class="o">=</span> <span class="n">df_hosp_shap_descriptive_stats</span><span class="p">[</span><span class="s2">&quot;hospital&quot;</span><span class="p">]</span>
    
<span class="c1"># Create list of SHAP main effect values (one per hospital) for instances that </span>
<span class="c1">#   attend stroke team</span>
<span class="n">me_attend_stroketeam_groups_ordered</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sv_attend_stroketeam_groups_ordered</span> <span class="o">=</span> <span class="p">[]</span>    
<span class="c1"># Create list of SHAP main effect values (one per hospital) for instances that </span>
<span class="c1">#   do not attend stroke team</span>
<span class="n">me_not_attend_stroketeam_groups_ordered</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sv_not_attend_stroketeam_groups_ordered</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Create list of labels for boxplot &quot;stroke team name (admissions)&quot;</span>
<span class="n">xlabel</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Through hospital in defined order (as determined above)</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_order</span><span class="p">:</span>
    <span class="c1"># Attend</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="n">me_attend_stroketeam_groups_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                            <span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
    <span class="n">sv_attend_stroketeam_groups_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
    <span class="c1"># Not attend</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">h</span>
    <span class="n">me_not_attend_stroketeam_groups_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                            <span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
    <span class="n">sv_not_attend_stroketeam_groups_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
    <span class="c1"># Label</span>
    <span class="n">ivt_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_stroketeam_ivt_adms</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">xlabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">df_stroketeam_ivt_adms</span><span class="p">[</span><span class="s1">&#39;Admissions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ivt_rate</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Resource for using overall y min and max of both datasets on the 4 plots so have the same range
<a class="reference external" href="https://blog.finxter.com/how-to-find-the-minimum-of-a-list-of-lists-in-python/#:~:text=With%20the%20key%20argument%20of,of%20the%20list%20of%20lists">https://blog.finxter.com/how-to-find-the-minimum-of-a-list-of-lists-in-python/#:~:text=With the key argument of,of the list of lists</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot 34 hospitals on each figure to aid visually</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shows the range of contributions to the prediction from this hospital when patients attend &quot;</span>
      <span class="s2">&quot;this hosptial&quot;</span><span class="p">)</span>

<span class="c1"># To group the hospitals into 34</span>
<span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ed</span> <span class="o">=</span> <span class="mi">34</span>
<span class="n">inc</span> <span class="o">=</span> <span class="n">ed</span>
<span class="n">max_size</span> <span class="o">=</span> <span class="n">n_hospitals</span>

<span class="c1"># Use overall y min &amp; max of both datasets on the 4 plots so have same range</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sv_attend_stroketeam_groups_ordered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">min</span><span class="p">))</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">sv_attend_stroketeam_groups_ordered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">max</span><span class="p">))</span>

<span class="c1"># Adjust min and max to accommodate some wriggle room</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">yrange</span><span class="o">/</span><span class="mi">50</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">yrange</span><span class="o">/</span><span class="mi">50</span>

<span class="c1"># Create figure with 4 subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span>

<span class="c1"># Create four subplots</span>
<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># &quot;The contribution from this hospital when patients do not attend this hosptial&quot;</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">xlabel</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">]</span><span class="c1">#hospital_order[st:ed]</span>
    
    <span class="n">pos_sv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">sv_attend_stroketeam_groups_ordered</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">])))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">-</span><span class="mf">0.4</span>
    <span class="n">bp_sv</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">sv_attend_stroketeam_groups_ordered</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span> 
                        <span class="n">positions</span><span class="o">=</span><span class="n">pos_sv</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    
    <span class="n">pos_me</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
                        <span class="n">me_attend_stroketeam_groups_ordered</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">])))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">+</span><span class="mf">0.4</span>
    <span class="n">bp_me</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">me_attend_stroketeam_groups_ordered</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span> 
                        <span class="n">positions</span><span class="o">=</span><span class="n">pos_me</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    
    <span class="c1"># colors are from http://colorbrewer2.org/</span>
    <span class="n">set_box_color</span><span class="p">(</span><span class="n">bp_me</span><span class="p">,</span> <span class="s1">&#39;#D7191C&#39;</span><span class="p">)</span> 
    <span class="n">set_box_color</span><span class="p">(</span><span class="n">bp_sv</span><span class="p">,</span> <span class="s1">&#39;#2C7BB6&#39;</span><span class="p">)</span>

    <span class="c1"># draw temporary red and blue lines and use them to create a legend</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#2C7BB6&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SHAP value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#D7191C&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SHAP main effect&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ticks</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Add line at Shap = 0</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span> 
    
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SHAP (value or main effect) of one-hot encoded feature&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Stroke team (admissions, IVT rate %)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ed</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_individual_hosp_shap_value_and_&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;main_effect_attend_vs_notattend_boxplot.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shows the range of contributions to the prediction from this hospital when patients attend this hosptial
</pre></div>
</div>
<img alt="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_50_1.png" src="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_50_1.png" />
</div>
</div>
<p>Notice that when patients do not attend the hospital the range of the SHAP values are largely centred on zero.
When patients do attend hosptial, the range of SHAP values are largely one side of zero or the other (only a minority of hospitals have their interquartile range spanning zero).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">count_hospitals_in_</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q3</span><span class="p">):</span>
    
    <span class="n">n_iqr_below_zero</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">n_iqr_spans_zero</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">*</span> <span class="n">q3</span>
    <span class="n">n_iqr_above_zero</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">n_iqr_is_zero1</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">n_iqr_is_zero2</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">n_iqr_is_zero</span> <span class="o">=</span> <span class="n">n_iqr_is_zero1</span> <span class="o">*</span> <span class="n">n_iqr_is_zero2</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">n_iqr_below_zero</span><span class="p">,</span> <span class="n">n_iqr_spans_zero</span><span class="p">,</span> <span class="n">n_iqr_above_zero</span><span class="p">,</span> <span class="n">n_iqr_is_zero</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">n_iqr_below_zero_me</span><span class="p">,</span> <span class="n">n_iqr_spans_zero_me</span><span class="p">,</span> 
 <span class="n">n_iqr_above_zero_me</span><span class="p">,</span> <span class="n">n_iqr_is_zero_me</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">count_hospitals_in_</span><span class="p">(</span><span class="n">df_hosp_shap_descriptive_stats</span><span class="p">[</span><span class="s2">&quot;shap_q1_me&quot;</span><span class="p">],</span> 
                                <span class="n">df_hosp_shap_descriptive_stats</span><span class="p">[</span><span class="s2">&quot;shap_q3_me&quot;</span><span class="p">]))</span>
<span class="p">(</span><span class="n">n_iqr_below_zero_sv</span><span class="p">,</span> <span class="n">n_iqr_spans_zero_sv</span><span class="p">,</span> 
 <span class="n">n_iqr_above_zero_sv</span><span class="p">,</span> <span class="n">n_iqr_is_zero_sv</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">count_hospitals_in_</span><span class="p">(</span><span class="n">df_hosp_shap_descriptive_stats</span><span class="p">[</span><span class="s2">&quot;shap_q1_sv&quot;</span><span class="p">],</span> 
                                <span class="n">df_hosp_shap_descriptive_stats</span><span class="p">[</span><span class="s2">&quot;shap_q3_sv&quot;</span><span class="p">]))</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number hospitals whose interquartile range is below zero. &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;Main effect: </span><span class="si">{</span><span class="n">n_iqr_below_zero_me</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span>
       <span class="sa">f</span><span class="s2">&quot; Shap values: </span><span class="si">{</span><span class="n">n_iqr_below_zero_sv</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number hospitals whose interquartile range spans zero. &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;Main effect: </span><span class="si">{</span><span class="n">n_iqr_spans_zero_me</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">. &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;Shap values: </span><span class="si">{</span><span class="n">n_iqr_spans_zero_sv</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number hospitals whose interquartile range is above zero. &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;Main effect: </span><span class="si">{</span><span class="n">n_iqr_above_zero_me</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">. &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;Shap values: </span><span class="si">{</span><span class="n">n_iqr_above_zero_sv</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number hospitals whose interquartile range is zero. &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;Main effect: </span><span class="si">{</span><span class="n">n_iqr_is_zero_me</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">. &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;Shap values: </span><span class="si">{</span><span class="n">n_iqr_is_zero_sv</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number hospitals whose interquartile range is below zero. Main effect: 68. Shap values: 58
Number hospitals whose interquartile range spans zero. Main effect: 2. Shap values: 24
Number hospitals whose interquartile range is above zero. Main effect: 58. Shap values: 46
Number hospitals whose interquartile range is zero. Main effect: 4. Shap values: 4
</pre></div>
</div>
</div>
</div>
<p>How does the SHAP value for the one-hot encoded hospital features compare to the thrombolysis rate of the hospital?</p>
<p>Create dataframe containing the hospital’s IVT rate and SHAP value (for those patients that attend the hospital).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate IVT rate per hosptial</span>
<span class="n">hosp_ivt_rate</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s2">&quot;Thrombolysis&quot;</span><span class="p">]</span>

<span class="c1"># Join IVT rate with median SHAP value per hosptial</span>
<span class="n">df_hosp_plot</span> <span class="o">=</span> <span class="n">df_hosp_shap_descriptive_stats</span><span class="p">[[</span><span class="s2">&quot;shap_median_sv&quot;</span><span class="p">,</span><span class="s2">&quot;hospital&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#df_hosp_plot.rename(columns={&#39;shap_median&#39;:&#39;shap_value_median&#39;}, inplace=True)</span>
<span class="n">df_hosp_plot</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;hospital&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_hosp_plot</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hosp_ivt_rate</span><span class="p">)</span>

<span class="c1"># Join IVT rate with median SHAP main effect per hosptial</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">df_hosp_shap_descriptive_stats</span><span class="p">[[</span><span class="s2">&quot;shap_median_me&quot;</span><span class="p">,</span><span class="s2">&quot;hospital&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#temp.rename(columns={&#39;shap_median&#39;:&#39;shap_main_effect_median&#39;}, inplace=True)</span>
<span class="n">temp</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;hospital&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_hosp_plot</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plot SHAP value for one-hot encoded hospital feature (median for those instances that attend the hospital) vs hospital IVT rate</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup data for chart</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;shap_median_me&#39;</span><span class="p">]</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;shap_median_sv&#39;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>

<span class="c1"># Fit a regression line to the x1 points</span>
<span class="n">slope1</span><span class="p">,</span> <span class="n">intercept1</span><span class="p">,</span> <span class="n">r_value1</span><span class="p">,</span> <span class="n">p_value1</span><span class="p">,</span> <span class="n">std_err1</span> <span class="o">=</span> \
    <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">r_square1</span> <span class="o">=</span> <span class="n">r_value1</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">y_pred1</span> <span class="o">=</span> <span class="n">intercept1</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">slope1</span><span class="p">)</span>

<span class="c1"># Fit a regression line to the x2 points</span>
<span class="n">slope2</span><span class="p">,</span> <span class="n">intercept2</span><span class="p">,</span> <span class="n">r_value2</span><span class="p">,</span> <span class="n">p_value2</span><span class="p">,</span> <span class="n">std_err2</span> <span class="o">=</span> \
    <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">r_square2</span> <span class="o">=</span> <span class="n">r_value2</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">y_pred2</span> <span class="o">=</span> <span class="n">intercept2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x2</span> <span class="o">*</span> <span class="n">slope2</span><span class="p">)</span>

<span class="c1"># Create scatter plot with regression line</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y_pred1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;formula: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> 
      <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept1</span><span class="p">)))</span>
<span class="n">text1</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SHAP main effect results (blue)</span><span class="se">\n</span><span class="s1">R squared: </span><span class="si">{</span><span class="n">r_square1</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">p: &#39;</span>
         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p_value1</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">formula: </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">text1</span><span class="p">,</span> 
         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y_pred2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">f2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;formula: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> 
      <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept2</span><span class="p">)))</span>
<span class="n">text2</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SHAP value results (orange)</span><span class="se">\n</span><span class="s1">R squared: </span><span class="si">{</span><span class="n">r_square2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">p: &#39;</span>
         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p_value2</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">formula: </span><span class="si">{</span><span class="n">f2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.39</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> 
         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;SHAP (value or main effect) &quot;</span>
              <span class="s2">&quot;[median of the instances that attend the hospital]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SHAP (value or main effect) for one-hot encoded hospital feature &quot;</span>
             <span class="s2">&quot;vs IVT rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_attended_hosp_shap_value_and_main_effect_vs_ivt_rate.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_57_0.png" src="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_57_0.png" />
</div>
</div>
<p>Plot full SHAP effect only</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup data for chart</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;shap_median_me&#39;</span><span class="p">]</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;shap_median_sv&#39;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>

<span class="c1"># Fit a regression line to the x2 points</span>
<span class="n">slope2</span><span class="p">,</span> <span class="n">intercept2</span><span class="p">,</span> <span class="n">r_value2</span><span class="p">,</span> <span class="n">p_value2</span><span class="p">,</span> <span class="n">std_err2</span> <span class="o">=</span> \
    <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">r_square2</span> <span class="o">=</span> <span class="n">r_value2</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">y_pred2</span> <span class="o">=</span> <span class="n">intercept2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x2</span> <span class="o">*</span> <span class="n">slope2</span><span class="p">)</span>

<span class="c1"># Create scatter plot with regression line</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y_pred2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;SHAP value &quot;</span>
              <span class="s2">&quot;(median of the instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="c1"># Add  text</span>

<span class="n">text2</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R squared: </span><span class="si">{</span><span class="n">r_square2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> 
         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>

<span class="c1"># Save figure</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_attended_hosp_shap_value.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_59_0.png" src="../_images/03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals_59_0.png" />
</div>
</div>
</section>
</section>
<section id="id1">
<h3>Observations<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Both of the SHAP values and SHAP main effect values for the one-hot encoded hospital features are very dependent on whether the instance attended the hospital or not</p></li>
<li><p>For the instances that attend a hospital, the SHAP main effect values are a narrower range than the equivalent SHAP values (due to the SHAP values being made up of the main effect and the pair-wise feature interactions).</p></li>
<li><p>56% of the variability in hospital thrombolysis rate can be explained by the SHAP main effect value for the one-hot encoded hospital feature (the median of those instances that attend the hospital).</p></li>
<li><p>58% of the variability in hospital thrombolysis rate can be explained by the SHAP main effect value for the one-hot encoded hospital feature (the median of those instances that attend the hospital).</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./xgb_10_features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="03_xgb_combined_shap_key_features.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Explaining XGBoost model predictions with SHAP values</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="12a_xgb_shap_interactions.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Describing model predictions, using SHAP values and SHAP interactions</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Kerry Pearn & Michael Allen<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>