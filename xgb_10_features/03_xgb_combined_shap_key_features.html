
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Explaining XGBoost model predictions with SHAP values &#8212; Using explainable machine learning to understand variation in thrombolysis practice</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="A comparison of 10k cohort thrombolysis rates across hospitals, and comparison with hospital SHAP values" href="04_compare_10k_cohort_key_features.html" />
    <link rel="prev" title="An anlysis of the characteristics of the most thrombolysable patient at each hopsital" href="02a_xgb_combined_fit_most_thrombolysable_patients.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Using explainable machine learning to understand variation in thrombolysis practice</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/intro.html">
                    SAMueL: Summary and key work
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introductory content
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/data.html">
   Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/odds_prob.html">
   Probability, odds, and SHAP values (log odds shifts)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/shap_worked_example.html">
   A simple worked example of Shap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="90_shap_interactions_on_titanic.html">
   Examining interactions between features with SHAP interactions: Using Titanic survival as an example
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Predicting thrombolysis use and explaining the predictions with Shap
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_xgb_combined_fit_feature_selection.html">
   XGBoost feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_correlation.html">
   Check correlation between features selected for the model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_xgb_combined_fit_accuracy_key_features.html">
   Measuring accuracy of XGBoost models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02a_xgb_combined_fit_most_thrombolysable_patients.html">
   An anlysis of the characteristics of the most thrombolysable patient at each hopsital
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Explaining XGBoost model predictions with SHAP values
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Comparing thrombolysis decisions between hospitals
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="04_compare_10k_cohort_key_features.html">
   A comparison of 10k cohort thrombolysis rates across hospitals, and comparison with hospital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_10k_thrombolysis_subgroups.html">
   A comparison of expected 10k cohort thrombolysis rates across hospitals: subgroup analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15a_observed_thrombolysis_subgroup_analysis.html">
   A comparison of actual thrombolysis rates across hospitals: subgroup analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_compare_benchmark_decisions_key_features.html">
   Compare local thrombolysis decisions with benchmark decisions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units.html">
   Comparing Shap values between high and low thrombolysing hospitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_plot_thrombolysis_at_high_vs_low_thrombolysing_units.html">
   Plotting thrombolysis rate by feature value for low and high thrombolysing hopsitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals.html">
   Explaining XGBoost model predictions with SHAP values: Analysis of hopsital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12a_xgb_shap_interactions.html">
   Describing model predictions, using SHAP values and SHAP interactions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12aa_xgb_shap_interactions_focus_on_onsettime.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Precise Onset Time
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12ab_xgb_shap_interactions_focus_on_severity.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Stroke Severity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12ac_xgb_shap_interactions_focus_on_disability.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with pre-stroke disability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="20_synthetic_patients.html">
   Investigating the effect of patient features by varying feature values in artificial patients
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="50_bagging_variation.html">
   Evaluating variation in model predictions and predicted 10k thrombolysis rate using bootstrap models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="91_learning_rate_optimisation.html">
   Evaluation of XGBoost learning rates on distribution of 10k thrombolysis rates
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Paper (Work In Progress)
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../paper/6_appendix.html">
   Appendix
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/xgb_10_features/03_xgb_combined_shap_key_features.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-note-on-shap-values">
   A note on SHAP values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-packages">
   Load packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-filenames">
   Set filenames
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-list-of-feature-names">
   Get list of feature names
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-xgboost-model-and-results">
   Read in XGBoost model and results
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-values">
   SHAP values
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-shap-values">
     Get SHAP values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-average-shap-values-for-each-k-fold">
     Get average SHAP values for each k-fold
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-consistency-of-shap-values-across-k-fold-splits">
     Examine consistency of SHAP values across k-fold splits
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-the-consitency-of-feature-importances-across-k-fold-splits">
     Examine the consitency of feature importances across k-fold splits
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-top-10-shap-and-feature-importance-values">
     Compare top 10 SHAP and feature importance values
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-values-in-more-detail-using-the-first-k-fold">
   SHAP values in more detail, using the first k-fold
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#view-the-global-case-beeswarm-plot">
     View the global case: Beeswarm plot
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#view-the-individual-case-waterfall-plots">
     View the individual case: Waterfall plots
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#view-the-individual-case-waterfall-plots-showing-probabilities">
     View the individual case: Waterfall plots (showing probabilities)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-the-relationship-between-feature-value-and-shap-value-for-the-top-6-influential-features">
     Show the relationship between feature value and SHAP value for the top 6 influential features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Show the relationship between feature value and SHAP value for the top 6 influential features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-shap-values-for-the-hospital-one-hot-encoded-features">
     Compare SHAP values for the hospital one-hot encoded features
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Explaining XGBoost model predictions with SHAP values</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-note-on-shap-values">
   A note on SHAP values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-packages">
   Load packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-filenames">
   Set filenames
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-list-of-feature-names">
   Get list of feature names
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-xgboost-model-and-results">
   Read in XGBoost model and results
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-values">
   SHAP values
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-shap-values">
     Get SHAP values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-average-shap-values-for-each-k-fold">
     Get average SHAP values for each k-fold
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-consistency-of-shap-values-across-k-fold-splits">
     Examine consistency of SHAP values across k-fold splits
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#examine-the-consitency-of-feature-importances-across-k-fold-splits">
     Examine the consitency of feature importances across k-fold splits
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-top-10-shap-and-feature-importance-values">
     Compare top 10 SHAP and feature importance values
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-values-in-more-detail-using-the-first-k-fold">
   SHAP values in more detail, using the first k-fold
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#view-the-global-case-beeswarm-plot">
     View the global case: Beeswarm plot
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#view-the-individual-case-waterfall-plots">
     View the individual case: Waterfall plots
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#view-the-individual-case-waterfall-plots-showing-probabilities">
     View the individual case: Waterfall plots (showing probabilities)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-the-relationship-between-feature-value-and-shap-value-for-the-top-6-influential-features">
     Show the relationship between feature value and SHAP value for the top 6 influential features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Show the relationship between feature value and SHAP value for the top 6 influential features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compare-shap-values-for-the-hospital-one-hot-encoded-features">
     Compare SHAP values for the hospital one-hot encoded features
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="explaining-xgboost-model-predictions-with-shap-values">
<h1>Explaining XGBoost model predictions with SHAP values<a class="headerlink" href="#explaining-xgboost-model-predictions-with-shap-values" title="Permalink to this headline">#</a></h1>
<section id="plain-english-summary">
<h2>Plain English summary<a class="headerlink" href="#plain-english-summary" title="Permalink to this headline">#</a></h2>
<p>Machine learning models often do not offer an easy way to determine how they have arrived at a prediction, and have been referred to as a “black box”.</p>
<p>Even with our simplified model with 10 features, the model algorithm does not report how it has arrived at a prediction. We can calculate and use SHAP values tp report the average contribution a feature has on the models outcome, across all possible combination of inputs. SHAP values are calculated externally from the model. We will use them to explore what influence each feature has on the models prediction - they can either show information for an individual instance (see which feature pulls the outcome in which direction), or for the global case for the full set of instances.</p>
<p>SHAP values care calculated for each feature (our model has 139 features since we are using one-hot encoding for hospitals), for each instance, for each of the 5 kfolds.</p>
<p>On an instance level, waterfall plots clearly show the feature contribution to the models prediction. Individual instances have their own order of feature contribution. On a global level, beeswarm and scatter plots both help to explain the relationship between feature values and model prediction.
We can learn that SHAP values rank the five most influential features as: stroke type, arrival-to-scan time, stroke severity, precise onset time, prior disability level.</p>
<p>Since we are using one-hot encoded features for the hospital, each hospital has a SHAP value of its own per instance. That means we have a SHAP value for the hospital a patient attended, as well as for hospitals that the patient did not attend. For the hospital’s own patients, the mean SHAP values range from -1.4 to 1.3. This shows that hospitals themselves have an impact on whether the patient is likely to receive thrombolysis. This can be thought of as representing the individual hospital’s thrombolysis culture.</p>
<p>The model does provide a measure of feature importance. We found that there is a reasonable similarity between the feature importance and the SHAP values, but with some differences in the ranked order. Both the SHAP values and feature importance values have good consistency across the 5 k-fold splits.</p>
</section>
<section id="a-note-on-shap-values">
<h2>A note on SHAP values<a class="headerlink" href="#a-note-on-shap-values" title="Permalink to this headline">#</a></h2>
<p>SHAP values are usually reported as <em>log odds shifts</em> in model predictions. For a description of the relationships between probability, odds, and SHAP values (log odds shifts) see <a class="reference internal" href="../introduction/odds_prob.html"><span class="doc std std-doc">here</span></a>.</p>
</section>
<section id="model-and-data">
<h2>Model and data<a class="headerlink" href="#model-and-data" title="Permalink to this headline">#</a></h2>
<p>XGBoost models were trained on stratified k-fold cross-validation data. The 8 features in the model are:</p>
<ul class="simple">
<li><p>Arrival-to-scan time: Time from arrival at hospital to scan (mins)</p></li>
<li><p>Infarction: Stroke type (1 = infarction, 0 = haemorrhage)</p></li>
<li><p>Stroke severity: Stroke severity (NIHSS) on arrival</p></li>
<li><p>Precise onset time: Onset time type (1 = precise, 0 = best estimate)</p></li>
<li><p>Prior disability level: Disability level (modified Rankin Scale) before stroke</p></li>
<li><p>Stroke team: Stroke team attended</p></li>
<li><p>Use of AF anticoagulents: Use of atrial fibrillation anticoagulant (1 = Yes, 0 = No)</p></li>
<li><p>Onset-to-arrival time: Time from onset of stroke to arrival at hospital (mins)</p></li>
<li><p>Onset during sleep: Did stroke occur in sleep?</p></li>
<li><p>Age: Age (as middle of 5 year age bands)</p></li>
</ul>
<p>And one target feature:</p>
<ul class="simple">
<li><p>Thrombolysis: Recieve thrombolysis (1 = Yes, 0 = No)</p></li>
</ul>
<p>The 10 features included in the model (to predict whether a patient will receive thrombolysis) were chosen sequentially as having the single best improvement in model performance (using the ROC AUC). The stroke team feature is included as a one-hot encoded feature.</p>
<p>The Python library SHAP was applied to each of the 5 fitted models (one per kfold) to obtain a SHAP value for each feature, for each instance. SHAP values are in the same units as the model output, so for XGBoost this is in log odds-ratio.</p>
<p>A single SHAP value per feature (to compare with the feature importance value) was obtained by taking the mean of the absolute values across all instances. Then for both cases (feature importance and SHAP) take the median across the 5 kfolds.</p>
</section>
<section id="aims">
<h2>Aims:<a class="headerlink" href="#aims" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Fit XGBoost model to each of the 5 k-fold train/test splits.</p></li>
<li><p>Get SHAP values for each k-fold split.</p></li>
<li><p>Examine consistency of SHAP values across the 5 k-fold splits.</p></li>
<li><p>Get XGBoost feature importance values for each k-fold split.</p></li>
<li><p>Examine consistency of XGBoost feature importance values across the 5 k-fold splits.</p></li>
<li><p>Compare SHAP values and XGBoost feature importance values.</p></li>
<li><p>Further investigate the relationship between feature values and SHAP values with:</p>
<ul>
<li><p>Beeswarm plots</p></li>
<li><p>Waterfall plots</p></li>
<li><p>Scatter plots</p></li>
</ul>
</li>
<li><p>Show an example of plotting SHSP values in a waterfall plot as probabilities rather than log odds-ratio.</p></li>
</ul>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>There was good consistency of SHAP values and importances across 5 k-fold replications.</p></li>
<li><p>There was a reasonable correlation between SHAP and feature importance values, but also some differences in the rank order of importance.
The five most influential features as judged by SHAP were:</p>
<ul>
<li><p>Stroke type</p></li>
<li><p>Arrival-to-scan time</p></li>
<li><p>Stroke severity (NIHSS)</p></li>
<li><p>Stroke onset time type (precise vs. estimated)</p></li>
<li><p>Disability level (Rankin) before stroke</p></li>
</ul>
</li>
<li><p>The five most influential features (excluding teams) as judged by importance were:</p>
<ul>
<li><p>Stroke type</p></li>
<li><p>Use of AF Anticoagulant</p></li>
<li><p>Onset during sleep</p></li>
<li><p>Stroke onset time type (precise vs. estimated)</p></li>
<li><p>Stroke severity (NIHSS)</p></li>
</ul>
</li>
<li><p>Beeswarm, waterfall, and scatter plots all help elucidate the relationship between feature values and SHAP value.</p></li>
<li><p>Plotting SHAP values as probabilities are more understandable than plotting as log odds-ratios, but can distort the relative importance of features overall.</p></li>
<li><p>A feature with the same value in multiple instances (such as all of the patients with an infarction), the feature (stroke type) does not necessarily have the same SHAP value in all of those instances. This means that SHAP values are instance dependent (as they are also capturing the interactions between pairs of feature values).  See the set of notebooks #12 that looks at representing the SHAP values as a main effect (what is due to the feature value, the standalone effect) and as the interactions with the other features (a value per feature pairings).</p></li>
</ul>
</section>
<section id="load-packages">
<h2>Load packages<a class="headerlink" href="#load-packages" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">shap</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="c1"># Import local package</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">waterfall</span>
<span class="c1"># Force package to be reloaded</span>
<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">waterfall</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-filenames">
<h2>Set filenames<a class="headerlink" href="#set-filenames" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set model type (used in file save, e.g. xgb_combined_calibrated_oversampled)</span>
<span class="n">number_of_features_to_use</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xgb_</span><span class="si">{</span><span class="n">number_of_features_to_use</span><span class="si">}</span><span class="s1">_features&#39;</span>
<span class="n">notebook</span> <span class="o">=</span> <span class="s1">&#39;03&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-output-folders-if-needed">
<h2>Create output folders if needed<a class="headerlink" href="#create-output-folders-if-needed" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./saved_models&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./output&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./predictions&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>   
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-json-file">
<h2>Read in JSON file<a class="headerlink" href="#read-in-json-file" title="Permalink to this headline">#</a></h2>
<p>Contains a dictionary for plain English feature names for the 10 features selected in the model. Use these as the column titles in the DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./output/01_feature_name_dict.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">dict_feature_name</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline">#</a></h2>
<p>Data has previously been split into 5 stratified k-fold splits.</p>
<p>Read in data and keep the number of key features as specified (for this notebook, that’s 8 key features)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;../data/kfold_5fold/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise empty lists</span>
<span class="n">train_data_kfold</span><span class="p">,</span> <span class="n">test_data_kfold</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="c1"># Read in the names of the selected features for the model</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./output/01_feature_selection.csv&#39;</span><span class="p">)</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])[:</span><span class="n">number_of_features_to_use</span><span class="p">]</span>
<span class="c1"># And add the target feature name: S2Thrombolysis</span>
<span class="n">key_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">)</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Read in training set, restrict to chosen features, rename titles, &amp; store</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;train_</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">key_features</span><span class="p">]</span>
    <span class="n">train</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dict_feature_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">train_data_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
    <span class="c1"># Read in test set, restrict to chosen features, rename titles, &amp; store</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;test_</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">key_features</span><span class="p">]</span>
    <span class="n">test</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dict_feature_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_data_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-list-of-feature-names">
<h2>Get list of feature names<a class="headerlink" href="#get-list-of-feature-names" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_data_kfold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-xgboost-model-and-results">
<h2>Read in XGBoost model and results<a class="headerlink" href="#read-in-xgboost-model-and-results" title="Permalink to this headline">#</a></h2>
<p>In notebook 02_xgb_combined_fit_accuracy_key_features.ipynb we fit an XGBoost model for each k-fold training/test split, and got feature importance values (a value per feature, per model from each k-fold split).</p>
<p>Load the models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up lists for k-fold fits</span>
<span class="n">model_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">feature_importance_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_pred_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_prob_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">X_train_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">X_test_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_train_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">y_test_kfold</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Get X and y</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">train_data_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_data_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">test_data_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>

    <span class="c1"># One hot encode hospitals</span>
    <span class="n">X_train_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_train_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X_test_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_test</span><span class="p">,</span> <span class="n">X_test_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Store processed X and y</span>
    <span class="n">X_train_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_train_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_test_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>

    <span class="c1"># Load models</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./saved_models/02_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
        <span class="n">model_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>        

    <span class="c1"># Get and store feature importance values</span>
    <span class="n">feature_names_ohe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_train_kfold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">feature_importances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">feature_names_ohe</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_importances</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">feature_importance_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Get and store predicted class and probability</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">y_prob_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_prob</span><span class="p">)</span>

    <span class="c1"># Measure accuracy for this k-fold model</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">==</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accuracy k-fold </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Accuracy k-fold 1: 0.848
Accuracy k-fold 2: 0.853
Accuracy k-fold 3: 0.845
Accuracy k-fold 4: 0.854
Accuracy k-fold 5: 0.848
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>141
</pre></div>
</div>
</div>
</div>
</section>
<section id="shap-values">
<h2>SHAP values<a class="headerlink" href="#shap-values" title="Permalink to this headline">#</a></h2>
<p>SHAP values give the contribution that each feature has on the models prediction, per instance. A SHAP value is returned for each feature, for each instance.</p>
<p>We will use the shap library: <a class="reference external" href="https://shap.readthedocs.io/en/latest/index.html">https://shap.readthedocs.io/en/latest/index.html</a></p>
<p>‘Raw’ SHAP values from XGBoost model are log odds ratios.
A SHAP value is returned for each feature, for each instance, for each model (one per k-fold)</p>
<section id="get-shap-values">
<h3>Get SHAP values<a class="headerlink" href="#get-shap-values" title="Permalink to this headline">#</a></h3>
<p>TreeExplainer is a fast and exact method to estimate SHAP values for tree models and ensembles of trees.
Using this we can calculate the SHAP values.</p>
<p>Either load from pickle (if file exists), or calculate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate SHAP values if required, otherwsie load previously calculated SHAP values</span>
<span class="n">calculate_shap_values</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Otherwise load SHAP values</span>

<span class="c1"># Initialise empty lists</span>
<span class="n">shap_values_extended_kfold</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">shap_values_kfold</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">calculate_shap_values</span><span class="p">:</span>
        <span class="c1"># Calculate SHAP values</span>
        
        <span class="c1"># Set up explainer using the model and feature values from training set</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">X_train_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1"># Get (and store) Shapley values along with base and feature values</span>
        <span class="n">shap_values_extended</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">X_test_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">shap_values_extended_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="p">)</span>
        <span class="c1"># Shap values exist for each classification in a Tree</span>
        <span class="c1"># We are interested in 1=give thrombolysis (not 0=not give thrombolysis)</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_values_extended</span><span class="o">.</span><span class="n">values</span>
        <span class="n">shap_values_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap_values</span><span class="p">)</span>        

        <span class="c1"># Save using pickle</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_explainer_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="n">filehandler</span><span class="p">)</span>
            

        <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_extended_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="p">,</span> <span class="n">filehandler</span><span class="p">)</span>
        
        <span class="c1"># Print progress</span>
        <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Completed </span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> of 5&#39;</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Load explainer</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_extended_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
            <span class="n">shap_values_extended</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
            <span class="n">shap_values_extended_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="p">)</span>
            <span class="n">shap_values_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 98%|===================| 17426/17759 [00:33&lt;00:00]        
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Completed 1 of 5
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 99%|===================| 17570/17759 [00:33&lt;00:00]        
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Completed 2 of 5
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 98%|===================| 17342/17758 [00:33&lt;00:00]        
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Completed 3 of 5
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 98%|===================| 17479/17758 [00:32&lt;00:00]        
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Completed 4 of 5
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 97%|=================== | 17263/17758 [00:32&lt;00:00]       
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Completed 5 of 5
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-average-shap-values-for-each-k-fold">
<h3>Get average SHAP values for each k-fold<a class="headerlink" href="#get-average-shap-values-for-each-k-fold" title="Permalink to this headline">#</a></h3>
<p>For each k-fold split, calculate the mean SHAP value for each feature (across all instances).
The mean is calculated in three ways:</p>
<ul class="simple">
<li><p>mean of raw values</p></li>
<li><p>mean of absolute values</p></li>
<li><p>absolute of mean of raw values</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise empty lists</span>
<span class="n">shap_values_mean_kfold</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Calculate mean SHAP value for each feature (across all instances)</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_values_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">feature_names_ohe</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean_shap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;abs_mean_shap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean_shap&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean_abs_shap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shap_values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean_abs_shap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span>
        <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">shap_values_mean_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="examine-consistency-of-shap-values-across-k-fold-splits">
<h3>Examine consistency of SHAP values across k-fold splits<a class="headerlink" href="#examine-consistency-of-shap-values-across-k-fold-splits" title="Permalink to this headline">#</a></h3>
<p>A model is fitted to each k-fold split, and SHAP values are obtained for each model. This next section assesses the range of SHAP values (mean |SHAP|) for each feature across the k-fold splits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise DataFrame (stores mean of the absolute SHAP values for each kfold)</span>
<span class="n">df_mean_abs_shap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># mean of the absolute SHAP values for each k-fold split</span>
    <span class="n">df_mean_abs_shap</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shap_values_mean_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;mean_abs_shap&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_abs_shap</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Arrival-to-scan time</th>
      <td>1.235386</td>
      <td>1.183838</td>
      <td>1.070147</td>
      <td>1.097156</td>
      <td>1.004764</td>
    </tr>
    <tr>
      <th>Infarction</th>
      <td>2.264395</td>
      <td>2.217960</td>
      <td>2.135242</td>
      <td>2.133385</td>
      <td>2.136224</td>
    </tr>
    <tr>
      <th>Stroke severity</th>
      <td>1.008152</td>
      <td>0.889078</td>
      <td>1.022190</td>
      <td>0.956850</td>
      <td>0.997348</td>
    </tr>
    <tr>
      <th>Precise onset time</th>
      <td>0.559713</td>
      <td>0.568196</td>
      <td>0.509191</td>
      <td>0.586817</td>
      <td>0.542354</td>
    </tr>
    <tr>
      <th>Prior disability level</th>
      <td>0.383881</td>
      <td>0.414714</td>
      <td>0.405664</td>
      <td>0.397017</td>
      <td>0.396697</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>team_YPKYH1768F</th>
      <td>0.001105</td>
      <td>0.003267</td>
      <td>0.000611</td>
      <td>0.000815</td>
      <td>0.000721</td>
    </tr>
    <tr>
      <th>team_YQMZV4284N</th>
      <td>0.001768</td>
      <td>0.002489</td>
      <td>0.002360</td>
      <td>0.001492</td>
      <td>0.001622</td>
    </tr>
    <tr>
      <th>team_ZBVSO0975W</th>
      <td>0.002655</td>
      <td>0.005890</td>
      <td>0.009275</td>
      <td>0.002379</td>
      <td>0.011138</td>
    </tr>
    <tr>
      <th>team_ZHCLE1578P</th>
      <td>0.004712</td>
      <td>0.001715</td>
      <td>0.004749</td>
      <td>0.001117</td>
      <td>0.003324</td>
    </tr>
    <tr>
      <th>team_ZRRCV7012C</th>
      <td>0.012710</td>
      <td>0.008120</td>
      <td>0.003338</td>
      <td>0.004942</td>
      <td>0.010240</td>
    </tr>
  </tbody>
</table>
<p>141 rows × 5 columns</p>
</div></div></div>
</div>
<p>Create (and show) a dataframe that stores the min, median, and max SHAP values for each feature across the 5 k-fold splits</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_abs_shap_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df_mean_abs_shap_summary</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mean_abs_shap</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_mean_abs_shap_summary</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mean_abs_shap</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="n">df_mean_abs_shap_summary</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mean_abs_shap</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_mean_abs_shap_summary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_abs_shap_summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>median</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Infarction</th>
      <td>2.133385</td>
      <td>2.136224</td>
      <td>2.264395</td>
    </tr>
    <tr>
      <th>Arrival-to-scan time</th>
      <td>1.004764</td>
      <td>1.097156</td>
      <td>1.235386</td>
    </tr>
    <tr>
      <th>Stroke severity</th>
      <td>0.889078</td>
      <td>0.997348</td>
      <td>1.022190</td>
    </tr>
    <tr>
      <th>Precise onset time</th>
      <td>0.509191</td>
      <td>0.559713</td>
      <td>0.586817</td>
    </tr>
    <tr>
      <th>Prior disability level</th>
      <td>0.383881</td>
      <td>0.397017</td>
      <td>0.414714</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>team_WSNTP4114A</th>
      <td>0.000239</td>
      <td>0.000409</td>
      <td>0.000927</td>
    </tr>
    <tr>
      <th>team_LLPWF6176Z</th>
      <td>0.000320</td>
      <td>0.000345</td>
      <td>0.001314</td>
    </tr>
    <tr>
      <th>team_CYVHC2532V</th>
      <td>0.000000</td>
      <td>0.000319</td>
      <td>0.001531</td>
    </tr>
    <tr>
      <th>team_JXJYG0100P</th>
      <td>0.000000</td>
      <td>0.000131</td>
      <td>0.000247</td>
    </tr>
    <tr>
      <th>team_QTELJ8888W</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.001561</td>
    </tr>
  </tbody>
</table>
<p>141 rows × 3 columns</p>
</div></div></div>
</div>
<p>Identify the 10 features with the highest SHAP values (in terms of the median of the kfolds of the mean of the absolute SHAP values)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_10_shap</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_mean_abs_shap_summary</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a violin plot for these 10 features with the highest SHAP values.</p>
<p>A violin plot shows the distribution of the SHAP values for each feature across the 5 kfold splits. The bars show the min, median and max values for the feature, and the shaded area around the bars show the density of the data points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">df_mean_abs_shap</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_10_shap</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
               <span class="n">showmedians</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">widths</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">top_10_shap</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|SHAP value| (log odds)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_violin.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_30_0.png" src="../_images/03_xgb_combined_shap_key_features_30_0.png" />
</div>
</div>
</section>
<section id="examine-the-consitency-of-feature-importances-across-k-fold-splits">
<h3>Examine the consitency of feature importances across k-fold splits<a class="headerlink" href="#examine-the-consitency-of-feature-importances-across-k-fold-splits" title="Permalink to this headline">#</a></h3>
<p>XGBoost algorithm provides a metrc per feature called “feature importance”.</p>
<p>A model is fitted to each k-fold split, and feature importance values are obtained for each model. This next section assesses the range of feature importance values for each feature across the k-fold splits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise DataFrame (stores feature importance values for each kfold)</span>
<span class="n">df_feature_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="c1"># For each k-fold</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># feature importance value for each k-fold split</span>
    <span class="n">df_feature_importance</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_importance_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Create (and show) a dataframe that stores the min, median, and max feature importance value for each feature across the 5 k-fold splits</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_feature_importance_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df_feature_importance_summary</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_feature_importance</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_feature_importance_summary</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_feature_importance</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="n">df_feature_importance_summary</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_feature_importance</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_feature_importance_summary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                          <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_feature_importance_summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>median</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Infarction</th>
      <td>0.329892</td>
      <td>0.342228</td>
      <td>0.344690</td>
    </tr>
    <tr>
      <th>Use of AF anticoagulants</th>
      <td>0.040316</td>
      <td>0.043855</td>
      <td>0.060380</td>
    </tr>
    <tr>
      <th>Onset during sleep</th>
      <td>0.030445</td>
      <td>0.034854</td>
      <td>0.036365</td>
    </tr>
    <tr>
      <th>Precise onset time</th>
      <td>0.024713</td>
      <td>0.028647</td>
      <td>0.037972</td>
    </tr>
    <tr>
      <th>Stroke severity</th>
      <td>0.012850</td>
      <td>0.013282</td>
      <td>0.013868</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>team_JXJYG0100P</th>
      <td>0.000000</td>
      <td>0.001177</td>
      <td>0.002705</td>
    </tr>
    <tr>
      <th>team_UMYTD3128E</th>
      <td>0.000995</td>
      <td>0.001133</td>
      <td>0.002014</td>
    </tr>
    <tr>
      <th>team_HONZP0443O</th>
      <td>0.000000</td>
      <td>0.000870</td>
      <td>0.001818</td>
    </tr>
    <tr>
      <th>team_FWHZZ0143J</th>
      <td>0.000321</td>
      <td>0.000715</td>
      <td>0.002012</td>
    </tr>
    <tr>
      <th>team_QTELJ8888W</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.002991</td>
    </tr>
  </tbody>
</table>
<p>141 rows × 3 columns</p>
</div></div></div>
</div>
<p>Identify the 10 features with the highest feature importance values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_10_importances</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_feature_importance_summary</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Create a violin plot for these 10 features with the highest feature importance values.</p>
<p>A violin plot shows the distribution of the feature importance values for each feature across the 5 kfold splits. The bars show the min, median and max values for the feature, and the shaded area around the bars show the density of the data points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">df_feature_importance_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_10_importances</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
              <span class="n">showmedians</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">widths</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">top_10_importances</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_importance_violin.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_39_0.png" src="../_images/03_xgb_combined_shap_key_features_39_0.png" />
</div>
</div>
</section>
<section id="compare-top-10-shap-and-feature-importance-values">
<h3>Compare top 10 SHAP and feature importance values<a class="headerlink" href="#compare-top-10-shap-and-feature-importance-values" title="Permalink to this headline">#</a></h3>
<p>Compare the features (and their values) that make the top 10 when selected by either SHAP values, or feature importance values</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_compare_shap_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df_compare_shap_importance</span><span class="p">[</span><span class="s1">&#39;SHAP (feature name)&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">df_mean_abs_shap_summary</span><span class="o">.</span><span class="n">index</span>
<span class="n">df_compare_shap_importance</span><span class="p">[</span><span class="s1">&#39;SHAP (median value)&#39;</span><span class="p">]</span>  <span class="o">=</span> \
                            <span class="n">df_mean_abs_shap_summary</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">df_compare_shap_importance</span><span class="p">[</span><span class="s1">&#39;Importance (feature name)&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">df_feature_importance_summary</span><span class="o">.</span><span class="n">index</span>
<span class="n">df_compare_shap_importance</span><span class="p">[</span><span class="s1">&#39;Importance (median value)&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">df_feature_importance_summary</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">df_compare_shap_importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SHAP (feature name)</th>
      <th>SHAP (median value)</th>
      <th>Importance (feature name)</th>
      <th>Importance (median value)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Infarction</td>
      <td>2.136224</td>
      <td>Infarction</td>
      <td>0.342228</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Arrival-to-scan time</td>
      <td>1.097156</td>
      <td>Use of AF anticoagulants</td>
      <td>0.043855</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Stroke severity</td>
      <td>0.997348</td>
      <td>Onset during sleep</td>
      <td>0.034854</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Precise onset time</td>
      <td>0.559713</td>
      <td>Precise onset time</td>
      <td>0.028647</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Prior disability level</td>
      <td>0.397017</td>
      <td>Stroke severity</td>
      <td>0.013282</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Use of AF anticoagulants</td>
      <td>0.336457</td>
      <td>Prior disability level</td>
      <td>0.012378</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Onset-to-arrival time</td>
      <td>0.328596</td>
      <td>Arrival-to-scan time</td>
      <td>0.011840</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Age</td>
      <td>0.197168</td>
      <td>team_GKONI0110I</td>
      <td>0.011717</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Onset during sleep</td>
      <td>0.121804</td>
      <td>team_MHMYL4920B</td>
      <td>0.011032</td>
    </tr>
    <tr>
      <th>9</th>
      <td>team_VKKDD9172T</td>
      <td>0.034483</td>
      <td>team_XKAWN3771U</td>
      <td>0.010357</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Plot all of the features, showing feature importance vs SHAP values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_shap_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df_shap_importance</span><span class="p">[</span><span class="s1">&#39;Shap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mean_abs_shap_summary</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span>
<span class="n">df_shap_importance</span> <span class="o">=</span> <span class="n">df_shap_importance</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">df_feature_importance_summary</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_shap_importance</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;median&#39;</span><span class="p">:</span><span class="s1">&#39;Importance&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_shap_importance</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Shap&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_shap_importance</span><span class="p">[</span><span class="s1">&#39;Shap&#39;</span><span class="p">],</span>
            <span class="n">df_shap_importance</span><span class="p">[</span><span class="s1">&#39;Importance&#39;</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;SHAP value (median of the k-folds [mean |Shap|])&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Importance values (median of the k-folds)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_importance_correlation.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_43_0.png" src="../_images/03_xgb_combined_shap_key_features_43_0.png" />
</div>
</div>
</section>
</section>
<section id="shap-values-in-more-detail-using-the-first-k-fold">
<h2>SHAP values in more detail, using the first k-fold<a class="headerlink" href="#shap-values-in-more-detail-using-the-first-k-fold" title="Permalink to this headline">#</a></h2>
<p>Having established that SHAP values have good consistency across k-fold splits, here we show more detail on SHAP using the first k-fold split.</p>
<p>First, get the key values from the first k fold split</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">model_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_values_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">shap_values_extended</span> <span class="o">=</span> <span class="n">shap_values_extended_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">feature_importance_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">y_prob</span> <span class="o">=</span> <span class="n">y_prob_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test_kfold</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="view-the-global-case-beeswarm-plot">
<h3>View the global case: Beeswarm plot<a class="headerlink" href="#view-the-global-case-beeswarm-plot" title="Permalink to this headline">#</a></h3>
<p>A Beeswarm plot shows data for all instances.</p>
<p>The feature value for each point is shown by the colour, and its position indicates the SHAP value for that instance.</p>
<p>Beeswarm plots are used to get a global picture of how the feature value interacts with it’s SHAP value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="o">=</span><span class="n">shap_values</span><span class="p">,</span> 
                  <span class="n">features</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
                  <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names_ohe</span><span class="p">,</span>
                  <span class="n">max_display</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                  <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;nipy_spectral&#39;</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_beeswarm.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_47_0.png" src="../_images/03_xgb_combined_shap_key_features_47_0.png" />
</div>
</div>
</section>
<section id="view-the-individual-case-waterfall-plots">
<h3>View the individual case: Waterfall plots<a class="headerlink" href="#view-the-individual-case-waterfall-plots" title="Permalink to this headline">#</a></h3>
<p>(showing log odds ratio)</p>
<p>Waterfall plots are ways of plotting the influence of features for individual cases. Here we show them for two instances: one with low, and one with high probability of receiving thrombolysis.</p>
<p>For both cases, the prediction starts at the base SHAP value (the expected value for each instance, without knowing any information of their features). This is at the bottom of the graph. Each bar shows the contribution to the prediction due to an individual feature value. Until all have added their contribution at the top of the graph. The final prediction.</p>
<p>Note: A decision plot is an alternative method of showing the same data. For further information see here:
<a class="reference external" href="https://shap.readthedocs.io/en/latest/example_notebooks/api_examples/plots/decision_plot.html">https://shap.readthedocs.io/en/latest/example_notebooks/api_examples/plots/decision_plot.html</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the location of an example each where probability of giving thrombolysis</span>
<span class="c1"># is &lt;0.1 or &gt;0.9</span>
<span class="n">location_low_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_prob</span> <span class="o">&lt;</span><span class="mf">0.1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">location_high_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_prob</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>A waterfall plot example with low probability of receiving thrombolysis (showing log odds ratio).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">waterfall</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="p">[</span><span class="n">location_low_probability</span><span class="p">],</span>
                           <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_display</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">y_reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_waterfall_logodds_low.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_51_0.png" src="../_images/03_xgb_combined_shap_key_features_51_0.png" />
</div>
</div>
<p>An waterfall plot example with high probability of receiving thrombolysis (showing log odds ratio).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">waterfall</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="p">[</span><span class="n">location_high_probability</span><span class="p">],</span>
                           <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_display</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">y_reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_waterfall_logodds_high.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_53_0.png" src="../_images/03_xgb_combined_shap_key_features_53_0.png" />
</div>
</div>
</section>
<section id="view-the-individual-case-waterfall-plots-showing-probabilities">
<h3>View the individual case: Waterfall plots (showing probabilities)<a class="headerlink" href="#view-the-individual-case-waterfall-plots-showing-probabilities" title="Permalink to this headline">#</a></h3>
<p>Though SHAP values for XGBoost most accurately describe the effect on log odds ratio of classification, it may be easier for people to understand influence of features using probabilities. Here we plot the same waterfall plots using probabilities.</p>
<p>A disadvantage of this method is that it distorts the influence of features somewhat - those features pushing the probability down from a low level to an even lower level get ‘squashed’ in apparent importance. This distortion is avoided when plotting log odds ratio, but at the cost of using an output that is poorly understandable by many.</p>
<p>Here we show the same two instances, with probability rather than log odds ratio.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate SHAP as probabilities if not previously calculated, otherwise load SHAP values</span>
<span class="n">calculate_shap_values_probability</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">calculate_shap_values_probability</span><span class="p">:</span>
    <span class="c1"># Calculate SHAP values</span>
    <span class="c1"># Set up explainer using typical feature values from training set</span>
    <span class="n">explainer_probability</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> 
                                               <span class="n">model_output</span><span class="o">=</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get Shapley values along with base and features</span>
    <span class="n">shap_values_probability_extended</span> <span class="o">=</span> <span class="n">explainer_probability</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="c1"># Shap values exist for each classification in a Tree</span>
    <span class="n">shap_values_probability</span> <span class="o">=</span> <span class="n">shap_values_probability_extended</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Save using pickle</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;shap_values_probability_extended_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shap_values_probability_extended</span><span class="p">,</span> <span class="n">filehandler</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Load explainer</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_&#39;</span>
                <span class="sa">f</span><span class="s1">&#39;shap_values_probability_extended_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">shap_values_probability_extended</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
        <span class="n">shap_values_probability</span> <span class="o">=</span> <span class="n">shap_values_probability_extended</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<p>A waterfall plot example with low probability of receiving thrombolysis (showing probabilites).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">waterfall</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span>
                <span class="n">shap_values_probability_extended</span><span class="p">[</span><span class="n">location_low_probability</span><span class="p">],</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_display</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">y_reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_waterfall_probability_low.jpg&#39;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_57_0.png" src="../_images/03_xgb_combined_shap_key_features_57_0.png" />
</div>
</div>
<p>An waterfall plot example with high probability of receiving thrombolysis (showing probabilities).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">waterfall</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span>
                <span class="n">shap_values_probability_extended</span><span class="p">[</span><span class="n">location_high_probability</span><span class="p">],</span>
                <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_display</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">y_reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_waterfall_probability_high.jpg&#39;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_59_0.png" src="../_images/03_xgb_combined_shap_key_features_59_0.png" />
</div>
</div>
</section>
<section id="show-the-relationship-between-feature-value-and-shap-value-for-the-top-6-influential-features">
<h3>Show the relationship between feature value and SHAP value for the top 6 influential features<a class="headerlink" href="#show-the-relationship-between-feature-value-and-shap-value-for-the-top-6-influential-features" title="Permalink to this headline">#</a></h3>
<p>(as SHAP plots scatter)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat_to_show</span> <span class="o">=</span> <span class="n">top_10_shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feat_to_show</span><span class="p">):</span>    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="p">[:,</span> <span class="n">feat</span><span class="p">],</span> <span class="n">x_jitter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> 
                       <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Add line at Shap = 0</span>
    <span class="n">feature_values</span> <span class="o">=</span> <span class="n">shap_values_extended</span><span class="p">[:,</span> <span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>    
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SHAP value (log odds) for</span><span class="se">\n</span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
    
    <span class="c1"># Censor arrival to scan to 1200 minutes</span>
    <span class="k">if</span> <span class="n">feat</span> <span class="o">==</span> <span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1200</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_thrombolysis_shap_scatter.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_61_0.png" src="../_images/03_xgb_combined_shap_key_features_61_0.png" />
</div>
</div>
</section>
<section id="id1">
<h3>Show the relationship between feature value and SHAP value for the top 6 influential features<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>(as violin plots)</p>
<p>Resource:
<a class="reference external" href="https://towardsdatascience.com/binning-records-on-a-continuous-variable-with-pandas-cut-and-qcut-5d7c8e11d7b0">https://towardsdatascience.com/binning-records-on-a-continuous-variable-with-pandas-cut-and-qcut-5d7c8e11d7b0</a>
<a class="reference external" href="https://matplotlib.org/3.1.0/gallery/statistics/customized_violin.html">https://matplotlib.org/3.1.0/gallery/statistics/customized_violin.html</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">category_list</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ax [matplotlib axis object] = matplotlib axis object</span>
<span class="sd">    category_list [list] = used for the xtick labels (the grouping of the data)</span>
<span class="sd">    rotation [integer] = xtick label rotation</span>
<span class="sd">    feat [string] = used in the axis label, the feature that is being plotted</span>
<span class="sd">    </span>
<span class="sd">    resource: </span>
<span class="sd">    https://matplotlib.org/3.1.0/gallery/statistics/customized_violin.html</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Set the axes ranges and axes labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">category_list</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.75</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SHAP values for </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Feature values for </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat_to_show</span> <span class="o">=</span> <span class="n">top_10_shap</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="c1"># for each feature, prepare the data for the violin plot.</span>
<span class="c1"># data either already in categories, or if there&#39;s more than 50 unique values</span>
<span class="c1"># for a feature then assume it needs to be binned, and a violin for each bin</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">feat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feat_to_show</span><span class="p">):</span>    
    <span class="n">feature_data</span> <span class="o">=</span> <span class="n">shap_values_extended</span><span class="p">[:,</span> <span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">feature_shap</span> <span class="o">=</span> <span class="n">shap_values_extended</span><span class="p">[:,</span> <span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># if feature has more that 50 unique values, then assume it needs to be </span>
    <span class="c1"># binned (other assume they are unique categories)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_data</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="c1"># bin the data, create a violin per bin</span>
        
        <span class="c1"># settings for the plot</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="mi">45</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="n">feature_data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">/</span><span class="n">step</span><span class="p">))</span>
        
        <span class="c1"># create list of bin values</span>
        <span class="n">bin_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="n">step</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)]</span>
        <span class="n">bin_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="c1"># create list of bins (the unique categories)</span>
        <span class="n">category_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="n">step</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bins</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">category_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">n_bins</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="si">}</span><span class="s1">+&#39;</span><span class="p">)</span>

        <span class="c1"># bin the feature data</span>
        <span class="n">feature_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">feature_data</span><span class="p">,</span> <span class="n">bin_list</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">category_list</span><span class="p">,</span> 
                              <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># create a violin per unique value</span>
        
        <span class="c1"># settings for the plot</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span>
        
        <span class="c1"># create list of unique categories in the feature data</span>
        <span class="n">category_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_data</span><span class="p">)</span>
        <span class="n">category_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">category_list</span><span class="p">]</span>

    <span class="c1"># create a list, each entry contains the corresponsing SHAP value for that </span>
    <span class="c1"># category (or bin). A violin will represent each list.    </span>
    <span class="n">shap_per_category</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">category_list</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">feature_data</span> <span class="o">==</span> <span class="n">category</span>
        <span class="n">shap_per_category</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_shap</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

    <span class="c1"># create violin plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">shap_per_category</span><span class="p">,</span> <span class="n">showmedians</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">widths</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    
    <span class="c1"># Add line at Shap = 0</span>
    <span class="n">feature_values</span> <span class="o">=</span> <span class="n">shap_values_extended</span><span class="p">[:,</span> <span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_values</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>   

    <span class="c1"># customise the axes</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">set_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">category_list</span><span class="p">,</span> <span class="n">feat</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
    <span class="c1"># Adjust stroke severity tickmarks</span>
    <span class="k">if</span> <span class="n">feat</span> <span class="o">==</span> <span class="s1">&#39;Stroke severity&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_list</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">category_list</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>   
    
    <span class="c1"># Add title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_thrombolysis_shap_violin.jpg&#39;</span><span class="p">,</span> 
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_64_0.png" src="../_images/03_xgb_combined_shap_key_features_64_0.png" />
</div>
</div>
</section>
<section id="compare-shap-values-for-the-hospital-one-hot-encoded-features">
<h3>Compare SHAP values for the hospital one-hot encoded features<a class="headerlink" href="#compare-shap-values-for-the-hospital-one-hot-encoded-features" title="Permalink to this headline">#</a></h3>
<p>The hospital feature is one-hot encoded, so there is a SHAP value per stroke team. We will use this to create a histogram of the frequency of the SHAP value for the hospital feature (using only the first k-fold test set, and take the mean of the SHAP values for the instances for each hospital’s own patients).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up list for storing patient data and hospital SHAP</span>
<span class="n">feature_data_with_shap</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Get mean SHAP for stroke team when patient attending that stroke team</span>
<span class="n">test_stroke_team</span> <span class="o">=</span> <span class="n">test_data_kfold</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span>
<span class="n">stroke_teams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">test_stroke_team</span><span class="p">))</span>
<span class="n">stroke_teams</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">stroke_team_mean_shap</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Loop through stroke teams</span>
<span class="k">for</span> <span class="n">stroke_team</span> <span class="ow">in</span> <span class="n">stroke_teams</span><span class="p">:</span>
    <span class="c1"># Identify rows in test data that match each stroke team</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">test_stroke_team</span> <span class="o">==</span> <span class="n">stroke_team</span>
    <span class="n">stroke_team_shap_all_features</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="c1"># Get column index for stroke_team_in_shap</span>
    <span class="n">feature_name</span> <span class="o">=</span> <span class="s1">&#39;team_&#39;</span> <span class="o">+</span> <span class="n">stroke_team</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">feature_names_ohe</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>
    <span class="c1"># Get SHAP values for hospital</span>
    <span class="n">stroke_team_shap</span> <span class="o">=</span> <span class="n">stroke_team_shap_all_features</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span>
    <span class="c1"># Get mean</span>
    <span class="n">mean_shap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stroke_team_shap</span><span class="p">)</span>
    <span class="c1"># Store mean</span>
    <span class="n">stroke_team_mean_shap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_shap</span><span class="p">)</span>
    <span class="c1"># Get and store feature data and add SHAP</span>
    <span class="n">feature_data</span> <span class="o">=</span> <span class="n">test_data_kfold</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">feature_data</span><span class="p">[</span><span class="s1">&#39;Hospital_SHAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stroke_team_shap</span>
    <span class="n">feature_data_with_shap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_data</span><span class="p">)</span>

<span class="c1"># Concatenate and save feature_data_with_shap</span>
<span class="n">feature_data_with_shap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">feature_data_with_shap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">feature_data_with_shap</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
   <span class="sa">f</span><span class="s1">&#39;./predictions/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_feature_data_with_hospital_shap.csv&#39;</span><span class="p">,</span> 
    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Create and save shap mean value per hospital</span>
<span class="n">hospital_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">hospital_data</span><span class="p">[</span><span class="s2">&quot;stroke_team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stroke_teams</span>
<span class="n">hospital_data</span><span class="p">[</span><span class="s2">&quot;shap_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stroke_team_mean_shap</span>
<span class="n">hospital_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;./predictions/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_mean_shap_per_hospital_0fold.csv&#39;</span><span class="p">,</span> 
    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hospital_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stroke_team</th>
      <th>shap_mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AGNOF1041H</td>
      <td>-0.029137</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AKCGO9726K</td>
      <td>0.535615</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AOBTM3098N</td>
      <td>-0.277465</td>
    </tr>
    <tr>
      <th>3</th>
      <td>APXEE8191H</td>
      <td>-0.104798</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ATDID5461S</td>
      <td>0.232464</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>127</th>
      <td>YPKYH1768F</td>
      <td>-0.234150</td>
    </tr>
    <tr>
      <th>128</th>
      <td>YQMZV4284N</td>
      <td>0.327757</td>
    </tr>
    <tr>
      <th>129</th>
      <td>ZBVSO0975W</td>
      <td>-0.541979</td>
    </tr>
    <tr>
      <th>130</th>
      <td>ZHCLE1578P</td>
      <td>0.108360</td>
    </tr>
    <tr>
      <th>131</th>
      <td>ZRRCV7012C</td>
      <td>-0.469514</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 2 columns</p>
</div></div></div>
</div>
<p>Plot histogram of the frequency of the mean SHAP value for the instances for each hospital’s own patients (using only the first k-fold test set)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot histogram</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">stroke_team_mean_shap</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.51</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;SHAP value&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_hosp_shap_hist.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/03_xgb_combined_shap_key_features_69_0.png" src="../_images/03_xgb_combined_shap_key_features_69_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_shap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stroke_team_mean_shap</span><span class="p">)</span>
<span class="n">std_shap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">stroke_team_mean_shap</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean hospital SHAP: </span><span class="si">{</span><span class="n">mean_shap</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean hospital SHAP: </span><span class="si">{</span><span class="n">std_shap</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean hospital SHAP: -0.017
Mean hospital SHAP: 0.521
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./xgb_10_features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="02a_xgb_combined_fit_most_thrombolysable_patients.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">An anlysis of the characteristics of the most thrombolysable patient at each hopsital</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="04_compare_10k_cohort_key_features.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">A comparison of 10k cohort thrombolysis rates across hospitals, and comparison with hospital SHAP values</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Kerry Pearn & Michael Allen<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>