
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Comparing Shap values between high and low thrombolysing hospitals &#8212; Using explainable machine learning to understand variation in thrombolysis practice</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plotting thrombolysis rate by feature value for low and high thrombolysing hopsitals" href="09_plot_thrombolysis_at_high_vs_low_thrombolysing_units.html" />
    <link rel="prev" title="Compare local thrombolysis decisions with benchmark decisions" href="05_compare_benchmark_decisions_key_features.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Using explainable machine learning to understand variation in thrombolysis practice</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/intro.html">
                    SAMueL: Summary and key work
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introductory content
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/data.html">
   Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/odds_prob.html">
   Probability, odds, and SHAP values (log odds shifts)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/shap_worked_example.html">
   A simple worked example of Shap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="90_shap_interactions_on_titanic.html">
   Examining interactions between features with SHAP interactions: Using Titanic survival as an example
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Predicting thrombolysis use and explaining the predictions with Shap
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_xgb_combined_fit_feature_selection.html">
   XGBoost feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_correlation.html">
   Check correlation between features selected for the model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_xgb_combined_fit_accuracy_key_features.html">
   Measuring accuracy of XGBoost models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02a_xgb_combined_fit_most_thrombolysable_patients.html">
   An anlysis of the characteristics of the most thrombolysable patient at each hopsital
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_xgb_combined_shap_key_features.html">
   Explaining XGBoost model predictions with SHAP values
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Comparing thrombolysis decisions between hospitals
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="04_compare_10k_cohort_key_features.html">
   A comparison of 10k cohort thrombolysis rates across hospitals, and comparison with hospital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_10k_thrombolysis_subgroups.html">
   A comparison of expected 10k cohort thrombolysis rates across hospitals: subgroup analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15a_observed_thrombolysis_subgroup_analysis.html">
   A comparison of actual thrombolysis rates across hospitals: subgroup analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_compare_benchmark_decisions_key_features.html">
   Compare local thrombolysis decisions with benchmark decisions
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Comparing Shap values between high and low thrombolysing hospitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_plot_thrombolysis_at_high_vs_low_thrombolysing_units.html">
   Plotting thrombolysis rate by feature value for low and high thrombolysing hopsitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals.html">
   Explaining XGBoost model predictions with SHAP values: Analysis of hopsital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12a_xgb_shap_interactions.html">
   Describing model predictions, using SHAP values and SHAP interactions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12aa_xgb_shap_interactions_focus_on_onsettime.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Precise Onset Time
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12ab_xgb_shap_interactions_focus_on_severity.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Stroke Severity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12ac_xgb_shap_interactions_focus_on_disability.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with pre-stroke disability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="20_synthetic_patients.html">
   Investigating the effect of patient features by varying feature values in artificial patients
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="50_bagging_variation.html">
   Evaluating variation in model predictions and predicted 10k thrombolysis rate using bootstrap models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="91_learning_rate_optimisation.html">
   Evaluation of XGBoost learning rates on distribution of 10k thrombolysis rates
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Paper (Work In Progress)
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../paper/6_appendix.html">
   Appendix
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/xgb_10_features/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-note-on-shap-values">
   A note on Shap values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-filenames">
   Set filenames
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-data-on-predicted-10k-cohort-thrombolysis-use-at-each-hospital">
     Load data on predicted 10k cohort thrombolysis use at each hospital
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-shap-data-for-first-k-fold-model">
   Load SHAP data for first k-fold model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-target-feature-data-for-first-k-fold-model">
   Load target feature data for first k-fold model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare-the-datasets">
   Prepare the datasets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#boxplot-showing-the-average-shap-value-for-the-top-30-hospitals-and-the-bottom-30-hospitals">
   Boxplot showing the average SHAP value for the top 30 hospitals, and the bottom 30 hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-shap-values-for-stroke-severity-for-the-top-and-bottom-30-hospitals">
   Plot SHAP values for
   <em>
    stroke severity
   </em>
   for the top and bottom 30 hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#repeat-for-groups-with-9-hospitals">
   Repeat for groups with 9 hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-for-prior-disability">
   Plot for
   <em>
    prior disability
   </em>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-for-use-of-af-anticoagulents">
   Plot for
   <em>
    use of AF anticoagulents
   </em>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-for-arrival-to-scan-time">
   Plot for
   <em>
    arrival-to-scan time
   </em>
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Comparing Shap values between high and low thrombolysing hospitals</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-note-on-shap-values">
   A note on Shap values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-filenames">
   Set filenames
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-data-on-predicted-10k-cohort-thrombolysis-use-at-each-hospital">
     Load data on predicted 10k cohort thrombolysis use at each hospital
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-shap-data-for-first-k-fold-model">
   Load SHAP data for first k-fold model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-target-feature-data-for-first-k-fold-model">
   Load target feature data for first k-fold model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare-the-datasets">
   Prepare the datasets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#boxplot-showing-the-average-shap-value-for-the-top-30-hospitals-and-the-bottom-30-hospitals">
   Boxplot showing the average SHAP value for the top 30 hospitals, and the bottom 30 hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-shap-values-for-stroke-severity-for-the-top-and-bottom-30-hospitals">
   Plot SHAP values for
   <em>
    stroke severity
   </em>
   for the top and bottom 30 hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#repeat-for-groups-with-9-hospitals">
   Repeat for groups with 9 hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-for-prior-disability">
   Plot for
   <em>
    prior disability
   </em>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-for-use-of-af-anticoagulents">
   Plot for
   <em>
    use of AF anticoagulents
   </em>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-for-arrival-to-scan-time">
   Plot for
   <em>
    arrival-to-scan time
   </em>
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="comparing-shap-values-between-high-and-low-thrombolysing-hospitals">
<h1>Comparing Shap values between high and low thrombolysing hospitals<a class="headerlink" href="#comparing-shap-values-between-high-and-low-thrombolysing-hospitals" title="Permalink to this headline">#</a></h1>
<section id="plain-english-summary">
<h2>Plain English summary<a class="headerlink" href="#plain-english-summary" title="Permalink to this headline">#</a></h2>
<p>It has become apparent that hospitals are making different clinical decisions, and that it is not just the patient group that is accounting for the difference in thrombolysis rates between hosptials. For example, hospitals presented with the same information can make opposing decisions on whether or not to give a patient thrombolysis. We would like to pick apart what factors different hospitals are using to make their different decisions. Here we create two groups of hospitals: those that have a high propensity to thrombolyse, and those that have a low propensity to thrombolyse. By comparing the SHAP values for a specific feature between these two hospital groups shows the contribution this feature is having on their different decision of whether to give thrombolysis.</p>
<p>We see that low and high thrombolysing hosptials have the same general pattern, that a patient is more likely to recieve thromboylsis if they have a mid-level stroke severity. But it can be seen that the more cautious hospitals are even less likely to thrombolyse mild and severe strokes, are more likely to thrombolyse mid-level strokes. The wider the net for including hospitals into the two groups (9 vs 30) the less pronounced the difference.</p>
</section>
<section id="model-and-data">
<h2>Model and data<a class="headerlink" href="#model-and-data" title="Permalink to this headline">#</a></h2>
<p>The necessary data for this analysis was created in previous notebooks (that trained the models): feature data, SHAP values.</p>
<p>The XGBoost model is fitted to 10 features:</p>
<ul class="simple">
<li><p>Arrival-to-scan time: Time from arrival at hospital to scan (mins)</p></li>
<li><p>Infarction: Stroke type (1 = infarction, 0 = haemorrhage)</p></li>
<li><p>Stroke severity: Stroke severity (NIHSS) on arrival</p></li>
<li><p>Precise onset time: Onset time type (1 = precise, 0 = best estimate)</p></li>
<li><p>Prior disability level: Disability level (modified Rankin Scale) before stroke</p></li>
<li><p>Stroke team: Stroke team attended</p></li>
<li><p>Use of AF anticoagulents: Use of atrial fibrillation anticoagulant (1 = Yes, 0 = No)</p></li>
<li><p>Onset-to-arrival time: Time from onset of stroke to arrival at hospital (mins)</p></li>
<li><p>Onset during sleep: Did stroke occur in sleep?</p></li>
<li><p>Age: Age (as middle of 5 year age bands)</p></li>
</ul>
<p>And one target feature:</p>
<ul class="simple">
<li><p>Thrombolysis: Recieve thrombolysis (1 = Yes, 0 = No)</p></li>
</ul>
<p>The 8 features included in the model (to predict whether a patient will recieve thrombolysis) were chosen sequentially as having the single best improvement in model performance (using the ROC AUC). The stroke team feature is included as a one-hot encoded feature.</p>
<p>The Python library SHAP was applied to the first k-fold model to obtain a SHAP value for each feature, for each instance. SHAP values are in the same units as the model output, so for XGBoost this is in log odds-ratio.</p>
<p>A single SHAP value per feature was obtained by taking the mean of the absolute values across all instances.</p>
</section>
<section id="a-note-on-shap-values">
<h2>A note on Shap values<a class="headerlink" href="#a-note-on-shap-values" title="Permalink to this headline">#</a></h2>
<p>Shap values are usually reported as <em>log odds shifts</em> in model predictions. For a description of the relationships between probability, odds, and Shap values (log odds shifts) see <a class="reference internal" href="../introduction/odds_prob.html"><span class="doc std std-doc">here</span></a>.</p>
</section>
<section id="aims">
<h2>Aims:<a class="headerlink" href="#aims" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Identify top 30 and bottom 30 hosptials judged by the 10k cohort dataset</p></li>
<li><p>Plot SHAP values for the feature stroke severity (NIHSS) for the top and bottom hospitals</p></li>
<li><p>Represent the data for the patients that did, and did not, receive thrombolysis</p></li>
<li><p>Repeat for top and bottom 9 hospitals</p></li>
<li><p>Repeat for feature prior disability (mRS)</p></li>
</ul>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Low and high thrombolysing hosptials have the same general pattern: that a patient is more likely to recieve thromboylsis if they have a mid-level stroke severity. This is overlaid over different hospital SHAP values.</p></li>
<li><p>There is an average diffeence in hospital SHAP of 1.31 between the top and bottom 30 hospitals, and 1.98 between the top and bottom 9 hospitals. These differences are equivalent to a difference in odds of receiving thrombolysis of 3.7 and 7.2 respectiviely.</p></li>
<li><p>Lower thrombolysing hospitals have a more exagerrated effect of stroke severity, though other features such as disability before stroke, use of AF anticoagulants and arrival to scan time look similar.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">shap</span>

<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-filenames">
<h2>Set filenames<a class="headerlink" href="#set-filenames" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">number_key_features</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xgb_</span><span class="si">{</span><span class="n">number_key_features</span><span class="si">}</span><span class="s1">_features&#39;</span>
<span class="n">notebook</span> <span class="o">=</span> <span class="s1">&#39;08&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-output-folders-if-needed">
<h2>Create output folders if needed<a class="headerlink" href="#create-output-folders-if-needed" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./saved_models&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-json-file">
<h2>Read in JSON file<a class="headerlink" href="#read-in-json-file" title="Permalink to this headline">#</a></h2>
<p>Contains a dictionary for plain English feature names for the 8 features selected in the model. Use these as the column titles in the DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./output/01_feature_name_dict.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">dict_feature_name</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline">#</a></h2>
<section id="load-data-on-predicted-10k-cohort-thrombolysis-use-at-each-hospital">
<h3>Load data on predicted 10k cohort thrombolysis use at each hospital<a class="headerlink" href="#load-data-on-predicted-10k-cohort-thrombolysis-use-at-each-hospital" title="Permalink to this headline">#</a></h3>
<p>Use the hospitals thrombolysis rate on the same set of 10k patients to select the 30 hospitals with the highest thrombolysis rates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thrombolysis_by_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;./output/04_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_10k_thrombolysis_rate_by_hosp.csv&#39;</span><span class="p">,</span> 
    <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;stroke_team&#39;</span><span class="p">)</span>
<span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Thrombolysis rate</th>
    </tr>
    <tr>
      <th>stroke_team</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>VKKDD9172T</th>
      <td>0.4527</td>
    </tr>
    <tr>
      <th>GKONI0110I</th>
      <td>0.4132</td>
    </tr>
    <tr>
      <th>HPWIF9956L</th>
      <td>0.4131</td>
    </tr>
    <tr>
      <th>CNBGF2713O</th>
      <td>0.4093</td>
    </tr>
    <tr>
      <th>TPXYE0168D</th>
      <td>0.3962</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Use the hospitals thrombolysis rate on the same set of 10k patients to select the 30 hospitals with the highest thrombolysis rates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_30_hospitals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">bottom_30_hospitals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="load-shap-data-for-first-k-fold-model">
<h2>Load SHAP data for first k-fold model<a class="headerlink" href="#load-shap-data-for-first-k-fold-model" title="Permalink to this headline">#</a></h2>
<p>Use explainer to access the feature names (explainer.data_feature_names) and shap_values_extended to access the data values and SHAP values</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_extended_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
    <span class="n">shap_values_extended</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
    
<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_explainer_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.p&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-target-feature-data-for-first-k-fold-model">
<h2>Load target feature data for first k-fold model<a class="headerlink" href="#load-target-feature-data-for-first-k-fold-model" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;../data/kfold_5fold/&#39;</span>
<span class="n">feature</span> <span class="o">=</span> <span class="s1">&#39;S2Thrombolysis&#39;</span>

<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;test_0.csv&#39;</span><span class="p">)</span>
<span class="n">target_feature</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="prepare-the-datasets">
<h2>Prepare the datasets<a class="headerlink" href="#prepare-the-datasets" title="Permalink to this headline">#</a></h2>
<p>Create Dataframe containing the feature values and target value (with feature names as column titles)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_data_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">df_data_values</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">data_feature_names</span>
<span class="n">df_data_values</span> <span class="o">=</span> <span class="n">df_data_values</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_feature</span><span class="p">)</span>
<span class="n">df_data_values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
      <th>team_AGNOF1041H</th>
      <th>...</th>
      <th>team_XPABC1435F</th>
      <th>team_XQAGA4299B</th>
      <th>team_XWUBX0795L</th>
      <th>team_YEXCH8391J</th>
      <th>team_YPKYH1768F</th>
      <th>team_YQMZV4284N</th>
      <th>team_ZBVSO0975W</th>
      <th>team_ZHCLE1578P</th>
      <th>team_ZRRCV7012C</th>
      <th>S2Thrombolysis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17.0</td>
      <td>1.0</td>
      <td>14.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>186.0</td>
      <td>0.0</td>
      <td>47.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>25.0</td>
      <td>1.0</td>
      <td>6.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>71.0</td>
      <td>0.0</td>
      <td>52.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>138.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>67.0</td>
      <td>0.0</td>
      <td>42.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>21.0</td>
      <td>0.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>86.0</td>
      <td>0.0</td>
      <td>77.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8.0</td>
      <td>1.0</td>
      <td>16.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>83.0</td>
      <td>0.0</td>
      <td>77.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>17754</th>
      <td>8.0</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>105.0</td>
      <td>0.0</td>
      <td>77.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17755</th>
      <td>35.0</td>
      <td>1.0</td>
      <td>25.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>208.0</td>
      <td>0.0</td>
      <td>92.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17756</th>
      <td>80.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>236.0</td>
      <td>0.0</td>
      <td>87.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17757</th>
      <td>16.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>34.0</td>
      <td>0.0</td>
      <td>77.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>17758</th>
      <td>23.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>125.0</td>
      <td>0.0</td>
      <td>47.5</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>17759 rows Ã— 142 columns</p>
</div></div></div>
</div>
<p>Create Dataframe containing the SHAP values (with feature names as column titles)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_shap_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">shap_values_extended</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">df_shap_values</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">data_feature_names</span>
<span class="n">df_shap_values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
      <th>team_AGNOF1041H</th>
      <th>...</th>
      <th>team_XKAWN3771U</th>
      <th>team_XPABC1435F</th>
      <th>team_XQAGA4299B</th>
      <th>team_XWUBX0795L</th>
      <th>team_YEXCH8391J</th>
      <th>team_YPKYH1768F</th>
      <th>team_YQMZV4284N</th>
      <th>team_ZBVSO0975W</th>
      <th>team_ZHCLE1578P</th>
      <th>team_ZRRCV7012C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.644524</td>
      <td>1.781234</td>
      <td>1.512816</td>
      <td>0.475095</td>
      <td>0.510118</td>
      <td>0.231340</td>
      <td>0.027640</td>
      <td>0.044822</td>
      <td>0.432631</td>
      <td>0.013371</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.010519</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.000230</td>
      <td>0.011267</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.950944</td>
      <td>1.667179</td>
      <td>0.711063</td>
      <td>0.483554</td>
      <td>0.501495</td>
      <td>0.276194</td>
      <td>-0.107594</td>
      <td>0.049120</td>
      <td>0.250526</td>
      <td>-0.005134</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.010519</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.002508</td>
      <td>0.015604</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.824374</td>
      <td>1.305925</td>
      <td>-1.474893</td>
      <td>0.383569</td>
      <td>0.332808</td>
      <td>0.148269</td>
      <td>0.348699</td>
      <td>0.055192</td>
      <td>0.700821</td>
      <td>0.007675</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.006107</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.002508</td>
      <td>0.008730</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.538693</td>
      <td>-7.683888</td>
      <td>0.710589</td>
      <td>0.242471</td>
      <td>0.238568</td>
      <td>0.119916</td>
      <td>0.073929</td>
      <td>0.026681</td>
      <td>0.036322</td>
      <td>-0.005134</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.007752</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.009263</td>
      <td>0.005612</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.535579</td>
      <td>1.795330</td>
      <td>1.447147</td>
      <td>0.478955</td>
      <td>0.432387</td>
      <td>0.232291</td>
      <td>0.086951</td>
      <td>0.053770</td>
      <td>0.059884</td>
      <td>0.010152</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.007752</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.001763</td>
      <td>0.006505</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>17754</th>
      <td>1.420294</td>
      <td>1.655126</td>
      <td>0.162147</td>
      <td>0.687616</td>
      <td>0.482946</td>
      <td>0.203699</td>
      <td>0.236643</td>
      <td>0.049837</td>
      <td>0.140686</td>
      <td>0.004882</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.007752</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000538</td>
      <td>0.001721</td>
    </tr>
    <tr>
      <th>17755</th>
      <td>0.740244</td>
      <td>1.428696</td>
      <td>1.173393</td>
      <td>-0.909235</td>
      <td>-0.182740</td>
      <td>0.140341</td>
      <td>-1.109779</td>
      <td>0.060577</td>
      <td>-0.421742</td>
      <td>0.000066</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.007752</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.004750</td>
      <td>0.014527</td>
    </tr>
    <tr>
      <th>17756</th>
      <td>-0.903385</td>
      <td>1.158949</td>
      <td>-0.993160</td>
      <td>-0.604351</td>
      <td>-0.052663</td>
      <td>0.224581</td>
      <td>-2.460304</td>
      <td>0.056280</td>
      <td>-0.539638</td>
      <td>0.004968</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.012421</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.003623</td>
      <td>0.007151</td>
    </tr>
    <tr>
      <th>17757</th>
      <td>1.397310</td>
      <td>1.784579</td>
      <td>1.182772</td>
      <td>0.506637</td>
      <td>0.445145</td>
      <td>0.229859</td>
      <td>0.403365</td>
      <td>0.053431</td>
      <td>0.109485</td>
      <td>0.015127</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.007752</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.008382</td>
      <td>0.006821</td>
    </tr>
    <tr>
      <th>17758</th>
      <td>1.079568</td>
      <td>1.763534</td>
      <td>1.009296</td>
      <td>0.497217</td>
      <td>0.477123</td>
      <td>0.192039</td>
      <td>-0.033112</td>
      <td>0.044611</td>
      <td>0.360092</td>
      <td>0.004237</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.010519</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.002401</td>
      <td>0.012586</td>
    </tr>
  </tbody>
</table>
<p>17759 rows Ã— 141 columns</p>
</div></div></div>
</div>
</section>
<section id="boxplot-showing-the-average-shap-value-for-the-top-30-hospitals-and-the-bottom-30-hospitals">
<h2>Boxplot showing the average SHAP value for the top 30 hospitals, and the bottom 30 hospitals<a class="headerlink" href="#boxplot-showing-the-average-shap-value-for-the-top-30-hospitals-and-the-bottom-30-hospitals" title="Permalink to this headline">#</a></h2>
<p>For each group of hospitals (1. top 30 hospitals, and 2. bottom 30 hospitals - as defined by their IVT rate for the 10k patient cohort) show the range of average SHAP values for those instances that attend the hospital.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List of the top 30 hospital feature names</span>
<span class="n">top_30_hospital_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;team_&quot;</span> <span class="o">+</span> <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">top_30_hospitals</span><span class="p">]</span>
    
<span class="c1"># Initiate list for average SHAP values (one per top 30 hospital) for</span>
<span class="c1">#   instances that attend that stroke team</span>
<span class="n">top_30_hosp_ave</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Through top hospitals</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">top_30_hospital_names</span><span class="p">:</span>
    <span class="c1"># Calculate and store average SHAP value for each hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_data_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">top_30_hosp_ave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
<span class="c1"># Repeat for bottom 30 hosptials</span>
<span class="c1"># List of the bottom 30 hospital feature names</span>
<span class="n">bottom_30_hospital_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;team_&quot;</span> <span class="o">+</span> <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">bottom_30_hospitals</span><span class="p">]</span>

<span class="c1"># Initiate list for average SHAP values (one per bottom 30 hospital) for</span>
<span class="c1">#   instances that attend that stroke team</span>
<span class="n">bottom_30_hosp_ave</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Through bottom hospitals</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">bottom_30_hospital_names</span><span class="p">:</span>
    <span class="c1"># Calculate and store average SHAP value for each hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_data_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">bottom_30_hosp_ave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">boxplot_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_30_hosp_ave</span><span class="p">,</span>
                <span class="n">bottom_30_hosp_ave</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create figure with 1 subplot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">boxplot_data</span><span class="p">,</span>
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Top 30 hospitals&quot;</span><span class="p">,</span><span class="s2">&quot;Bottom 30 hospitals&quot;</span><span class="p">],</span>
           <span class="n">whis</span><span class="o">=</span><span class="mi">9999999</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">medianprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average SHAP value (one-hot encoded hospital feature)&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Hospital group (based on ranked IVT rate of 10k cohort)&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Range of average SHAP values for the top and bottom 30 hospitals&quot;</span><span class="p">)</span>

<span class="c1"># Add line at Shap = 0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_hosp_shap_top_30_vs_bottom_30_boxplot.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_23_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_23_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bottom_q1</span><span class="p">,</span> <span class="n">bottom_q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bottom_30_hosp_ave</span><span class="p">),</span> <span class="p">[</span><span class="mi">25</span> <span class="p">,</span><span class="mi">75</span><span class="p">])</span>
<span class="n">top_q1</span><span class="p">,</span> <span class="n">top_q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">top_30_hosp_ave</span><span class="p">),</span> <span class="p">[</span><span class="mi">25</span> <span class="p">,</span><span class="mi">75</span><span class="p">])</span>
<span class="n">mean_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">top_30_hosp_ave</span><span class="p">))</span>
<span class="n">mean_bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bottom_30_hosp_ave</span><span class="p">))</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">mean_top</span> <span class="o">-</span> <span class="n">mean_bottom</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The top 30 hospitals have (on average) SHAP values for the one-hot &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;encoded hospital feature of between </span><span class="si">{</span><span class="n">top_q1</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> to &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">top_q3</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> (interquartile range). Compared to &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bottom_q1</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">bottom_q3</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> for the &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;bottom hospitals.&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">()</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mean top and bottom SHAP values are </span><span class="si">{</span><span class="n">mean_top</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">, and </span><span class="si">{</span><span class="n">mean_bottom</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">, a difference of </span><span class="si">{</span><span class="n">diff</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The top 30 hospitals have (on average) SHAP values for the one-hot encoded hospital feature of between 0.42 to 0.84 (interquartile range). Compared to -0.95 to -0.3 for the bottom hospitals.

The mean top and bottom SHAP values are 0.67, and -0.64, a difference of 1.31.
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-shap-values-for-stroke-severity-for-the-top-and-bottom-30-hospitals">
<h2>Plot SHAP values for <em>stroke severity</em> for the top and bottom 30 hospitals<a class="headerlink" href="#plot-shap-values-for-stroke-severity-for-the-top-and-bottom-30-hospitals" title="Permalink to this headline">#</a></h2>
<p>Identify the top and bottom 30 hospitals with highest thrombolysis rates for the common set of 10k patients.
Store their stroke team name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_30_hospitals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">bottom_30_hospitals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Define the function to plot the SHAP values for stroke severity for the two hospital groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_shap_per_hospital_group</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">top_hospital_list</span><span class="p">,</span> 
                                 <span class="n">bottom_hospital_list</span><span class="p">,</span> <span class="n">data_values_df</span><span class="p">,</span> 
                                 <span class="n">shap_values_df</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
                                 <span class="n">thrombolysis_given</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If thrombolysis_given is passed (0 or 1) then use mask to split patients</span>
<span class="sd">    based on this. If not given, then -1 is flag to not split</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Calculate data for top n hospitals</span>
    <span class="n">shap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">hospital</span> <span class="ow">in</span> <span class="n">top_hospital_list</span><span class="p">:</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;team_</span><span class="si">{</span><span class="n">hospital</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#-1 is flag to not split on this value, so create a mask all 1</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">+</span> <span class="o">~</span><span class="n">mask1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># split based on thrombolysis_given</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">thrombolysis_given</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">*</span> <span class="n">mask2</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">shap_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shap&quot;</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">shap_df</span> <span class="o">=</span> <span class="n">shap_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># calculate mean per category</span>
    <span class="n">mean_by_category_top</span> <span class="o">=</span> <span class="n">shap_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Calculate data for bottom n hospitals</span>
    <span class="n">shap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">hospital</span> <span class="ow">in</span> <span class="n">bottom_hospital_list</span><span class="p">:</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;team_</span><span class="si">{</span><span class="n">hospital</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#-1 is flag to not split on this value, so create a mask all 1</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">+</span> <span class="o">~</span><span class="n">mask1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># split based on thrombolysis_given</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">thrombolysis_given</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">*</span> <span class="n">mask2</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">shap_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shap&quot;</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">shap_df</span> <span class="o">=</span> <span class="n">shap_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            
    <span class="c1"># calculate mean per category</span>
    <span class="n">mean_by_category_bottom</span> <span class="o">=</span> <span class="n">shap_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
    <span class="c1"># plot means</span>
<span class="c1">#    fig = plt.figure(figsize=(6,6))</span>
<span class="c1">#    ax1 = fig.add_subplot(111)</span>
    <span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_hospital_list</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mean_by_category_top</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">mean_by_category_top</span><span class="p">[</span><span class="s1">&#39;shap&#39;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;top </span><span class="si">{</span><span class="n">n_hospitals</span><span class="si">}</span><span class="s2"> hospitals&quot;</span><span class="p">)</span>
    <span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_hospital_list</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mean_by_category_bottom</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">mean_by_category_bottom</span><span class="p">[</span><span class="s1">&#39;shap&#39;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;bottom </span><span class="si">{</span><span class="n">n_hospitals</span><span class="si">}</span><span class="s2"> hospitals&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1"> feature value&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1"> SHAP value (mean of patients)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;(not receiving thrombolysis) &quot;</span>
    <span class="k">elif</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;(receiving thrombolysis) &quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1"> SHAP values for patients </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s1">attending a low or &#39;</span> <span class="o">+</span>
                  <span class="sa">f</span><span class="s1">&#39;high thrombolysing hospital&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.38</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plot the SHAP values for stroke severity for the two hospital groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Create the plot</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_shap_per_hospital_group</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_30_hospitals</span><span class="p">,</span> 
                                  <span class="n">bottom_30_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                                  <span class="n">df_shap_values</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_31_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_31_0.png" />
</div>
</div>
<p>Plot the SHAP values for stroke severity for the two hospital groups, split the patients by whether received thrombolysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the two patient populations for the two graphs</span>
<span class="n">thrombolysed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Create figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">subplot</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># Each each patient population (thrombolysed, and not)</span>
<span class="k">for</span> <span class="n">thrombolysis_given</span> <span class="ow">in</span> <span class="n">thrombolysed</span><span class="p">:</span>
    <span class="c1"># Create a subplot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">subplot</span><span class="p">)</span>
    <span class="c1"># Create the plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_shap_per_hospital_group</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_30_hospitals</span><span class="p">,</span> 
                                      <span class="n">bottom_30_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                                      <span class="n">df_shap_values</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                                      <span class="n">thrombolysis_given</span><span class="o">=</span><span class="n">thrombolysis_given</span><span class="p">)</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">subplot</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_33_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_33_0.png" />
</div>
</div>
<p>Plot the 30 hosptials individually</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_shap_per_hospital</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">top_hospital_list</span><span class="p">,</span> 
                           <span class="n">bottom_hospital_list</span><span class="p">,</span> <span class="n">data_values_df</span><span class="p">,</span> 
                           <span class="n">shap_values_df</span><span class="p">,</span>
                           <span class="n">thrombolysis_given</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;(not receiving thrombolysis) &quot;</span>
    <span class="k">elif</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;(receiving thrombolysis) &quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
    
    <span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bottom_hospital_list</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1"> SHAP values for patients </span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s1">attending &#39;</span> <span class="o">+</span>
                 <span class="sa">f</span><span class="s1">&#39;bottom </span><span class="si">{</span><span class="n">n_hospitals</span><span class="si">}</span><span class="s1"> thrombolysing hospital&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate data for bottom n hospitals</span>
    <span class="k">for</span> <span class="n">hospital</span> <span class="ow">in</span> <span class="n">bottom_hospital_list</span><span class="p">:</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;team_</span><span class="si">{</span><span class="n">hospital</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#-1 is flag to not split on this value, so create a mask all 1</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">+</span> <span class="o">~</span><span class="n">mask1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># split based on thrombolysis_given</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">thrombolysis_given</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">*</span> <span class="n">mask2</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">shap_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shap&quot;</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_hospital_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_hospital_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">plot_hospital_data</span><span class="p">[</span><span class="s1">&#39;shap&#39;</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">hospital</span><span class="p">)</span>
    <span class="c1">#ax.legend(loc=&#39;lower center&#39;, prop={&#39;size&#39;: 8})</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SHAP (mean of patients)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
    <span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_hospital_list</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1"> SHAP values for patients </span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s1">attending &#39;</span> <span class="o">+</span>
                 <span class="sa">f</span><span class="s1">&#39;top </span><span class="si">{</span><span class="n">n_hospitals</span><span class="si">}</span><span class="s1"> thrombolysing hospital&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate data for top n hospitals</span>
    <span class="k">for</span> <span class="n">hospital</span> <span class="ow">in</span> <span class="n">top_hospital_list</span><span class="p">:</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;team_</span><span class="si">{</span><span class="n">hospital</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">thrombolysis_given</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#-1 is flag to not split on this value, so create a mask all 1</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">+</span> <span class="o">~</span><span class="n">mask1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># split based on thrombolysis_given</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">data_values_df</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">thrombolysis_given</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">*</span> <span class="n">mask2</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">shap_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shap&quot;</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data_values_df</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plot_hospital_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_hospital_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">plot_hospital_data</span><span class="p">[</span><span class="s1">&#39;shap&#39;</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">hospital</span><span class="p">)</span>
    <span class="c1">#ax.legend(loc=&#39;lower center&#39;, prop={&#39;size&#39;: 8})</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SHAP (mean of patients)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_shap_per_hospital</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_30_hospitals</span><span class="p">,</span> 
                       <span class="n">bottom_30_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                       <span class="n">df_shap_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_36_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_36_0.png" />
</div>
</div>
<p>Plot the 30 hosptials individually, split the patients by whether received thrombolysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thrombolysed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">thrombolysis_given</span> <span class="ow">in</span> <span class="n">thrombolysed</span><span class="p">:</span>
    <span class="n">plot_shap_per_hospital</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_30_hospitals</span><span class="p">,</span> 
                           <span class="n">bottom_30_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                           <span class="n">df_shap_values</span><span class="p">,</span>
                           <span class="n">thrombolysis_given</span><span class="o">=</span><span class="n">thrombolysis_given</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_38_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_38_0.png" />
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_38_1.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_38_1.png" />
</div>
</div>
</section>
<section id="repeat-for-groups-with-9-hospitals">
<h2>Repeat for groups with 9 hospitals<a class="headerlink" href="#repeat-for-groups-with-9-hospitals" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top_9_hospitals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">bottom_9_hospitals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thrombolysis_by_hosp</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List of the top 30 hospital feature names</span>
<span class="n">top_9_hospital_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;team_&quot;</span> <span class="o">+</span> <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">top_9_hospitals</span><span class="p">]</span>
    
<span class="c1"># Initiate list for average SHAP values (one per top 9 hospital) for</span>
<span class="c1">#   instances that attend that stroke team</span>
<span class="n">top_9_hosp_ave</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Through top hospitals</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">top_9_hospital_names</span><span class="p">:</span>
    <span class="c1"># Calculate and store average SHAP value for each hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_data_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">top_9_hosp_ave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
<span class="c1"># Repeat for bottom 9 hosptials</span>
<span class="c1"># List of the bottom 9 hospital feature names</span>
<span class="n">bottom_9_hospital_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;team_&quot;</span> <span class="o">+</span> <span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">bottom_9_hospitals</span><span class="p">]</span>

<span class="c1"># Initiate list for average SHAP values (one per bottom 9 hospital) for</span>
<span class="c1">#   instances that attend that stroke team</span>
<span class="n">bottom_9_hosp_ave</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Through bottom hospitals</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">bottom_9_hospital_names</span><span class="p">:</span>
    <span class="c1"># Calculate and store average SHAP value for each hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_data_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">bottom_9_hosp_ave</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">boxplot_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_9_hosp_ave</span><span class="p">,</span> <span class="n">bottom_9_hosp_ave</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create figure with 1 subplot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">boxplot_data</span><span class="p">,</span>
           <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Top 9 hospitals&quot;</span><span class="p">,</span><span class="s2">&quot;Bottom 9 hospitals&quot;</span><span class="p">],</span>
           <span class="n">whis</span><span class="o">=</span><span class="mi">9999999</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
           <span class="n">medianprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average SHAP value (one-hot encoded hospital feature)&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Hospital group (based on ranked IVT rate of 10k cohort)&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Range of average SHAP values for the top and bottom 30 hospitals&quot;</span><span class="p">)</span>

<span class="c1"># Add line at Shap = 0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_hosp_shap_top_9_vs_bottom_9_boxplot.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_42_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_42_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bottom_q1</span><span class="p">,</span> <span class="n">bottom_q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bottom_9_hosp_ave</span><span class="p">),</span> <span class="p">[</span><span class="mi">25</span> <span class="p">,</span><span class="mi">75</span><span class="p">])</span>
<span class="n">top_q1</span><span class="p">,</span> <span class="n">top_q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">top_9_hosp_ave</span><span class="p">),</span> <span class="p">[</span><span class="mi">25</span> <span class="p">,</span><span class="mi">75</span><span class="p">])</span>
<span class="n">mean_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">top_9_hosp_ave</span><span class="p">))</span>
<span class="n">mean_bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bottom_9_hosp_ave</span><span class="p">))</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">mean_top</span> <span class="o">-</span> <span class="n">mean_bottom</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The top 9 hospitals have (on average) SHAP values for the one-hot &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;encoded hospital feature of between </span><span class="si">{</span><span class="n">top_q1</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> to &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">top_q3</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> (interquartile range). Compared to &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bottom_q1</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">bottom_q3</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> for the &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;bottom hospitals.&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">()</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mean top and bottom SHAP values are </span><span class="si">{</span><span class="n">mean_top</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">, and </span><span class="si">{</span><span class="n">mean_bottom</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">, a difference of </span><span class="si">{</span><span class="n">diff</span><span class="si">:</span><span class="s1">0.2f</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The top 9 hospitals have (on average) SHAP values for the one-hot encoded hospital feature of between 0.83 to 1.16 (interquartile range). Compared to -1.14 to -0.86 for the bottom hospitals.

The mean top and bottom SHAP values are 0.97, and -1.01, a difference of 1.98.
</pre></div>
</div>
</div>
</div>
<p>Plot the SHAP values for stroke severity for the two hospital groups.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Create the plot</span>
<span class="n">plot_shap_per_hospital_group</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_9_hospitals</span><span class="p">,</span> 
                             <span class="n">bottom_9_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                             <span class="n">df_shap_values</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/08_shap_nihss_low_high_thrombolysing_hospitals.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_45_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_45_0.png" />
</div>
</div>
<p>Plot the SHAP values for stroke severity for the two hospital groups, split the patients by whether received thrombolysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up the two patient populations for the two graphs</span>
<span class="n">thrombolysed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Create figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">subplot</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># Each each patient population (thrombolysed, and not)</span>
<span class="k">for</span> <span class="n">thrombolysis_given</span> <span class="ow">in</span> <span class="n">thrombolysed</span><span class="p">:</span>
    <span class="c1"># Create a subplot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">subplot</span><span class="p">)</span>
    <span class="c1"># Create the plot</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_shap_per_hospital_group</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_9_hospitals</span><span class="p">,</span> 
                                      <span class="n">bottom_9_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                                      <span class="n">df_shap_values</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
                                      <span class="n">thrombolysis_given</span><span class="o">=</span><span class="n">thrombolysis_given</span><span class="p">,</span>
                                      <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">)</span>
    <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">subplot</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_47_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_47_0.png" />
</div>
</div>
<p>Plot the 9 hospitals individually</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_shap_per_hospital</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_9_hospitals</span><span class="p">,</span> 
                       <span class="n">bottom_9_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                       <span class="n">df_shap_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_49_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_49_0.png" />
</div>
</div>
<p>Plot the 9 hosptials individually, split the patients by whether received thrombolysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thrombolysed</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">thrombolysis_given</span> <span class="ow">in</span> <span class="n">thrombolysed</span><span class="p">:</span>
    <span class="n">plot_shap_per_hospital</span><span class="p">(</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span> <span class="n">top_9_hospitals</span><span class="p">,</span> 
                           <span class="n">bottom_9_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                           <span class="n">df_shap_values</span><span class="p">,</span>
                           <span class="n">thrombolysis_given</span><span class="o">=</span><span class="n">thrombolysis_given</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_51_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_51_0.png" />
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_51_1.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_51_1.png" />
</div>
</div>
</section>
<section id="plot-for-prior-disability">
<h2>Plot for <em>prior disability</em><a class="headerlink" href="#plot-for-prior-disability" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Create the plot</span>
<span class="n">plot_shap_per_hospital_group</span><span class="p">(</span><span class="s1">&#39;Prior disability level&#39;</span><span class="p">,</span> <span class="n">top_9_hospitals</span><span class="p">,</span> 
                             <span class="n">bottom_9_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                             <span class="n">df_shap_values</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_53_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_53_0.png" />
</div>
</div>
</section>
<section id="plot-for-use-of-af-anticoagulents">
<h2>Plot for <em>use of AF anticoagulents</em><a class="headerlink" href="#plot-for-use-of-af-anticoagulents" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Create the plot</span>
<span class="n">plot_shap_per_hospital_group</span><span class="p">(</span><span class="s1">&#39;Use of AF anticoagulants&#39;</span><span class="p">,</span> <span class="n">top_9_hospitals</span><span class="p">,</span> 
                             <span class="n">bottom_9_hospitals</span><span class="p">,</span> <span class="n">df_data_values</span><span class="p">,</span> 
                             <span class="n">df_shap_values</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_55_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_55_0.png" />
</div>
</div>
</section>
<section id="plot-for-arrival-to-scan-time">
<h2>Plot for <em>arrival-to-scan time</em><a class="headerlink" href="#plot-for-arrival-to-scan-time" title="Permalink to this headline">#</a></h2>
<p>(limit the graph to 400 minutes)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask</span> <span class="o">=</span> <span class="n">df_data_values</span><span class="p">[</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">400</span>
<span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">df_data_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">shap_to_plot</span> <span class="o">=</span> <span class="n">df_shap_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Create the plot</span>
<span class="n">plot_shap_per_hospital_group</span><span class="p">(</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">,</span> <span class="n">top_9_hospitals</span><span class="p">,</span> 
                             <span class="n">bottom_9_hospitals</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="p">,</span> 
                             <span class="n">shap_to_plot</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_57_0.png" src="../_images/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units_57_0.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./xgb_10_features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="05_compare_benchmark_decisions_key_features.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Compare local thrombolysis decisions with benchmark decisions</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="09_plot_thrombolysis_at_high_vs_low_thrombolysing_units.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Plotting thrombolysis rate by feature value for low and high thrombolysing hopsitals</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Kerry Pearn & Michael Allen<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>