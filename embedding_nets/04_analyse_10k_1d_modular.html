
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Investigating the output of neural net embedding subnets &#8212; Applying explainable machine learning to national stroke audit data to explore variation in decisions to use thrombolysis</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Compare local thrombolysis decisions with benchmark decisions" href="05_compare_benchmark_decisions.html" />
    <link rel="prev" title="Train and save network for 10K patient subset" href="03_generate_1d_net_for_10k.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Applying explainable machine learning to national stroke audit data to explore variation in decisions to use thrombolysis</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/intro.html">
   Introduction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  XG Boost
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../xgb/outline.html">
   Outline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../xgb/01_xgb_combined_fit_accuracy.html">
   Measuring accuracy of k-fold models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../xgb/02_xgb_combined_shap.html">
   Explaining XGBoost model predictions with Shapley values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../xgb/03_compare_10k_cohort.html">
   A comparison of 10K cohort thrombolysis rates across hospitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../xgb/04_compare_benchmark_decisions.html">
   Compare local thrombolysis decisions with benchmark decisions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../xgb/05_predict_differences_between_local_and_benchmark.html">
   Predicting differences between local and benchmark decisions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Embedding neural nets
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="outline.html">
   Outline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_1d_modular_fit_k_fold.html">
   Train and save k-fold models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_1d_modular_analyse.html">
   Assess accuracy of k-fold embedding networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_generate_1d_net_for_10k.html">
   Train and save network for 10K patient subset
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Investigating the output of neural net embedding subnets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_compare_benchmark_decisions.html">
   Compare local thrombolysis decisions with
   <em>
    benchmark
   </em>
   decisions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_collate_subnet_outputs.html">
   Collate embedding subnet outputs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_fit_xgboost_to_subnet.html">
   Understanding influence of features of neural net subnet outputs
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/embedding_nets/04_analyse_10k_1d_modular.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-libraries">
   Load libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-function-to-scale-data">
   Define function to scale data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-model-outputs-for-test-data">
   Get model outputs for test data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-predictions-for-thrombolysis-use-of-10k-set-of-patients-at-each-hospital">
   Get predictions for thrombolysis use of 10k set of patients at each hospital
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparing-hospital-subnet-activation-with-actual-thrombolysis-use-and-predicted-thrombolysis-use-in-10k-set-of-patients-attending-each-hospital">
   Comparing hospital subnet activation with actual thrombolysis use and predicted thrombolysis use in 10k set of patients attending each hospital
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-hospital-subnet-output">
     Get hospital subnet output
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-actual-thrombolysis-at-hospitals-in-10k-test-set">
     Add actual thrombolysis at hospitals in 10k test set
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-relationship-between-subnet-output-and-predicted-thrombolysis-use-in-the-10k-patient-set">
     Show relationship between subnet output and predicted thrombolysis use in the 10k patient set
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#examine-clinical-subnet-output">
   Examine clinical subnet output
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-clincial-subnet-output-for-10k-patients">
     Get clincial subnet output for 10k patients
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-relationship-between-clinical-subnet-output-and-proportion-of-patients-receiving-thrombolysis">
     Show relationship between clinical subnet output and proportion of patients receiving thrombolysis
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-some-clinical-subnet-outputs-by-patient-type">
     Show some clinical subnet outputs by patient type
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-patient-subnet-output-by-stroke-type">
       Show patient_subnet_output by stroke type
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-patient-subnet-output-by-age-group">
       Show patient_subnet_output by age group
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-relationship-between-nihss-arrival-and-clinical-subnet-output">
       Show relationship between NIHSS arrival and clinical_subnet_output
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-relationship-between-modifed-rankin-scale-and-clinical-subnet-output">
       Show relationship between modifed Rankin Scale and clinical_subnet_output
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Investigating the output of neural net embedding subnets</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-libraries">
   Load libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-function-to-scale-data">
   Define function to scale data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-model-outputs-for-test-data">
   Get model outputs for test data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-predictions-for-thrombolysis-use-of-10k-set-of-patients-at-each-hospital">
   Get predictions for thrombolysis use of 10k set of patients at each hospital
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparing-hospital-subnet-activation-with-actual-thrombolysis-use-and-predicted-thrombolysis-use-in-10k-set-of-patients-attending-each-hospital">
   Comparing hospital subnet activation with actual thrombolysis use and predicted thrombolysis use in 10k set of patients attending each hospital
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-hospital-subnet-output">
     Get hospital subnet output
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-actual-thrombolysis-at-hospitals-in-10k-test-set">
     Add actual thrombolysis at hospitals in 10k test set
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-relationship-between-subnet-output-and-predicted-thrombolysis-use-in-the-10k-patient-set">
     Show relationship between subnet output and predicted thrombolysis use in the 10k patient set
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#examine-clinical-subnet-output">
   Examine clinical subnet output
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-clincial-subnet-output-for-10k-patients">
     Get clincial subnet output for 10k patients
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-relationship-between-clinical-subnet-output-and-proportion-of-patients-receiving-thrombolysis">
     Show relationship between clinical subnet output and proportion of patients receiving thrombolysis
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-some-clinical-subnet-outputs-by-patient-type">
     Show some clinical subnet outputs by patient type
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-patient-subnet-output-by-stroke-type">
       Show patient_subnet_output by stroke type
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-patient-subnet-output-by-age-group">
       Show patient_subnet_output by age group
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-relationship-between-nihss-arrival-and-clinical-subnet-output">
       Show relationship between NIHSS arrival and clinical_subnet_output
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#show-relationship-between-modifed-rankin-scale-and-clinical-subnet-output">
       Show relationship between modifed Rankin Scale and clinical_subnet_output
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="investigating-the-output-of-neural-net-embedding-subnets">
<h1>Investigating the output of neural net embedding subnets<a class="headerlink" href="#investigating-the-output-of-neural-net-embedding-subnets" title="Permalink to this headline">¶</a></h1>
<div class="section" id="aims">
<h2>Aims<a class="headerlink" href="#aims" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>To assess predicted thrombolysis in a 10K cohort of patients if that same cohort attended each of 132 hospitals.</p></li>
<li><p>To investigate the output of the hospital and clinical embedding subnets of the embedding neural network.</p></li>
<li><p>To examine the link between hospital embedding subnet output and use of thrombolysis in hospitals - both the actual thrombolysis use, and the predicted thrombolysis use of a 10k set of patients passed through all hospital models.</p></li>
<li><p>To examine the link between the patient clinical feature embedding subnet output and the use of thrombolysis, and the link between patient features and the clinical feature embedding subnet output.</p></li>
</ul>
</div>
<div class="section" id="load-libraries">
<h2>Load libraries<a class="headerlink" href="#load-libraries" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># sklearn for pre-processing</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="c1"># TensorFlow api model</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.losses</span> <span class="kn">import</span> <span class="n">binary_crossentropy</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-06-13 00:42:53.027376: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.10.1
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="define-function-to-scale-data">
<h2>Define function to scale data<a class="headerlink" href="#define-function-to-scale-data" title="Permalink to this headline">¶</a></h2>
<p>Scale input data 0-1 (MinMax scaling).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scale_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scale data 0-1 based on min and max in training set&quot;&quot;&quot;</span>
    
    <span class="c1"># Initialise a new scaling object for normalising input data</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>

    <span class="c1"># Set up the scaler just on the training set</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

    <span class="c1"># Apply the scaler to the training and test sets</span>
    <span class="n">train_sc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">test_sc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">train_sc</span><span class="p">,</span> <span class="n">test_sc</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="get-model-outputs-for-test-data">
<h2>Get model outputs for test data<a class="headerlink" href="#get-model-outputs-for-test-data" title="Permalink to this headline">¶</a></h2>
<p>Get prediction probabilities for the test 10k training set. Training data is used only to scale test set X values.</p>
<p>This prediction run is used to check model, and get accuracy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get data subgroups</span>
<span class="n">subgroups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/subnet.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s1">&#39;Item&#39;</span><span class="p">)</span>
<span class="c1"># Get list of clinical items</span>
<span class="n">clinical_subgroup</span> <span class="o">=</span> <span class="n">subgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subgroups</span><span class="p">[</span><span class="s1">&#39;Subnet&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;clinical&#39;</span><span class="p">]</span>
<span class="n">clinical_subgroup</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clinical_subgroup</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="c1"># Get list of pathway items</span>
<span class="n">pathway_subgroup</span> <span class="o">=</span> <span class="n">subgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subgroups</span><span class="p">[</span><span class="s1">&#39;Subnet&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;pathway&#39;</span><span class="p">]</span>
<span class="n">pathway_subgroup</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathway_subgroup</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="c1"># Get list of hospital items</span>
<span class="n">hospital_subgroup</span> <span class="o">=</span> <span class="n">subgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">subgroups</span><span class="p">[</span><span class="s1">&#39;Subnet&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;hospital&#39;</span><span class="p">]</span>
<span class="n">hospital_subgroup</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hospital_subgroup</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
  
<span class="c1"># Load data</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../data/10k_training_test/cohort_10000_train.csv&#39;</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../data/10k_training_test/cohort_10000_test.csv&#39;</span><span class="p">)</span>

<span class="c1"># Limit subgroups to fields present</span>
<span class="c1"># Due to improved data selection in this repository</span>
<span class="n">clinical_subgroup</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">subgroup</span> <span class="k">for</span> <span class="n">subgroup</span> <span class="ow">in</span> <span class="n">clinical_subgroup</span> <span class="k">if</span> <span class="n">subgroup</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="p">)]</span>
<span class="n">pathway_subgroup</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">subgroup</span> <span class="k">for</span> <span class="n">subgroup</span> <span class="ow">in</span> <span class="n">pathway_subgroup</span> <span class="k">if</span> <span class="n">subgroup</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="p">)]</span>

<span class="c1"># OneHot encode stroke team</span>
<span class="n">coded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">])</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">coded</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">coded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">])</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">test</span><span class="p">,</span> <span class="n">coded</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Split into X, y</span>
<span class="n">X_train_df</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="n">y_train_df</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span>
<span class="n">X_test_df</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="n">y_test_df</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> 

<span class="c1"># Split train and test data by subgroups</span>
<span class="n">X_train_patients</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="p">[</span><span class="n">clinical_subgroup</span><span class="p">]</span>
<span class="n">X_test_patients</span> <span class="o">=</span> <span class="n">X_test_df</span><span class="p">[</span><span class="n">clinical_subgroup</span><span class="p">]</span>
<span class="n">X_train_pathway</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="p">[</span><span class="n">pathway_subgroup</span><span class="p">]</span>
<span class="n">X_test_pathway</span> <span class="o">=</span> <span class="n">X_test_df</span><span class="p">[</span><span class="n">pathway_subgroup</span><span class="p">]</span>
<span class="n">X_train_hospitals</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="p">[</span><span class="n">hospital_subgroup</span><span class="p">]</span>
<span class="n">X_test_hospitals</span> <span class="o">=</span> <span class="n">X_test_df</span><span class="p">[</span><span class="n">hospital_subgroup</span><span class="p">]</span>

<span class="c1"># Convert to NumPy</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train_df</span><span class="o">.</span><span class="n">values</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test_df</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train_df</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test_df</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Scale data</span>
<span class="n">X_train_patients_sc</span><span class="p">,</span> <span class="n">X_test_patients_sc</span> <span class="o">=</span> \
    <span class="n">scale_data</span><span class="p">(</span><span class="n">X_train_patients</span><span class="p">,</span> <span class="n">X_test_patients</span><span class="p">)</span>

<span class="n">X_train_pathway_sc</span><span class="p">,</span> <span class="n">X_test_pathway_sc</span> <span class="o">=</span> \
    <span class="n">scale_data</span><span class="p">(</span><span class="n">X_train_pathway</span><span class="p">,</span> <span class="n">X_test_pathway</span><span class="p">)</span>

<span class="n">X_train_hospitals_sc</span><span class="p">,</span> <span class="n">X_test_hospitals_sc</span> <span class="o">=</span> \
    <span class="n">scale_data</span><span class="p">(</span><span class="n">X_train_hospitals</span><span class="p">,</span> <span class="n">X_test_hospitals</span><span class="p">)</span>

<span class="c1"># Load model</span>
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./saved_models/1d_for_10k/&#39;</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">10k_model.h5&#39;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="c1"># Test model</span>
<span class="n">probability</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="p">[</span><span class="n">X_test_patients_sc</span><span class="p">,</span> <span class="n">X_test_pathway_sc</span><span class="p">,</span> <span class="n">X_test_hospitals_sc</span><span class="p">])</span>
<span class="n">y_pred_test</span> <span class="o">=</span> <span class="n">probability</span> <span class="o">&gt;=</span> <span class="mf">0.5</span>
<span class="n">y_pred_test</span> <span class="o">=</span> <span class="n">y_pred_test</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">accuracy_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_pred_test</span> <span class="o">==</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-06-13 00:42:54.864907: I tensorflow/compiler/jit/xla_cpu_device.cc:41] Not creating XLA devices, tf_xla_enable_xla_devices not set
2022-06-13 00:42:54.865661: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcuda.so.1
2022-06-13 00:42:54.901500: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:54.901665: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1720] Found device 0 with properties: 
pciBusID: 0000:01:00.0 name: NVIDIA GeForce GTX 1650 Ti computeCapability: 7.5
coreClock: 1.485GHz coreCount: 16 deviceMemorySize: 3.82GiB deviceMemoryBandwidth: 178.84GiB/s
2022-06-13 00:42:54.901698: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.10.1
2022-06-13 00:42:54.903114: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcublas.so.10
2022-06-13 00:42:54.903162: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcublasLt.so.10
2022-06-13 00:42:54.904436: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcufft.so.10
2022-06-13 00:42:54.904677: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcurand.so.10
2022-06-13 00:42:54.906036: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcusolver.so.10
2022-06-13 00:42:54.906714: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcusparse.so.10
2022-06-13 00:42:54.909501: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudnn.so.7
2022-06-13 00:42:54.909615: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:54.909825: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:54.909949: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1862] Adding visible gpu devices: 0
2022-06-13 00:42:54.910264: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-06-13 00:42:54.910731: I tensorflow/compiler/jit/xla_gpu_device.cc:99] Not creating XLA devices, tf_xla_enable_xla_devices not set
2022-06-13 00:42:54.910820: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:54.910958: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1720] Found device 0 with properties: 
pciBusID: 0000:01:00.0 name: NVIDIA GeForce GTX 1650 Ti computeCapability: 7.5
coreClock: 1.485GHz coreCount: 16 deviceMemorySize: 3.82GiB deviceMemoryBandwidth: 178.84GiB/s
2022-06-13 00:42:54.910984: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.10.1
2022-06-13 00:42:54.911012: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcublas.so.10
2022-06-13 00:42:54.911032: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcublasLt.so.10
2022-06-13 00:42:54.911049: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcufft.so.10
2022-06-13 00:42:54.911067: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcurand.so.10
2022-06-13 00:42:54.911084: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcusolver.so.10
2022-06-13 00:42:54.911103: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcusparse.so.10
2022-06-13 00:42:54.911121: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudnn.so.7
2022-06-13 00:42:54.911180: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:54.911354: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:54.911473: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1862] Adding visible gpu devices: 0
2022-06-13 00:42:54.911508: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.10.1
2022-06-13 00:42:55.408857: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1261] Device interconnect StreamExecutor with strength 1 edge matrix:
2022-06-13 00:42:55.408882: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1267]      0 
2022-06-13 00:42:55.408888: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1280] 0:   N 
2022-06-13 00:42:55.409075: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:55.409300: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:55.409479: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:941] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-06-13 00:42:55.409626: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1406] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 3404 MB memory) -&gt; physical GPU (device: 0, name: NVIDIA GeForce GTX 1650 Ti, pci bus id: 0000:01:00.0, compute capability: 7.5)
2022-06-13 00:42:55.618120: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:116] None of the MLIR optimization passes are enabled (registered 2)
2022-06-13 00:42:55.635145: I tensorflow/core/platform/profile_utils/cpu_utils.cc:112] CPU Frequency: 2599990000 Hz
2022-06-13 00:42:55.760065: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcublas.so.10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accuracy test </span><span class="si">{</span><span class="n">accuracy_test</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Accuracy test 0.852
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="get-predictions-for-thrombolysis-use-of-10k-set-of-patients-at-each-hospital">
<h2>Get predictions for thrombolysis use of 10k set of patients at each hospital<a class="headerlink" href="#get-predictions-for-thrombolysis-use-of-10k-set-of-patients-at-each-hospital" title="Permalink to this headline">¶</a></h2>
<p>Here we ask the counter-factual question - “what treatment would a patient be expected to receive at each of the 132 hospitals?”.</p>
<p>Hospital is one-hot encoded as input to the hospital subnet. To make a prediction of treatment at different hospitals we change the one-hot encoding of the hospital when making prediction.</p>
<p>For each hospital we pass through the 10k test set, and record the proportion of the patients receiving thrombolysis at that hospital.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get number of hospitals</span>
<span class="n">num_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test_hospitals_sc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># Create test array for changing hospital ID</span>
<span class="n">X_hospitals_alter</span> <span class="o">=</span> <span class="n">X_test_hospitals_sc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Get classification for all patients at all hospials</span>
<span class="n">patient_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through setting hospital</span>
<span class="n">hospital_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">hosp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_hospitals</span><span class="p">):</span>
    <span class="c1"># Set all hospitals to zero</span>
    <span class="n">X_hospitals_alter</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Set test hospital to 1</span>
    <span class="n">X_hospitals_alter</span><span class="p">[:,</span><span class="n">hosp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Get probability of thrombolysis</span>
    <span class="n">probability</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="p">[</span><span class="n">X_test_patients_sc</span><span class="p">,</span> <span class="n">X_test_pathway_sc</span><span class="p">,</span> <span class="n">X_hospitals_alter</span><span class="p">])</span>
    <span class="c1"># Classify</span>
    <span class="n">classified</span> <span class="o">=</span> <span class="n">probability</span> <span class="o">&gt;=</span> <span class="mf">0.5</span>
    <span class="n">patient_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classified</span><span class="p">)</span>
    <span class="c1"># Get average thrombolysis (we are not stroring all individual results)</span>
    <span class="n">thrombolysis</span> <span class="o">=</span> <span class="n">classified</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">hospital_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thrombolysis</span><span class="p">)</span>

<span class="c1"># Put results in DataFrame </span>
<span class="n">predicted_thrombolysis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;hospital&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hospital_subgroup</span>
<span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hospital_results</span>

<span class="c1"># Show DataFrame</span>
<span class="n">predicted_thrombolysis</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hospital</th>
      <th>10k_thrombolysis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AGNOF1041H</td>
      <td>0.2840</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AKCGO9726K</td>
      <td>0.3836</td>
    </tr>
    <tr>
      <th>2</th>
      <td>AOBTM3098N</td>
      <td>0.2209</td>
    </tr>
    <tr>
      <th>3</th>
      <td>APXEE8191H</td>
      <td>0.2802</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ATDID5461S</td>
      <td>0.2501</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>127</th>
      <td>YPKYH1768F</td>
      <td>0.2457</td>
    </tr>
    <tr>
      <th>128</th>
      <td>YQMZV4284N</td>
      <td>0.3444</td>
    </tr>
    <tr>
      <th>129</th>
      <td>ZBVSO0975W</td>
      <td>0.2213</td>
    </tr>
    <tr>
      <th>130</th>
      <td>ZHCLE1578P</td>
      <td>0.3169</td>
    </tr>
    <tr>
      <th>131</th>
      <td>ZRRCV7012C</td>
      <td>0.1546</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">],</span> 
        <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/04_analyse_10k_1d_modular_10_0.png" src="../_images/04_analyse_10k_1d_modular_10_0.png" />
</div>
</div>
<p>Show stats:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">])</span>
<span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">])</span>
<span class="n">minimum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">])</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">])</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">mean</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;StDev: </span><span class="si">{</span><span class="n">stdev</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Min: </span><span class="si">{</span><span class="n">minimum</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max</span><span class="si">{</span><span class="n">maximum</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean: 0.284
StDev: 0.075
Min: 0.144
Max0.470
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="comparing-hospital-subnet-activation-with-actual-thrombolysis-use-and-predicted-thrombolysis-use-in-10k-set-of-patients-attending-each-hospital">
<h2>Comparing hospital subnet activation with actual thrombolysis use and predicted thrombolysis use in 10k set of patients attending each hospital<a class="headerlink" href="#comparing-hospital-subnet-activation-with-actual-thrombolysis-use-and-predicted-thrombolysis-use-in-10k-set-of-patients-attending-each-hospital" title="Permalink to this headline">¶</a></h2>
<p>The hospital subnet outputs a single value (in the range 0-1) for each hospital.</p>
<p>Here we compare the hospital subnet output for each hospital with:</p>
<ol class="simple">
<li><p>The actual use of thrombolysis for 10k test-set patients at their own hospital only.</p></li>
<li><p>The expected use of thrombolysis in the 10k test-set for each hospital. The 10k patient data set is passed through all hospital models (by changing the one-hot hospital encoding).</p></li>
</ol>
<div class="section" id="get-hospital-subnet-output">
<h3>Get hospital subnet output<a class="headerlink" href="#get-hospital-subnet-output" title="Permalink to this headline">¶</a></h3>
<p>This code gets the output directly from the hospital subnet in the neural network. We add this to our results DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">hosp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_hospitals</span><span class="p">):</span>
    <span class="c1"># Set all hospitals to zero</span>
    <span class="n">X_hospitals_alter</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Set test hospital to 1</span>
    <span class="n">X_hospitals_alter</span><span class="p">[:,</span><span class="n">hosp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Get hospital subnet output</span>
    <span class="n">layer_name</span> <span class="o">=</span> <span class="s1">&#39;hospital_encode&#39;</span>
    <span class="n">hospital_encode_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="n">outputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">hospital_encode_output</span> <span class="o">=</span> <span class="n">hospital_encode_model</span><span class="p">([</span>
        <span class="n">X_test_patients_sc</span><span class="p">,</span> <span class="n">X_test_pathway_sc</span><span class="p">,</span> <span class="n">X_hospitals_alter</span><span class="p">])</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hospital_encode_output</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
    
<span class="c1"># Add to DataFrame</span>
<span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;hosp_subnet_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="add-actual-thrombolysis-at-hospitals-in-10k-test-set">
<h3>Add actual thrombolysis at hospitals in 10k test set<a class="headerlink" href="#add-actual-thrombolysis-at-hospitals-in-10k-test-set" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../data/10k_training_test/cohort_10000_test.csv&#39;</span><span class="p">)</span>
<span class="n">actual_thrombolysis</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span>

<span class="c1"># Add to DataFrame</span>
<span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;actual_thrombolysis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_thrombolysis</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Sort</span>
<span class="n">predicted_thrombolysis</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Save</span>
<span class="n">predicted_thrombolysis</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="s1">&#39;./output/10k_thrombolysis_rate_by_hosp.csv&#39;</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s1">&#39;hospital&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_thrombolysis</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hospital</th>
      <th>10k_thrombolysis</th>
      <th>hosp_subnet_output</th>
      <th>actual_thrombolysis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9</th>
      <td>CNBGF2713O</td>
      <td>0.4700</td>
      <td>0.005932</td>
      <td>0.470588</td>
    </tr>
    <tr>
      <th>25</th>
      <td>GKONI0110I</td>
      <td>0.4409</td>
      <td>0.119403</td>
      <td>0.389831</td>
    </tr>
    <tr>
      <th>62</th>
      <td>MHMYL4920B</td>
      <td>0.4388</td>
      <td>0.126297</td>
      <td>0.472727</td>
    </tr>
    <tr>
      <th>32</th>
      <td>HPWIF9956L</td>
      <td>0.4292</td>
      <td>0.163297</td>
      <td>0.478261</td>
    </tr>
    <tr>
      <th>53</th>
      <td>KZKEZ2257Z</td>
      <td>0.4147</td>
      <td>0.206979</td>
      <td>0.386555</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>34</th>
      <td>HYCCK3082L</td>
      <td>0.1439</td>
      <td>0.999950</td>
      <td>0.142857</td>
    </tr>
    <tr>
      <th>36</th>
      <td>HZMLX7970T</td>
      <td>0.1439</td>
      <td>0.999995</td>
      <td>0.200000</td>
    </tr>
    <tr>
      <th>72</th>
      <td>OUXUZ1084Q</td>
      <td>0.1439</td>
      <td>0.999989</td>
      <td>0.205128</td>
    </tr>
    <tr>
      <th>42</th>
      <td>ISXKM9668U</td>
      <td>0.1439</td>
      <td>0.999999</td>
      <td>0.076923</td>
    </tr>
    <tr>
      <th>55</th>
      <td>LFPMM4706C</td>
      <td>0.1439</td>
      <td>0.999999</td>
      <td>0.054054</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 4 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="show-relationship-between-subnet-output-and-predicted-thrombolysis-use-in-the-10k-patient-set">
<h3>Show relationship between subnet output and predicted thrombolysis use in the 10k patient set<a class="headerlink" href="#show-relationship-between-subnet-output-and-predicted-thrombolysis-use-in-the-10k-patient-set" title="Permalink to this headline">¶</a></h3>
<p>Here we plot the relationship between the hospital subnet output for each hospital and 1) actual thrombolysis use in the test set at each hospital, the predicted thrombolysis use of the whole 10k patient set attended each hospital.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot 1: actual vs subnet</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;hosp_subnet_output&#39;</span><span class="p">],</span>
           <span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;actual_thrombolysis&#39;</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hospital subnet activation&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis use (actual)&#39;</span><span class="p">)</span>
<span class="n">correlation</span> <span class="o">=</span> <span class="n">predicted_thrombolysis</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">r_square_model</span> <span class="o">=</span> \
    <span class="n">correlation</span><span class="p">[</span><span class="s1">&#39;hosp_subnet_output&#39;</span><span class="p">][</span><span class="s1">&#39;actual_thrombolysis&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;R-squared: </span><span class="si">{</span><span class="n">r_square_model</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Actual thrombolysis vs.</span><span class="se">\n</span><span class="s1">hospital subnet output&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="c1"># Plot 2: 10k vs subnet</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;hosp_subnet_output&#39;</span><span class="p">],</span>
           <span class="n">predicted_thrombolysis</span><span class="p">[</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Hospital subnet activation&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis use (reference set)&#39;</span><span class="p">)</span>
<span class="n">correlation</span> <span class="o">=</span> <span class="n">predicted_thrombolysis</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">r_square_model</span> <span class="o">=</span> \
    <span class="n">correlation</span><span class="p">[</span><span class="s1">&#39;hosp_subnet_output&#39;</span><span class="p">][</span><span class="s1">&#39;10k_thrombolysis&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;R-squared: </span><span class="si">{</span><span class="n">r_square_model</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicted 10k thrombolysis vs.</span><span class="se">\n</span><span class="s1">hospital subnet output&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/hospital_reference_thrombolysis.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/04_analyse_10k_1d_modular_20_0.png" src="../_images/04_analyse_10k_1d_modular_20_0.png" />
</div>
</div>
<p>We can see that the hospital subnet output correlates with the actual use of thrombolysis at each hospital (R-Squared 0.693), but with some scatter. The scatter will be due to factors other than hospital thrombolysis decision making effecting final thrombolysis use (such as differences in patient populations attending each hospital). When subnet activation is compared to predicted thrombolysis use of the same patients passing through all hospitals, the correlation between hospital subnet activation (which is embedded in the model during training, and is not effected by the test patients) is virtually perfect (R-Squared 0.998).</p>
<p>The results show:</p>
<ol class="simple">
<li><p>Hospital subnet output, fixed during network training, is very closely correlated with the thrombolysis use of a fixed set of patients passed through all hospitals. Hospital subnet output may therefore be used as a measure of “willingness to thrombolyse”, with hospitals ranked in tendency to use thrombolysis by this subnet output value.</p></li>
<li><p>Hospital subnet output (hospital-level decision-making) explains a significant proportion, but not all, of the inter-hospital variation in use of thrombolysis.</p></li>
</ol>
<p>NOTE: Here the subnet activation is inversely proportional to the use of thrombolysis. This may seem counter-intuitive, but it is due to the way neural networks optimise. There is no need for networks to optimise to have direct proportionality throughout the networks; the direction of relationship may be switched at each layer.</p>
</div>
</div>
<div class="section" id="examine-clinical-subnet-output">
<h2>Examine clinical subnet output<a class="headerlink" href="#examine-clinical-subnet-output" title="Permalink to this headline">¶</a></h2>
<p>In this section we examine the output of the clinical subnet. This subnet is patient-specific, but excludes pathway data (such as day/time of arrival, time since stroke, time of scan, etc).The output is therefore dependent on patient clinical characteristics, but is not dependent on which hospital a patient attended or dependent on pathway data.</p>
<div class="section" id="get-clincial-subnet-output-for-10k-patients">
<h3>Get clincial subnet output for 10k patients<a class="headerlink" href="#get-clincial-subnet-output-for-10k-patients" title="Permalink to this headline">¶</a></h3>
<p>This code gets the output directly from the clinical subnet in the neural network. We store this with all patient characteristics (the loaded test set data).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get patient subnet output</span>
<span class="n">layer_name</span> <span class="o">=</span> <span class="s1">&#39;patient_encode&#39;</span>
<span class="n">patient_encode_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">input</span><span class="p">,</span><span class="n">outputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
<span class="n">patient_encode_output</span> <span class="o">=</span> <span class="n">patient_encode_model</span><span class="p">([</span>
    <span class="n">X_test_patients_sc</span><span class="p">,</span> <span class="n">X_test_pathway_sc</span><span class="p">,</span> <span class="n">X_test_hospitals_sc</span><span class="p">])</span>

<span class="c1"># Put in DataFrame with all patient characteristics (X)</span>
<span class="n">clinical_subnet_output</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">clinical_subnet_output</span><span class="p">[</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="n">patient_encode_output</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">clinical_subnet_output</span><span class="p">[</span><span class="s1">&#39;num_hosp_thrombolysising&#39;</span><span class="p">]</span> <span class="o">=</span> \
    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">patient_results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># Sort by patient_subnet_output</span>
<span class="n">clinical_subnet_output</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="show-relationship-between-clinical-subnet-output-and-proportion-of-patients-receiving-thrombolysis">
<h3>Show relationship between clinical subnet output and proportion of patients receiving thrombolysis<a class="headerlink" href="#show-relationship-between-clinical-subnet-output-and-proportion-of-patients-receiving-thrombolysis" title="Permalink to this headline">¶</a></h3>
<p>Here we test the relationship between the output of the clinical subnet and the actual use of thrombolysis. We do this by binning the output of the clinical subnets into 10 bins (each representing a range of 0.1 in the clinical subnet output), and taking the average use of thrombolysis in that bin.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subnet_values</span> <span class="o">=</span> <span class="n">clinical_subnet_output</span><span class="p">[</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">subnet_values</span> <span class="o">=</span> <span class="n">subnet_values</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">clinical_subnet_output</span><span class="p">[</span><span class="s1">&#39;subnet_bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subnet_values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span> <span class="o">+</span> <span class="mf">0.05</span>


<span class="n">rx</span> <span class="o">=</span> <span class="n">clinical_subnet_output</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;subnet_bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rx</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rx</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Clinical subnet output (binned)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Proportion of patients receiving thrombolysis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/clinical_subnet_thrombolysis.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/04_analyse_10k_1d_modular_26_0.png" src="../_images/04_analyse_10k_1d_modular_26_0.png" />
</div>
</div>
<p>We observe a clear relationship between the clinical subnet output and the use of thrombolysis - those patients with the highest clinical subnet output have a little over 70% use of thrombolysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">patient_thromb_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">patient_results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="c1"># Set up figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;RdYlBu&#39;</span><span class="p">)</span>
<span class="c1"># Plot 1: actual vs subnet</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">clinical_subnet_output</span><span class="p">[</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">],</span>
                 <span class="n">clinical_subnet_output</span><span class="p">[</span><span class="s1">&#39;num_hosp_thrombolysising&#39;</span><span class="p">]</span> <span class="p">,</span>
                 <span class="n">c</span><span class="o">=</span><span class="n">clinical_subnet_output</span><span class="p">[</span><span class="s1">&#39;num_hosp_thrombolysising&#39;</span><span class="p">]</span> <span class="p">,</span>
                 <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">132</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Clinical subnet output&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of hospitals predicted to give thrombolysis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Number of hospitals predicted to give thrombolysis&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/clinical_subnet_thrombolysis_scatter.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/04_analyse_10k_1d_modular_28_0.png" src="../_images/04_analyse_10k_1d_modular_28_0.png" />
</div>
</div>
</div>
<div class="section" id="show-some-clinical-subnet-outputs-by-patient-type">
<h3>Show some clinical subnet outputs by patient type<a class="headerlink" href="#show-some-clinical-subnet-outputs-by-patient-type" title="Permalink to this headline">¶</a></h3>
<p>Here we look at the relationships between some clinical features and the clinical subnet output.</p>
<div class="section" id="show-patient-subnet-output-by-stroke-type">
<h4>Show patient_subnet_output by stroke type<a class="headerlink" href="#show-patient-subnet-output-by-stroke-type" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clinical_subnet_output</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;S2StrokeType_Infarction&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>S2StrokeType_Infarction
0    0.044477
1    0.626675
Name: patient_subnet_output, dtype: float32
</pre></div>
</div>
</div>
</div>
<p>Those patients with an infarction (clot) have, on average, a much higher clinical subnet output than those without infarction (bleed, or type-unknown).</p>
</div>
<div class="section" id="show-patient-subnet-output-by-age-group">
<h4>Show patient_subnet_output by age group<a class="headerlink" href="#show-patient-subnet-output-by-age-group" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clinical_subnet_output</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;MoreEqual80y_Yes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MoreEqual80y_Yes
0    0.561388
1    0.508315
Name: patient_subnet_output, dtype: float32
</pre></div>
</div>
</div>
</div>
<p>Those patients aged 80 or over have a little lower clinical subnet output than those aged under 80.</p>
</div>
<div class="section" id="show-relationship-between-nihss-arrival-and-clinical-subnet-output">
<h4>Show relationship between NIHSS arrival and clinical_subnet_output<a class="headerlink" href="#show-relationship-between-nihss-arrival-and-clinical-subnet-output" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nihss</span> <span class="o">=</span> <span class="n">clinical_subnet_output</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;S2NihssArrival&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">]</span>
<span class="c1"># Limit plot to NIHSS of 30 or less, as less than 20 in each group above this</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">nihss</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span><span class="mi">30</span>
<span class="n">nihss</span> <span class="o">=</span> <span class="n">nihss</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nihss</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">nihss</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;NIHSS on arrival&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Clinical subnet embedding output&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/clinical_subnet_nihss.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/04_analyse_10k_1d_modular_37_0.png" src="../_images/04_analyse_10k_1d_modular_37_0.png" />
</div>
</div>
<p>Clinical subnet output is low for patients with low or high NIHSS on arrival.</p>
</div>
<div class="section" id="show-relationship-between-modifed-rankin-scale-and-clinical-subnet-output">
<h4>Show relationship between modifed Rankin Scale and clinical_subnet_output<a class="headerlink" href="#show-relationship-between-modifed-rankin-scale-and-clinical-subnet-output" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rankin</span> <span class="o">=</span> <span class="n">clinical_subnet_output</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;S2RankinBeforeStroke&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;patient_subnet_output&#39;</span><span class="p">]</span>
<span class="c1"># Limit plot to NIHSS of 30 or less, as less than 20 in each group above this</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rankin</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rankin</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;modied Rankin Scale before stroke&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Clinical subnet embedding output&#39;</span><span class="p">)</span>
<span class="c1">#ax.set_ylim(0.35,0.6)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/clinical_subnet_rankin.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/04_analyse_10k_1d_modular_40_0.png" src="../_images/04_analyse_10k_1d_modular_40_0.png" />
</div>
</div>
<p>Clinical subnet output falls with increasing disability before stroke.</p>
</div>
</div>
</div>
<div class="section" id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The model had 85% accuracy (in line with accuracy assed by k-fold replication).</p></li>
<li><p>Thrombolysis use in the 10K cohort was predicted to be 14% to 47%</p></li>
<li><p>Activation of the hospital subnet correlated with predicted thrombolysis use in the 10K patient cohort across hospitals (R-Squared 0.998) and with observed thrombolysis use across hospitals (R-Squared 0.693).</p></li>
<li><p>Activation of the clinical subnet was strongly associated with observed thrombolysis use across hospitals. The clinical subnet showed clear relationships with key clinical features such as stroke type, stroke severity, and disability before stroke.</p></li>
<li><p>Subnets provide insight into both hospitals and patients. The subnets allow ranking of hospitals in likelihood to use thrombolysis (independent of patients) and allow ranking of patient clinical characteristics in suitability for thrombolysis.</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./embedding_nets"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="03_generate_1d_net_for_10k.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Train and save network for 10K patient subset</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="05_compare_benchmark_decisions.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Compare local thrombolysis decisions with <em>benchmark</em> decisions</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Kerry Pearn & Michael Allen<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>