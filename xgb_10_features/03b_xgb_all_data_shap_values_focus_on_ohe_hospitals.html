

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Explore the hospital effect on thrombolysis use, using SHAP values from a single XGBoost model &#8212; What would other emergency stroke teams do? Using explainable machine learning to understand variation in thrombolysis practice</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'xgb_10_features/03b_xgb_all_data_shap_values_focus_on_ohe_hospitals';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Explore the hospital effect on thrombolysis use, using SHAP main effects from a single XGBoost model" href="03c_xgb_all_data_shap_interaction_values_focus_on_ohe_hospitals.html" />
    <link rel="prev" title="Fit a single XGBoost model and calculate the SHAP values" href="03a_xgb_all_data_shap_values_vs_feature_values.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../introduction/intro.html">
  
  
  
  
  
    <p class="title logo__title">What would other emergency stroke teams do? Using explainable machine learning to understand variation in thrombolysis practice</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/intro.html">
                    What would other emergency stroke teams do? Using explainable machine learning to understand variation in thrombolysis practice
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introductory content</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/glossary.html">Glossary of technical terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/odds_prob.html">Probability, odds, and SHAP values (log odds shifts)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/shap_worked_example.html">A simple worked example of Shap</a></li>
<li class="toctree-l1"><a class="reference internal" href="90_shap_interactions_on_titanic.html">Examining interactions between features with SHAP interactions: Using Titanic survival as an example</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Predicting thrombolysis use and explaining the predictions with Shap</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="91_learning_rate_optimisation.html">Evaluation of XGBoost learning rates on distribution of 10k thrombolysis rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_xgb_combined_fit_feature_selection.html">XGBoost feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_correlation.html">Check correlation between features selected for the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_xgb_combined_fit_accuracy_key_features.html">Measuring accuracy of XGBoost models</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_xgb_combined_shap_key_features.html">Explaining XGBoost model predictions with SHAP values</a></li>
<li class="toctree-l1"><a class="reference internal" href="03a_xgb_all_data_shap_values_vs_feature_values.html">Fit a single XGBoost model and calculate the SHAP values</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Explore the hospital effect on thrombolysis use, using SHAP values from a single XGBoost model</a></li>

<li class="toctree-l1"><a class="reference internal" href="03c_xgb_all_data_shap_interaction_values_focus_on_ohe_hospitals.html">Explore the hospital effect on thrombolysis use, using SHAP main effects from a single XGBoost model</a></li>

<li class="toctree-l1"><a class="reference internal" href="03d_xgb_all_data_shap_values_and_interaction_values_focus_on_ohe_hospitals.html">Explore the hospital effect on thrombolysis use, using SHAP values and SHAP main effects from a single XGBoost model</a></li>
<li class="toctree-l1"><a class="reference internal" href="03e_xgb_shap_value_and_main_effect_regressions_on_hospital_ivt_rate.html">How much of the variation in the hosptials thrombolysis rate can be attributed to the difference in the hospital processes, and to different patient populations?</a></li>
<li class="toctree-l1"><a class="reference internal" href="03f_xgb_subset_shap_value_regressions_on_hospital_ivt_rate.html">Calculate and use <em>subset</em> SHAP values (from a single XGBoost model) to attribute hospital IVT variation to patient mix and hospital processes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Using a 10k cohort of patients to compare decision-making</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="04_xgb_10k_cohort_key_features.html">A comparison of 10k cohort thrombolysis rates across hospitals</a></li>
<li class="toctree-l1"><a class="reference internal" href="04a_xgb_10k_cohort_shap_values_interaction_values.html">A comparison of hospital SHAP values and SHAP main effect values for the 10k cohort.</a></li>
<li class="toctree-l1"><a class="reference internal" href="04b_xgb_10k_cohort_thrombolysis_subgroups.html">A comparison of expected 10k cohort thrombolysis rates across hospitals: subgroup analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="04c_xgb_10k_cohort%E2%80%8B_vs_observed_thrombolysis_subgroups.html">A comparison of actual thrombolysis rates across hospitals: subgroup analysis</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/xgb_10_features/03b_xgb_all_data_shap_values_focus_on_ohe_hospitals.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Explore the hospital effect on thrombolysis use, using SHAP values from a single XGBoost model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Explore the hospital effect on thrombolysis use, using SHAP values from a single XGBoost model</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plain-english-summary">Plain English summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-data">Model and data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aims">Aims</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-filenames">Set filenames</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-output-folders-if-needed">Create output folders if needed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-json-file">Read in JSON file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-list-of-feature-names">Get list of feature names</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edit-data">Edit data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">Divide into X (features) and y (labels)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encode-hospital-feature">One-hot encode hospital feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-model-feature-names">Get model feature names</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost-model">XGBoost model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-shap-values">Get SHAP values</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understand-shap-values-for-the-one-hot-encoded-hospital-features">Understand SHAP values for the one-hot encoded hospital features</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#format-the-data">Format the data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#boxplot-all-hospitals-together">Boxplot (all hospitals together)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#boxplot-individual-hospitals">Boxplot (individual hospitals)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-code">Extra code</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="explore-the-hospital-effect-on-thrombolysis-use-using-shap-values-from-a-single-xgboost-model">
<h1>Explore the hospital effect on thrombolysis use, using SHAP values from a single XGBoost model<a class="headerlink" href="#explore-the-hospital-effect-on-thrombolysis-use-using-shap-values-from-a-single-xgboost-model" title="Permalink to this heading">#</a></h1>
<p><strong>Research question: What’s the difference between the SHAP value for patients that attend a hospital, with the SHAP value for patients that do not attend a hospital</strong></p>
<section id="plain-english-summary">
<h2>Plain English summary<a class="headerlink" href="#plain-english-summary" title="Permalink to this heading">#</a></h2>
<p>When fitting a machine learning model to data to make a prediction, it is now possible, with the use of the SHAP library, to allocate contributions of the prediction onto the feature values. This means that we can now turn these black box methods into transparent models and describe what the model used to obtain it’s prediction.</p>
<p>SHAP values are calculated for each feature of each instance for a fitted model. In addition there is the SHAP base value which is the same value for all of the instances. The base value represents the models best guess for any instance without any extra knowledge about the instance (this can also be thought of as the “expected value”). It is possible to obtain the models prediction of an instance by taking the sum of the SHAP base value and each of the SHAP values for the features. This allows the prediction from a model to be transparant, and we can rank the features by their importance in determining the prediction for each instance.</p>
<p>Here we will use the single XGBoost model trained on all of the data, no test set, and read in the SHAP values for this model (from notebook 03a) and focus on understanding the SHAP values for each of the one-hot encoded hosptial features that make up the <em>Stroke team</em> categorical feature.</p>
<p>For example, what is the range of SHAP values for patients that attend the hospital, and for those that do not (as we are representing the hospital feature as a one-hot encoded feature we have a feature for each hospital, so each hospital has a SHAP value when a patient attend another one, so there is a contribution to the prediction based on <em>not</em> attending a hospital).</p>
<p>SHAP values are in the same units as the model output (for XGBoost these are in log odds).</p>
</section>
<section id="model-and-data">
<h2>Model and data<a class="headerlink" href="#model-and-data" title="Permalink to this heading">#</a></h2>
<p>Using the XGBoost model trained on all of the data (no test set used) from notebook 03a_xgb_combined_shap_key_features.ipynb. The 10 features in the model are:</p>
<ul class="simple">
<li><p>Arrival-to-scan time: Time from arrival at hospital to scan (mins)</p></li>
<li><p>Infarction: Stroke type (1 = infarction, 0 = haemorrhage)</p></li>
<li><p>Stroke severity: Stroke severity (NIHSS) on arrival</p></li>
<li><p>Precise onset time: Onset time type (1 = precise, 0 = best estimate)</p></li>
<li><p>Prior disability level: Disability level (modified Rankin Scale) before stroke</p></li>
<li><p>Stroke team: Stroke team attended</p></li>
<li><p>Use of AF anticoagulents: Use of atrial fibrillation anticoagulant (1 = Yes, 0 = No)</p></li>
<li><p>Onset-to-arrival time: Time from onset of stroke to arrival at hospital (mins)</p></li>
<li><p>Onset during sleep: Did stroke occur in sleep?</p></li>
<li><p>Age: Age (as middle of 5 year age bands)</p></li>
</ul>
<p>And one target feature:</p>
<ul class="simple">
<li><p>Thrombolysis: Did the patient receive thrombolysis (0 = No, 1 = Yes)</p></li>
</ul>
</section>
<section id="aims">
<h2>Aims<a class="headerlink" href="#aims" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Using XGBoost model fitted on all the data (no test set) using 10 features</p></li>
<li><p>Using SHAP values previously calculated</p></li>
<li><p>Understand the SHAP values for each of the hospital one-hot encoded features</p></li>
</ul>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>SHAP values for the one-hot encoded hospital features are very dependent on whether the instance attended the hospital or not</p></li>
<li><p>SHAP values for the attended one-hot encoded hospital feature are largely one side of zero or the other. There are fewer instances in this population, but the range of SHAP values is wider.</p></li>
<li><p>SHAP values for the not attended one-hot encoded hospitals are largely centred on zero. There are more instances in this population, but the range of SHAP values is narrower.</p></li>
<li><p>58% of the variability in hospital thrombolysis rate can be explained by the SHAP value for the one-hot encoded hospital feature (the mean of those instances that attend the hospital).</p></li>
</ul>
</section>
<section id="import-libraries">
<h2>Import libraries<a class="headerlink" href="#import-libraries" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Import machine learning methods</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>

<span class="kn">import</span> <span class="nn">shap</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># .floor and .ceil</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># So can take deep copy</span>
<span class="kn">import</span> <span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-filenames">
<h2>Set filenames<a class="headerlink" href="#set-filenames" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up strings (describing the model) to use in filenames</span>
<span class="n">number_of_features_to_use</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xgb_</span><span class="si">{</span><span class="n">number_of_features_to_use</span><span class="si">}</span><span class="s1">_features&#39;</span>
<span class="n">notebook</span> <span class="o">=</span> <span class="s1">&#39;03b&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-output-folders-if-needed">
<h2>Create output folders if needed<a class="headerlink" href="#create-output-folders-if-needed" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./saved_models&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./output&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./predictions&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>   
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-json-file">
<h2>Read in JSON file<a class="headerlink" href="#read-in-json-file" title="Permalink to this heading">#</a></h2>
<p>Contains a dictionary for plain English feature names for the 8 features selected in the model. Use these as the column titles in the DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./output/01_feature_name_dict.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">dict_feature_name</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this heading">#</a></h2>
<p>Data has previously been split into 5 stratified k-fold splits.</p>
<p>For this exercise, we will fit a model using all of the data (rather than train/test splits used to assess accuracy). We will join up all of the test data (by definition, each instance exists only once across all of the 5 test sets)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;../data/kfold_5fold/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise empty list</span>
<span class="n">test_data_kfold</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Read in the names of the selected features for the model</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./output/01_feature_selection.csv&#39;</span><span class="p">)</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])[:</span><span class="n">number_of_features_to_use</span><span class="p">]</span>
<span class="c1"># And add the target feature name: S2Thrombolysis</span>
<span class="n">key_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">)</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Read in test set, restrict to chosen features, rename titles, &amp; store</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;test_</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">key_features</span><span class="p">]</span>
    <span class="n">test</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dict_feature_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_data_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="c1"># Join all the test sets. Set &quot;ignore_index = True&quot; to reset the index in the</span>
<span class="c1">#   new dataframe (to run from 0 to n-1), otherwise get duplicate index values</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">test_data_kfold</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-list-of-feature-names">
<h2>Get list of feature names<a class="headerlink" href="#get-list-of-feature-names" title="Permalink to this heading">#</a></h2>
<p>Before convert stroke team to one-hot encoded features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data_kfold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="edit-data">
<h2>Edit data<a class="headerlink" href="#edit-data" title="Permalink to this heading">#</a></h2>
<section id="divide-into-x-features-and-y-labels">
<h3>Divide into X (features) and y (labels)<a class="headerlink" href="#divide-into-x-features-and-y-labels" title="Permalink to this heading">#</a></h3>
<p>We will separate out our features (the data we use to make a prediction) from our label (what we are trying to predict).
By convention our features are called <code class="docutils literal notranslate"><span class="pre">X</span></code> (usually upper case to denote multiple features), and the label (thrombolysis or not) <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Average thromboylsis (this is the expected outcome of each patient, without knowing anything about the patient)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average treatment: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average treatment: 0.3
</pre></div>
</div>
</div>
</div>
</section>
<section id="one-hot-encode-hospital-feature">
<h3>One-hot encode hospital feature<a class="headerlink" href="#one-hot-encode-hospital-feature" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep copy of original, with &#39;Stroke team&#39; not one-hot encoded</span>
<span class="n">X_combined</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># One-hot encode &#39;Stroke team&#39;</span>
<span class="n">X_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">X_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-model-feature-names">
<h3>Get model feature names<a class="headerlink" href="#get-model-feature-names" title="Permalink to this heading">#</a></h3>
<p>With one-hot encoded hospitals</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a list of the model feature names</span>
<span class="n">feature_names_ohe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="xgboost-model">
<h2>XGBoost model<a class="headerlink" href="#xgboost-model" title="Permalink to this heading">#</a></h2>
<p>An XGBoost model was trained on the full dataset (rather than train/test splits used to assess accuracy) in notebook 03a. These models are saved f’./saved_models/03a_{model_text}.p’.</p>
</section>
<section id="get-shap-values">
<h2>Get SHAP values<a class="headerlink" href="#get-shap-values" title="Permalink to this heading">#</a></h2>
<p>SHAP values give the contribution that each feature has on the models prediction, per instance. A SHAP value is returned for each feature, for each instance.</p>
<p>‘Raw’ SHAP values from XGBoost model are log odds ratios.</p>
<p>In notebook 03a we used the TreeExplainer from the shap library (https://shap.readthedocs.io/en/latest/index.html) to calculate the SHAP values. This is a fast and exact method to estimate SHAP values for tree models and ensembles of tree.</p>
<p>Load SHAP values from pickle (calculated in notebook 03a).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># Load SHAP values extended (using the explainer model)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03a_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_extended.p&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
    <span class="n">shap_values_extended</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 1.59 ms, sys: 60.6 ms, total: 62.2 ms
Wall time: 61.8 ms
</pre></div>
</div>
</div>
</div>
<p>The explainer returns the base value which is the same value for all instances [shap_value.base_values], the shap values per feature [shap_value.values]. It also returns the feature dataset values [shap_values.data]. You can (sometimes!) access the feature names from the explainer [explainer.data_feature_names].</p>
<p>Let’s take a look at the data held for the first instance:</p>
<ul class="simple">
<li><p>.values has the SHAP value for each of the four features.</p></li>
<li><p>.base_values has the best guess value without knowing anything about the instance.</p></li>
<li><p>.data has each of the feature values</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_values_extended</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.values =
array([ 7.56502628e-01,  4.88319576e-01,  1.10273695e+00,  4.40223962e-01,
        4.98975307e-01,  2.02812225e-01, -2.62601525e-01,  3.69181409e-02,
        2.30234995e-01,  3.20923195e-04, -6.03703642e-03, -7.17267860e-04,
        0.00000000e+00, -4.91688668e-04,  1.20360847e-03,  1.77788886e-03,
       -4.34198463e-03, -2.76021136e-04, -2.79896380e-03,  3.52182891e-03,
       -2.73969141e-04,  8.53505917e-03, -5.28220041e-03, -8.25227005e-04,
        6.20208494e-03,  6.92215608e-03, -6.32244349e-03, -3.35367222e-04,
        7.81939551e-03, -4.71850217e-06, -4.25534381e-05,  6.48253039e-03,
        8.43156071e-04, -6.28353562e-04, -1.25156669e-02, -7.92063680e-03,
       -1.99409085e-03, -5.05548809e-03, -3.90118686e-03,  1.30317558e-03,
        0.00000000e+00, -6.48246554e-04,  1.19629130e-03,  8.26304778e-04,
        1.28053436e-02,  2.55714403e-03, -3.20375757e-03,  4.23251512e-03,
       -7.19791185e-03,  4.02670400e-03,  3.75146419e-03,  8.31848301e-04,
        3.45067866e-03,  3.92199913e-03,  1.05317042e-04,  9.53648426e-03,
        2.34490633e-03, -1.05699897e-03, -7.75758363e-03,  1.09220366e-03,
        0.00000000e+00,  5.15310653e-03, -1.28013985e-02,  7.28079583e-03,
        1.98326469e-03,  2.40865033e-04,  6.70310017e-03,  1.18395500e-03,
        8.82393331e-04,  2.83133984e-03,  2.06021918e-03, -8.22589453e-03,
        5.11038816e-03, -3.25066457e-03, -1.15480982e-02,  9.36000666e-04,
        2.03671609e-03, -2.02708528e-03, -5.31264208e-03,  2.42300611e-03,
        3.16989725e-04,  3.67143471e-03, -5.07418578e-03, -2.68517504e-03,
        3.30522249e-04, -6.63852552e-03, -1.63316587e-03,  1.75383547e-03,
       -4.12231544e-03,  1.20234396e-03, -6.25999365e-03,  0.00000000e+00,
       -1.00428164e-02, -1.76329317e-03,  3.12283775e-03,  4.69124934e-04,
       -1.22163491e-03,  2.30912305e-03,  9.43152234e-04,  1.22348359e-03,
        5.29656609e-05, -9.66969132e-03,  3.44762520e-06, -5.46710449e-04,
        4.26546484e-03,  4.65912558e-03,  1.30611981e-04, -2.89813057e-03,
       -2.98934802e-03, -1.47398096e-03, -2.31104009e-02, -3.47609469e-03,
       -5.73671749e-03,  3.97895870e-04,  9.02379164e-04, -5.86819311e-04,
       -1.79305486e-03, -5.28960605e-04, -2.10736915e-02,  3.50499223e-03,
       -2.04754542e-04, -2.86527374e-03,  1.52953295e-03, -3.72403156e-06,
        1.42271689e-03, -2.97368824e-04,  5.06201060e-04,  5.77868486e-04,
       -1.44459037e-02,  3.30785802e-03, -2.37809308e-03, -7.35214865e-03,
        3.36531224e-03,  1.49519066e-03, -2.46208580e-03,  7.20066251e-04,
        6.83251710e-04, -1.92034326e-03,  2.39002449e-03, -8.96935933e-04,
        4.85493708e-03], dtype=float32)

.base_values =
-1.1629876

.data =
array([ 17. ,   1. ,  14. ,   1. ,   0. ,   0. , 186. ,   0. ,  47.5,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   1. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ])
</pre></div>
</div>
</div>
</div>
<p>There is one of these for each instance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_values_extended</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(88792, 141)
</pre></div>
</div>
</div>
</div>
<section id="understand-shap-values-for-the-one-hot-encoded-hospital-features">
<h3>Understand SHAP values for the one-hot encoded hospital features<a class="headerlink" href="#understand-shap-values-for-the-one-hot-encoded-hospital-features" title="Permalink to this heading">#</a></h3>
<p>We’ve seen above that the categorical feature represented as a one-hot encoded feature have a SHAP value for each of the one-hot encoded features.</p>
<p>For the hospital that the instance attends, the SHAP value for that hosptial represents “the contribution to the prediction due to attending this hospital”. For all of the other hosptials for this instance, the SHAP value for those hospitals represents “the contribution to the prediction from not attending this hospital”.</p>
<p>Here we will focus on understanding the SHAP values for each hospital, their contribution when a patient attends the hospital, and the contribution when the patient does not attend the hospital.</p>
<section id="format-the-data">
<h4>Format the data<a class="headerlink" href="#format-the-data" title="Permalink to this heading">#</a></h4>
<p>Features are in the same order in shap_values as they are in the original dataset.</p>
<p>Use this to extract the SHAP values for the one-hot encoded hospital features. Create a dataframe containing the SHAP values: an instance per row, and a one-hot encoded hospital feature per column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get list of one-hot encoded hospital column titles</span>
<span class="n">hospital_names_ohe</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^team&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
<span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hospital_names_ohe</span><span class="p">)</span>

<span class="c1"># Get list of hospital names without the prefix &quot;team_&quot;</span>
<span class="n">hospital_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names_ohe</span><span class="p">]</span>

<span class="c1"># Create list of column indices for these hospital column titles (where do the</span>
<span class="c1">#   hospital features exist in the datasets?)</span>
<span class="n">hospital_columns_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">hospital_names_ohe</span><span class="p">]</span>
<span class="c1"># Use this index list to access the hosptial shap values (as array)</span>
<span class="n">hosp_shap_values</span> <span class="o">=</span> <span class="n">shap_values_extended</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="n">hospital_columns_index</span><span class="p">]</span>
<span class="c1"># Put in dataframe with hospital as column title</span>
<span class="n">df_hosp_shap_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hosp_shap_values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">hospital_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Also include four further columns:</p>
<ol class="arabic simple">
<li><p>the hospital that the instance attended</p></li>
<li><p>contribution from all of the one-hot encoded hospital features</p></li>
<li><p>contribution from just the hospital attended</p></li>
<li><p>contribution from not attending the rest</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Include Stroke team that each instance attended</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_combined</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Store the sum of the SHAP values (for all of the hospital features)</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;all_stroke_teams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Initialise list for 1) SHAP value for attended hospital 2) SHAP value for </span>
<span class="c1">#   the sum of the rest of the hospitals</span>
<span class="n">shap_attended_hospital</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">shap_not_attend_these_hospitals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each patient</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

    <span class="c1"># Get stroke team attended</span>
    <span class="n">stroke_team</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span>
    
    <span class="c1"># Get SHAP value for the stroke team attended</span>
    <span class="n">shap_attended_hospital</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">])</span>

    <span class="c1"># Calculate sum of SHAP values for the stroke teams not attend </span>
    <span class="n">sum_rest</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;all_stroke_teams&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">]</span>
    <span class="n">shap_not_attend_these_hospitals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_rest</span><span class="p">)</span>

<span class="c1"># Store two new columns in dataframe</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;attended_stroke_team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shap_attended_hospital</span>
<span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;not_attended_stroke_teams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="n">shap_not_attend_these_hospitals</span><span class="p">)</span>
                   
<span class="c1"># View preview</span>
<span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AGNOF1041H</th>
      <th>AKCGO9726K</th>
      <th>AOBTM3098N</th>
      <th>APXEE8191H</th>
      <th>ATDID5461S</th>
      <th>BBXPQ0212O</th>
      <th>BICAW1125K</th>
      <th>BQZGT7491V</th>
      <th>BXXZS5063A</th>
      <th>CNBGF2713O</th>
      <th>...</th>
      <th>YEXCH8391J</th>
      <th>YPKYH1768F</th>
      <th>YQMZV4284N</th>
      <th>ZBVSO0975W</th>
      <th>ZHCLE1578P</th>
      <th>ZRRCV7012C</th>
      <th>Stroke team</th>
      <th>all_stroke_teams</th>
      <th>attended_stroke_team</th>
      <th>not_attended_stroke_teams</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000321</td>
      <td>-0.006037</td>
      <td>-0.000717</td>
      <td>0.0</td>
      <td>-0.000492</td>
      <td>0.001204</td>
      <td>0.001778</td>
      <td>-0.004342</td>
      <td>-0.000276</td>
      <td>-0.002799</td>
      <td>...</td>
      <td>0.000720</td>
      <td>0.000683</td>
      <td>-0.001920</td>
      <td>0.002390</td>
      <td>-0.000897</td>
      <td>0.004855</td>
      <td>TXHRP7672C</td>
      <td>-0.084398</td>
      <td>-0.023110</td>
      <td>-0.061287</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.001207</td>
      <td>-0.002507</td>
      <td>0.000081</td>
      <td>0.0</td>
      <td>-0.001356</td>
      <td>0.001547</td>
      <td>0.003449</td>
      <td>-0.006348</td>
      <td>-0.000127</td>
      <td>-0.002576</td>
      <td>...</td>
      <td>0.000148</td>
      <td>0.000683</td>
      <td>-0.001825</td>
      <td>0.000454</td>
      <td>-0.001445</td>
      <td>0.003970</td>
      <td>SQGXB9559U</td>
      <td>-0.760522</td>
      <td>-0.671515</td>
      <td>-0.089007</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.001492</td>
      <td>-0.015246</td>
      <td>0.002635</td>
      <td>0.0</td>
      <td>-0.000272</td>
      <td>0.001399</td>
      <td>0.002737</td>
      <td>-0.007848</td>
      <td>-0.000605</td>
      <td>-0.002614</td>
      <td>...</td>
      <td>0.000135</td>
      <td>0.000262</td>
      <td>-0.000928</td>
      <td>0.001229</td>
      <td>-0.001506</td>
      <td>0.003792</td>
      <td>LFPMM4706C</td>
      <td>-1.204099</td>
      <td>-1.084834</td>
      <td>-0.119265</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.001255</td>
      <td>0.002451</td>
      <td>0.002644</td>
      <td>0.0</td>
      <td>-0.001359</td>
      <td>0.000008</td>
      <td>0.003055</td>
      <td>-0.003141</td>
      <td>-0.000131</td>
      <td>-0.002352</td>
      <td>...</td>
      <td>0.000705</td>
      <td>0.000683</td>
      <td>-0.003016</td>
      <td>0.003507</td>
      <td>-0.000939</td>
      <td>0.002133</td>
      <td>MHMYL4920B</td>
      <td>0.684426</td>
      <td>0.737010</td>
      <td>-0.052583</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.006129</td>
      <td>-0.004731</td>
      <td>0.002644</td>
      <td>0.0</td>
      <td>-0.001359</td>
      <td>0.000302</td>
      <td>0.002677</td>
      <td>-0.004384</td>
      <td>0.000272</td>
      <td>-0.002281</td>
      <td>...</td>
      <td>0.000892</td>
      <td>0.000010</td>
      <td>-0.001976</td>
      <td>0.001467</td>
      <td>-0.000799</td>
      <td>0.002244</td>
      <td>EQZZZ5658G</td>
      <td>-0.088429</td>
      <td>0.028813</td>
      <td>-0.117242</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 136 columns</p>
</div></div></div>
</div>
</section>
<section id="boxplot-all-hospitals-together">
<h4>Boxplot (all hospitals together)<a class="headerlink" href="#boxplot-all-hospitals-together" title="Permalink to this heading">#</a></h4>
<p>Analyse the range of SHAP values for the one-hot encoded hospital features. Show as two populations: 1) the attended hospital, 2) the sum of the hospitals not attended</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([</span><span class="n">shap_attended_hospital</span><span class="p">,</span> <span class="n">shap_not_attend_these_hospitals</span><span class="p">],</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Attended hospital&quot;</span><span class="p">,</span> <span class="s2">&quot;Not attend these hospitals&quot;</span><span class="p">],</span>
            <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="n">title</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The range of SHAP values for the one-hot encoded hospital features, &quot;</span>
         <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">depending on whether attend the hospital, or not&quot;</span><span class="p">)</span>

<span class="c1"># Add line at Shap = 0</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span> 
    
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Instance population&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SHAP value&quot;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_hosp_shap_attend_vs_notattend_boxplot.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/158de85fa2bf4f73028be6dcff5d9c095d839564638a10beebe42bfb600d0d42.png" src="../_images/158de85fa2bf4f73028be6dcff5d9c095d839564638a10beebe42bfb600d0d42.png" />
</div>
</div>
</section>
<section id="boxplot-individual-hospitals">
<h4>Boxplot (individual hospitals)<a class="headerlink" href="#boxplot-individual-hospitals" title="Permalink to this heading">#</a></h4>
<p>Create a boxplot to show the range of SHAP values for each individual one-hot encoded hospital feature.</p>
<p>Show the SHAP value as two populations: 1) the group of instances that attend the hospital [black], and 2) the group of instances that do not attend the hosptial [orange].</p>
<p>Order the hospitals in descending order of mean SHAP value for the hospital the instance attended (so those that more often contribute to a yes-thrombolysis decision, through to those that most often contribute to a no-thrombolysis decision).</p>
<p>Firstly, to order the hospitals, create a dataframe containing the mean SHAP value for each hosptial (for those instances that attended the hospital)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise lists</span>
<span class="n">attend_stroketeam_min</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">attend_stroketeam_q1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">attend_stroketeam_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">attend_stroketeam_q3</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">attend_stroketeam_max</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each hospital, store descriptive statistics of SHAP values for those</span>
<span class="c1">#   instances that attend the hospital</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="n">data_stroke_team</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span><span class="mi">75</span><span class="p">])</span>
    <span class="n">attend_stroketeam_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">attend_stroketeam_q1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="n">attend_stroketeam_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">attend_stroketeam_q3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span>
    <span class="n">attend_stroketeam_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_stroke_team</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
<span class="c1"># Create dataframe with 6 columns</span>
<span class="n">df_hosp_shap_value_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hospital_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;hospital&quot;</span><span class="p">])</span>
<span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_min</span>
<span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_q1</span>
<span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_mean</span>
<span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_q3</span>
<span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attend_stroketeam_max</span>

<span class="c1"># sort in descending mean SHAP value order</span>
<span class="n">df_hosp_shap_value_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;shap_mean&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                
<span class="n">df_hosp_shap_value_stats</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hospital</th>
      <th>shap_min</th>
      <th>shap_q1</th>
      <th>shap_mean</th>
      <th>shap_q3</th>
      <th>shap_max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>9</th>
      <td>CNBGF2713O</td>
      <td>0.648626</td>
      <td>1.160532</td>
      <td>1.338743</td>
      <td>1.513107</td>
      <td>1.989456</td>
    </tr>
    <tr>
      <th>25</th>
      <td>GKONI0110I</td>
      <td>0.046286</td>
      <td>0.888337</td>
      <td>1.085008</td>
      <td>1.286739</td>
      <td>1.779779</td>
    </tr>
    <tr>
      <th>62</th>
      <td>MHMYL4920B</td>
      <td>0.130139</td>
      <td>0.786147</td>
      <td>0.933300</td>
      <td>1.059232</td>
      <td>1.476519</td>
    </tr>
    <tr>
      <th>65</th>
      <td>NTPQZ0829K</td>
      <td>0.209000</td>
      <td>0.763998</td>
      <td>0.917956</td>
      <td>1.126985</td>
      <td>1.599991</td>
    </tr>
    <tr>
      <th>32</th>
      <td>HPWIF9956L</td>
      <td>0.206888</td>
      <td>0.652731</td>
      <td>0.901027</td>
      <td>1.152177</td>
      <td>1.624375</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Add admission figures to xlabel in boxplot</p>
<p>Create dataframe with admissions and thrombolysis rate per stroke team (index)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get Stroke team name, the stroke team admission numbers, and list of SHAP </span>
<span class="c1">#   values for each instance that attended teh stroke team</span>
<span class="n">unique_stroketeams_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">X_combined</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]))</span>
<span class="n">admissions</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;team_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">unique_stroketeams_list</span><span class="p">]</span>

<span class="n">df_stroketeam_ivt_adms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">unique_stroketeams_list</span><span class="p">,</span> 
                                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span>
<span class="n">df_stroketeam_ivt_adms</span><span class="p">[</span><span class="s2">&quot;Admissions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">admissions</span>
<span class="n">df_stroketeam_ivt_adms</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_stroketeam_ivt_adms</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Admissions&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Calculate IVT rate per hosptial</span>
<span class="n">hosp_ivt_rate</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s2">&quot;Thrombolysis&quot;</span><span class="p">]</span>

<span class="c1"># Join IVT rate with admissions per hosptial</span>
<span class="n">df_stroketeam_ivt_adms</span> <span class="o">=</span> <span class="n">df_stroketeam_ivt_adms</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hosp_ivt_rate</span><span class="p">)</span>

<span class="n">df_stroketeam_ivt_adms</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Admissions</th>
      <th>Thrombolysis</th>
    </tr>
    <tr>
      <th>Stroke team</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>JXJYG0100P</th>
      <td>120</td>
      <td>0.233333</td>
    </tr>
    <tr>
      <th>VVDIY0129H</th>
      <td>130</td>
      <td>0.192308</td>
    </tr>
    <tr>
      <th>YEXCH8391J</th>
      <td>149</td>
      <td>0.228188</td>
    </tr>
    <tr>
      <th>CNBGF2713O</th>
      <td>152</td>
      <td>0.480263</td>
    </tr>
    <tr>
      <th>XPABC1435F</th>
      <td>166</td>
      <td>0.216867</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>JINXD0311F</th>
      <td>1377</td>
      <td>0.368192</td>
    </tr>
    <tr>
      <th>AKCGO9726K</th>
      <td>1428</td>
      <td>0.369748</td>
    </tr>
    <tr>
      <th>OFKDF3720W</th>
      <td>1488</td>
      <td>0.228495</td>
    </tr>
    <tr>
      <th>FPTBM7594G</th>
      <td>1645</td>
      <td>0.321581</td>
    </tr>
    <tr>
      <th>FAJKD7118X</th>
      <td>1980</td>
      <td>0.275758</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 2 columns</p>
</div></div></div>
</div>
<p>Create data for boxplot. Using order of hospitals from the hosp_shap_stats_df dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Go through this order of hospitals</span>
<span class="n">hospital_order</span> <span class="o">=</span> <span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;hospital&quot;</span><span class="p">]</span>
    
<span class="c1"># Create list of SHAP main effect values (one per hospital) for instances that </span>
<span class="c1">#   attend stroke team</span>
<span class="n">attend_stroketeam_groups_ordered</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">not_attend_stroketeam_groups_ordered</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Create list of labels for boxplot &quot;stroke team name (admissions)&quot;</span>
<span class="n">xlabel</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Through hospital in defined order (as determined above)</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_order</span><span class="p">:</span>
    <span class="c1"># Attend</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="n">attend_stroketeam_groups_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
    <span class="c1"># Not attend</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">h</span>
    <span class="n">not_attend_stroketeam_groups_ordered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
    <span class="c1"># Label</span>
    <span class="n">ivt_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_stroketeam_ivt_adms</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">xlabel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">df_stroketeam_ivt_adms</span><span class="p">[</span><span class="s1">&#39;Admissions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ivt_rate</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Plot the boxplot</p>
<p>Resource for using overall y min and max of both datasets on the 4 plots so have the same range: https://blog.finxter.com/how-to-find-the-minimum-of-a-list-of-lists-in-python/#:~:text=With%20the%20key%20argument%20of,of%20the%20list%20of%20lists</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot 34 hospitals on each figure to aid readability</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shows the range of contributions to the prediction from this hospital &quot;</span>
      <span class="s2">&quot;when patients 1) do [black], and 2) do not [orange] attend this &quot;</span>
      <span class="s2">&quot;hospital&quot;</span><span class="p">)</span>

<span class="c1"># Group the hospitals into 34</span>
<span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ed</span> <span class="o">=</span> <span class="mi">34</span>
<span class="n">inc</span> <span class="o">=</span> <span class="n">ed</span>
<span class="n">max_size</span> <span class="o">=</span> <span class="n">n_hospitals</span>

<span class="c1"># Use overall y min &amp; max of both datasets on the 4 plots so have same range</span>
<span class="n">ymin1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">attend_stroketeam_groups_ordered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">min</span><span class="p">))</span>
<span class="n">ymin2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">not_attend_stroketeam_groups_ordered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">min</span><span class="p">))</span>
<span class="n">ymax1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">attend_stroketeam_groups_ordered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">max</span><span class="p">))</span>
<span class="n">ymax2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">not_attend_stroketeam_groups_ordered</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">max</span><span class="p">))</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin1</span><span class="p">,</span> <span class="n">ymin2</span><span class="p">)</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax1</span><span class="p">,</span> <span class="n">ymax2</span><span class="p">)</span>

<span class="c1"># Adjust min and max to accommodate some wriggle room</span>
<span class="n">yrange</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin1</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">yrange</span><span class="o">/</span><span class="mi">50</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">yrange</span><span class="o">/</span><span class="mi">50</span>

<span class="c1"># Create figure with 4 subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span>

<span class="c1"># Create four subplots</span>
<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># The contribution from this hospital when patients don&#39;t attend this </span>
    <span class="c1">#    hospital</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">not_attend_stroketeam_groups_ordered</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">labels</span><span class="o">=</span><span class="n">xlabel</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>
       
    <span class="c1"># The contribution from this hospital when patients do attend this hosptial</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">attend_stroketeam_groups_ordered</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">labels</span><span class="o">=</span><span class="n">xlabel</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SHAP values (one-hot encoded hospital feature)&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Stroke team (admissions, IVT rate)&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="c1"># Add line at Shap = 0</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">)</span> 
    <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ed</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_individual_hosp_shap_attend_vs_notattend_boxplot.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shows the range of contributions to the prediction from this hospital when patients 1) do [black], and 2) do not [orange] attend this hospital
</pre></div>
</div>
<img alt="../_images/aea4b2396bf7000c18549fc12617220adf9058e6cb064564f1877e6b8aba7902.png" src="../_images/aea4b2396bf7000c18549fc12617220adf9058e6cb064564f1877e6b8aba7902.png" />
</div>
</div>
<p>Notice that when patients do not attend the hospital, the range of the SHAP values are largely centred on zero.
When patients do attend hosptial, the range of SHAP values are largely on one side of zero, or the other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iqr_below_zero</span> <span class="o">=</span> <span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q3&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="n">iqr_spans_zero</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q1&quot;</span><span class="p">]</span> <span class="o">*</span> 
                  <span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q3&quot;</span><span class="p">])</span>
<span class="n">iqr_above_zero</span> <span class="o">=</span> <span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q1&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">iqr_is_zero1</span> <span class="o">=</span> <span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">iqr_is_zero2</span> <span class="o">=</span> <span class="n">df_hosp_shap_value_stats</span><span class="p">[</span><span class="s2">&quot;shap_q3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">iqr_is_zero</span> <span class="o">=</span> <span class="n">iqr_is_zero1</span> <span class="o">*</span> <span class="n">iqr_is_zero2</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">iqr_below_zero</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> hospitals whose interquartile range &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;is below zero&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">iqr_spans_zero</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> hospitals whose interquartile &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;range spans zero&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">iqr_above_zero</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> hospitals whose interquartile range &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;is above zero&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">iqr_is_zero</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> hospitals whose interquartile range is &quot;</span>
       <span class="sa">f</span><span class="s2">&quot;zero&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 58 hospitals whose interquartile range is below zero
There are 24 hospitals whose interquartile range spans zero
There are 46 hospitals whose interquartile range is above zero
There are 4 hospitals whose interquartile range is zero
</pre></div>
</div>
</div>
</div>
<p>How does the SHAP value for the attended one-hot encoded hospital feature compare to the thrombolysis rate of the hospital?</p>
<p>Create dataframe containing the hospital’s IVT rate and SHAP value (for those patients that attend the hospital).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hosp_ivt_rate</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s2">&quot;Thrombolysis&quot;</span><span class="p">]</span>
<span class="n">df_hosp_plot</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_hosp_shap_value_stats</span><span class="p">[[</span><span class="s2">&quot;shap_mean&quot;</span><span class="p">,</span><span class="s2">&quot;hospital&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">df_hosp_plot</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;hospital&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_hosp_plot</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hosp_ivt_rate</span><span class="p">)</span>
<span class="n">df_hosp_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>shap_mean</th>
      <th>Thrombolysis</th>
    </tr>
    <tr>
      <th>hospital</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CNBGF2713O</th>
      <td>1.338743</td>
      <td>0.480263</td>
    </tr>
    <tr>
      <th>GKONI0110I</th>
      <td>1.085008</td>
      <td>0.389153</td>
    </tr>
    <tr>
      <th>MHMYL4920B</th>
      <td>0.933300</td>
      <td>0.473792</td>
    </tr>
    <tr>
      <th>NTPQZ0829K</th>
      <td>0.917956</td>
      <td>0.349603</td>
    </tr>
    <tr>
      <th>HPWIF9956L</th>
      <td>0.901027</td>
      <td>0.487562</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>LGNPK4211W</th>
      <td>-1.069179</td>
      <td>0.227181</td>
    </tr>
    <tr>
      <th>LECHF1024T</th>
      <td>-1.097267</td>
      <td>0.204301</td>
    </tr>
    <tr>
      <th>XPABC1435F</th>
      <td>-1.196877</td>
      <td>0.216867</td>
    </tr>
    <tr>
      <th>HZMLX7970T</th>
      <td>-1.198507</td>
      <td>0.194286</td>
    </tr>
    <tr>
      <th>LFPMM4706C</th>
      <td>-1.271484</td>
      <td>0.062500</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 2 columns</p>
</div></div></div>
</div>
<p>Plot SHAP value for one-hot encoded hospital feature (mean for those instances that attend the hospital) vs hospital IVT rate</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup data for chart</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;shap_mean&#39;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_hosp_plot</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>

<span class="c1"># Fit a regression line to the points</span>
<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> \
    <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">r_square</span> <span class="o">=</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span>

<span class="c1"># Create scatter plot with regression line</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Set chart limits</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># Add textbox</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;R squared: </span><span class="si">{</span><span class="n">r_square</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.46</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> 
         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>

<span class="c1"># Chart titles</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Attended hospital SHAP value&quot;</span>
              <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(mean of the instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_attended_hosp_shap_vs_ivt_rate.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> 
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/440a582776de2af18ca240373f729e861c852260702a3291108ff6e6f13271f6.png" src="../_images/440a582776de2af18ca240373f729e861c852260702a3291108ff6e6f13271f6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;formula: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> 
     <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept</span><span class="p">)))</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R squared: </span><span class="si">{</span><span class="n">r_square</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">p: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">formula: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R squared: 0.579
p: 0.0000
formula: formula: 0.11x + 0.29
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="extra-code">
<h1>Extra code<a class="headerlink" href="#extra-code" title="Permalink to this heading">#</a></h1>
<p>There was a journey to analyse the data and arrive at the boxplot (that we found to be the best visualisation yet to summarise this data).</p>
<p>Below are the other ways that we looked at the data, that led us to use the boxplot.</p>
<p>View descriptive stats</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AGNOF1041H</th>
      <th>AKCGO9726K</th>
      <th>AOBTM3098N</th>
      <th>APXEE8191H</th>
      <th>ATDID5461S</th>
      <th>BBXPQ0212O</th>
      <th>BICAW1125K</th>
      <th>BQZGT7491V</th>
      <th>BXXZS5063A</th>
      <th>CNBGF2713O</th>
      <th>...</th>
      <th>XWUBX0795L</th>
      <th>YEXCH8391J</th>
      <th>YPKYH1768F</th>
      <th>YQMZV4284N</th>
      <th>ZBVSO0975W</th>
      <th>ZHCLE1578P</th>
      <th>ZRRCV7012C</th>
      <th>all_stroke_teams</th>
      <th>attended_stroke_team</th>
      <th>not_attended_stroke_teams</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.0</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>...</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
      <td>88792.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.001127</td>
      <td>-0.002248</td>
      <td>-0.000125</td>
      <td>0.0</td>
      <td>0.000002</td>
      <td>-0.000846</td>
      <td>0.000121</td>
      <td>0.000189</td>
      <td>-0.000461</td>
      <td>-0.000242</td>
      <td>...</td>
      <td>-0.000391</td>
      <td>-0.000049</td>
      <td>-0.000210</td>
      <td>0.000426</td>
      <td>-0.000371</td>
      <td>-0.000114</td>
      <td>-0.000647</td>
      <td>-0.037682</td>
      <td>0.042369</td>
      <td>-0.080051</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.013528</td>
      <td>0.082680</td>
      <td>0.039048</td>
      <td>0.0</td>
      <td>0.015024</td>
      <td>0.051438</td>
      <td>0.034849</td>
      <td>0.050091</td>
      <td>0.013646</td>
      <td>0.056630</td>
      <td>...</td>
      <td>0.039715</td>
      <td>0.013549</td>
      <td>0.011468</td>
      <td>0.035839</td>
      <td>0.043886</td>
      <td>0.020340</td>
      <td>0.049949</td>
      <td>0.560754</td>
      <td>0.549480</td>
      <td>0.033426</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-0.389735</td>
      <td>-0.294640</td>
      <td>-0.987508</td>
      <td>0.0</td>
      <td>-0.221226</td>
      <td>-1.461526</td>
      <td>-0.733899</td>
      <td>-0.482234</td>
      <td>-0.262650</td>
      <td>-0.004530</td>
      <td>...</td>
      <td>-0.328137</td>
      <td>-0.792791</td>
      <td>-0.296149</td>
      <td>-0.328538</td>
      <td>-1.204027</td>
      <td>-0.213830</td>
      <td>-1.240766</td>
      <td>-2.085642</td>
      <td>-2.018145</td>
      <td>-0.233494</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.000334</td>
      <td>-0.015132</td>
      <td>0.001455</td>
      <td>0.0</td>
      <td>-0.000965</td>
      <td>0.001333</td>
      <td>0.002318</td>
      <td>-0.004953</td>
      <td>-0.000319</td>
      <td>-0.002886</td>
      <td>...</td>
      <td>-0.004907</td>
      <td>0.000204</td>
      <td>0.000262</td>
      <td>-0.002390</td>
      <td>0.001578</td>
      <td>-0.002748</td>
      <td>0.001935</td>
      <td>-0.363692</td>
      <td>-0.271972</td>
      <td>-0.099802</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.000775</td>
      <td>-0.008884</td>
      <td>0.002641</td>
      <td>0.0</td>
      <td>-0.000498</td>
      <td>0.001857</td>
      <td>0.002737</td>
      <td>-0.003369</td>
      <td>-0.000220</td>
      <td>-0.002531</td>
      <td>...</td>
      <td>-0.002697</td>
      <td>0.000317</td>
      <td>0.000262</td>
      <td>-0.001799</td>
      <td>0.002549</td>
      <td>-0.001633</td>
      <td>0.003190</td>
      <td>-0.064071</td>
      <td>0.010659</td>
      <td>-0.079233</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.001255</td>
      <td>-0.003960</td>
      <td>0.003523</td>
      <td>0.0</td>
      <td>-0.000203</td>
      <td>0.002346</td>
      <td>0.003449</td>
      <td>-0.001076</td>
      <td>-0.000080</td>
      <td>-0.002174</td>
      <td>...</td>
      <td>-0.001574</td>
      <td>0.000667</td>
      <td>0.000683</td>
      <td>-0.000900</td>
      <td>0.003388</td>
      <td>-0.001342</td>
      <td>0.004121</td>
      <td>0.304690</td>
      <td>0.377607</td>
      <td>-0.058291</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.504174</td>
      <td>2.055953</td>
      <td>0.329712</td>
      <td>0.0</td>
      <td>0.592340</td>
      <td>0.262388</td>
      <td>0.003869</td>
      <td>1.405697</td>
      <td>0.881546</td>
      <td>1.989456</td>
      <td>...</td>
      <td>0.929842</td>
      <td>0.049373</td>
      <td>0.000864</td>
      <td>1.315028</td>
      <td>0.283344</td>
      <td>0.744248</td>
      <td>0.176605</td>
      <td>2.409183</td>
      <td>2.507814</td>
      <td>0.033592</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 135 columns</p>
</div></div></div>
</div>
<p>Are there any hospitals that only have one value for all instances?
This indicates that the feature was not used to divide a node in any of the trees.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;These hospitals have the same SHAP value for all patients&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> has SHAP value </span><span class="si">{</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> for all&quot;</span> 
              <span class="sa">f</span><span class="s2">&quot; instances&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>These hospitals have the same SHAP value for all patients
APXEE8191H has SHAP value 0.0 for all instances
HONZP0443O has SHAP value 0.0 for all instances
JXJYG0100P has SHAP value 0.0 for all instances
QTELJ8888W has SHAP value 0.0 for all instances
</pre></div>
</div>
</div>
</div>
<p>What’s the range of number of unique values for each hospital for all patients?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;The count of unique SHAP values for each hospital&quot;</span><span class="p">)</span>       
<span class="n">n_unique_per_hosptial</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">]</span>                         
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">n_unique_per_hosptial</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The count of unique SHAP values for each hospital
</pre></div>
</div>
<img alt="../_images/e9502e7451fd04c602eea44a77ff3b820f6b50086a1f543bf3ab72585ac4c48b.png" src="../_images/e9502e7451fd04c602eea44a77ff3b820f6b50086a1f543bf3ab72585ac4c48b.png" />
</div>
</div>
<p>Is there a relationship between number of unique SHAP values, and hospital admission numnbers?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the number of admissions per hospital</span>
<span class="n">admissions</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names_ohe</span><span class="p">]</span>

<span class="c1"># Calculate number of unique SHAP values</span>
<span class="n">n_unique_per_hosptial_all_instances</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">]</span>

<span class="c1"># Calculate number of unique SHAP values for patients that attend</span>
<span class="n">n_unique_per_hosptial_attend</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n_unique_per_hosptial_not_attend</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="n">n_unique_per_hosptial_attend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">n_unique_per_hosptial_not_attend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                        <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>

<span class="c1"># Store in dataframe</span>
<span class="n">df_hospital_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">admissions</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;admissions&quot;</span><span class="p">])</span>
<span class="n">df_hospital_details</span><span class="p">[</span><span class="s2">&quot;number_of_unique_shap_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">n_unique_per_hosptial_all_instances</span><span class="p">)</span>
<span class="n">df_hospital_details</span><span class="p">[</span><span class="s2">&quot;number_of_unique_shap_values_attend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">n_unique_per_hosptial_attend</span><span class="p">)</span>
<span class="n">df_hospital_details</span><span class="p">[</span><span class="s2">&quot;number_of_unique_shap_values_not_attend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">n_unique_per_hosptial_not_attend</span><span class="p">)</span>

<span class="n">df_hospital_details</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hospital_names</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot 1: Admissions vs number of unique SHAP values</span>
<span class="c1">#   All instances contributing to SHAP value count</span>
<span class="n">df_hospital_details</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;admissions&quot;</span><span class="p">,</span> 
                                 <span class="n">y</span><span class="o">=</span><span class="s2">&quot;number_of_unique_shap_values&quot;</span><span class="p">)</span>

<span class="c1"># Plot 2: Admissions vs number of unique SHAP values</span>
<span class="c1">#   Only instances that attend hosptial contributing to SHAP value count</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">df_hospital_details</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;admissions&quot;</span><span class="p">,</span> 
                                      <span class="n">y</span><span class="o">=</span><span class="s2">&quot;number_of_unique_shap_values_attend&quot;</span><span class="p">)</span>
<span class="c1"># Include x = y line (shows the max number of of unique values)</span>
<span class="n">max_axis_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_axis_value</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_axis_value</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>

<span class="c1"># Plot 3: Admissions vs number of unique SHAP values</span>
<span class="c1">#   Only instances that do not attend hosptial contributing to SHAP value count</span>
<span class="n">df_hospital_details</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;admissions&quot;</span><span class="p">,</span>
                                 <span class="n">y</span><span class="o">=</span><span class="s2">&quot;number_of_unique_shap_values_not_attend&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;admissions&#39;, ylabel=&#39;number_of_unique_shap_values_not_attend&#39;&gt;
</pre></div>
</div>
<img alt="../_images/a856e1dbbcc5cc5191b3dd6fc7aa939b2e6d64c109a2da65ef6573bbdb2f0137.png" src="../_images/a856e1dbbcc5cc5191b3dd6fc7aa939b2e6d64c109a2da65ef6573bbdb2f0137.png" />
<img alt="../_images/5b0b3222241a5d5525f3ab38c18614d2bb62296bb6b39a6d8a1a765d019e3db6.png" src="../_images/5b0b3222241a5d5525f3ab38c18614d2bb62296bb6b39a6d8a1a765d019e3db6.png" />
<img alt="../_images/7c2e6a14dddca50971b0f9321530bd1093a69a06a83e9602811d304fdbdc2f1b.png" src="../_images/7c2e6a14dddca50971b0f9321530bd1093a69a06a83e9602811d304fdbdc2f1b.png" />
</div>
</div>
<p>Let’s look at a hospital with the most unique values</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">row_index</span> <span class="o">=</span> <span class="n">df_hospital_details</span><span class="p">[</span><span class="s2">&quot;number_of_unique_shap_values&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="n">stroke_team_max_n_unique</span> <span class="o">=</span> <span class="n">df_hospital_details</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hospital </span><span class="si">{</span><span class="n">stroke_team_max_n_unique</span><span class="si">}</span><span class="s2"> has &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df_hospital_details</span><span class="p">[</span><span class="s1">&#39;number_of_unique_shap_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2"> &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;unique values&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hospital AKCGO9726K has 82921 unique values
</pre></div>
</div>
</div>
</div>
<p>Look at descriptive stats for this hospital</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">stroke_team_max_n_unique</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    88792.000000
mean        -0.002248
std          0.082680
min         -0.294640
25%         -0.015132
50%         -0.008884
75%         -0.003960
max          2.055953
Name: AKCGO9726K, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>What’s the difference between the SHAP value for this hospital for the instances that attended it, compared to those instances that didn’t?</p>
<p>Colour histogram bars to represent: Green for positive SHAP value, Grey for 0, and Red for negative SHAP value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_histogram_with_colours</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    data [DataFrame]: Single column of data containing values in the histogram</span>
<span class="sd">    bins [int]: Width of each histogram bar</span>
<span class="sd">    ax [object]: Matplotlib axes object</span>
<span class="sd">    </span>
<span class="sd">    Histogram bars are:</span>
<span class="sd">        green if positive value</span>
<span class="sd">        black if spans zero</span>
<span class="sd">        red if negative value</span>
<span class="sd">    </span>
<span class="sd">    Function return matplotlib axes object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">N</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
                               <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stroke_team</span> <span class="o">=</span> <span class="n">stroke_team_max_n_unique</span>

<span class="n">mask1</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stroke_team</span>
<span class="n">shap_values_attend</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">][</span><span class="n">mask1</span><span class="p">]</span>

<span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span>
<span class="n">shap_values_not_attend</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span>

<span class="c1"># Plot histogram of SHAP values for all instances</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">create_histogram_with_colours</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">],</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of instances&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stroke_team</span><span class="si">}</span><span class="s2">. Number of unique values for all patients (attended or &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;not): </span><span class="si">{</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of patients </span><span class="si">{</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">stroke_team</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span>

<span class="c1"># Plot histogram of SHAP values for instances attend hospital</span>
<span class="n">mask1</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">*</span> <span class="mi">1</span>
<span class="n">s1</span> <span class="o">=</span> <span class="n">mask1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">create_histogram_with_colours</span><span class="p">(</span><span class="n">shap_values_attend</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of instances&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stroke_team</span><span class="si">}</span><span class="s2">. Number of unique values for those patients who &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;attended: </span><span class="si">{</span><span class="n">shap_values_attend</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of patients </span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span>

<span class="c1"># Plot histogram of SHAP values for instances not attend hospital</span>
<span class="n">mask2</span> <span class="o">=</span> <span class="n">mask2</span> <span class="o">*</span> <span class="mi">1</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">mask2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">create_histogram_with_colours</span><span class="p">(</span><span class="n">shap_values_not_attend</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of instances&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stroke_team</span><span class="si">}</span><span class="s2">. Number of unique values for those patients who do not &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;attended: </span><span class="si">{</span><span class="n">shap_values_not_attend</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of patients </span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AKCGO9726K. Number of unique values for all patients (attended or not): 82921
Number of patients 88792
AKCGO9726K. Number of unique values for those patients who attended: 1421
Number of patients 1428
AKCGO9726K. Number of unique values for those patients who do not attended: 81500
Number of patients 87364
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function matplotlib.pyplot.show(close=None, block=None)&gt;
</pre></div>
</div>
<img alt="../_images/608c1f0b7d6c639b5fd283a2bd70d1bfda9c0de4c21dd32373123faf9849c099.png" src="../_images/608c1f0b7d6c639b5fd283a2bd70d1bfda9c0de4c21dd32373123faf9849c099.png" />
<img alt="../_images/3a6d125b3cf34e314160feaca7d1e8c59d16f6fd652410080ceeafb50b5b5233.png" src="../_images/3a6d125b3cf34e314160feaca7d1e8c59d16f6fd652410080ceeafb50b5b5233.png" />
<img alt="../_images/4ca3a187df421fcab33b523f8ad09d6914dd75ceb0134ad3c32f7c753f8f5457.png" src="../_images/4ca3a187df421fcab33b523f8ad09d6914dd75ceb0134ad3c32f7c753f8f5457.png" />
</div>
</div>
<p>So there’s two populations, but in the top plot you can not see the histogram for the instances that attended the hospital, as their frequency is too few and the plot is dominated by the frequency range for the number of patients who did not attend the hosptial.</p>
<p>Those that attend have a higher SHAP value, but there’s fewer instances so can not see these values.
Those that do not attend have a low SHAP value, a smaller range of values, but far more instances, so dominates the y axis, but can not see the spread (as the other population has determines the x axis range).</p>
<p>Better to view as two populations.</p>
<p>Plot a boxplot for the SHAP values of each hospital (for all instances)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create list of values for each boxplot (one per hospital)</span>
<span class="n">stroketeam_groups</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">stroketeam_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a figure with 35 hospitals in each to aid visually</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shows the range of contributions to the prediction from this hospital &quot;</span>
      <span class="s2">&quot;for all the instances&quot;</span><span class="p">)</span>

<span class="c1"># To group the hospitals into 34</span>
<span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ed</span> <span class="o">=</span> <span class="mi">34</span>
<span class="n">inc</span> <span class="o">=</span> <span class="n">ed</span>
<span class="n">max_size</span> <span class="o">=</span> <span class="n">n_hospitals</span>

<span class="c1"># Plot properties</span>
<span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;navy&quot;</span>
<span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;navy&quot;</span>
<span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>

<span class="c1"># Create figure with 4 subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>

<span class="c1"># Create four subplots</span>
<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">stroketeam_groups</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
                <span class="n">whis</span><span class="o">=</span><span class="mi">9999999</span><span class="p">,</span> <span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
                <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
                <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
                <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
                <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Shap values of one-hot encoded feature&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ed</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shows the range of contributions to the prediction from this hospital for all the instances
</pre></div>
</div>
<img alt="../_images/264e66fcce7db1815cf50ff5a4ba106be63380c84fcf74741c835676166215dc.png" src="../_images/264e66fcce7db1815cf50ff5a4ba106be63380c84fcf74741c835676166215dc.png" />
</div>
</div>
<p>Shows that hospitals have the majority of their cases at value 0, and some have a longer range than others, with most having their range entirely on one side of 0 or the other.</p>
<p>Let’s plot it again, twice, showing only those instances that go to the hospital, and again when they do not.</p>
<p>Include instances that attend the hospital only</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create list of values for each boxplot (one per hospital), only include SHAP </span>
<span class="c1">#   value for instances that attend stroke team</span>
<span class="n">attend_stroketeam_groups</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="n">attend_stroketeam_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a figure with 35 hospitals in each to aid visually</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shows the range of contributions to the prediction from this hospital &quot;</span>
      <span class="s2">&quot;when patients attend this hosptial&quot;</span><span class="p">)</span>

<span class="c1"># To group the hospitals into 34</span>
<span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ed</span> <span class="o">=</span> <span class="mi">34</span>
<span class="n">inc</span> <span class="o">=</span> <span class="n">ed</span>
<span class="n">max_size</span> <span class="o">=</span> <span class="n">n_hospitals</span>

<span class="c1"># Plot properties</span>
<span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>

<span class="c1"># Create figure with 4 subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>

<span class="c1"># Create four subplots</span>
<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">attend_stroketeam_groups</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">labels</span><span class="o">=</span><span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">whis</span><span class="o">=</span><span class="mi">999999</span><span class="p">,</span><span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Shap values of one-hot encoded feature&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ed</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shows the range of contributions to the prediction from this hospital when patients attend this hosptial
</pre></div>
</div>
<img alt="../_images/f3df744667178e9ea1470fea8ab587cc420cd7983b4c61f887b269177cbee6f6.png" src="../_images/f3df744667178e9ea1470fea8ab587cc420cd7983b4c61f887b269177cbee6f6.png" />
</div>
</div>
<p>Edit data so only contains instances when not go to hospital</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only include SHAP value for instances that do not attend stroke team</span>
<span class="n">not_attend_stroketeam_groups</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">h</span>
    <span class="n">not_attend_stroketeam_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a figure with 35 hospitals in each to aid visually</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shows the range of contributions to the prediction from this hospital &quot;</span>
      <span class="s2">&quot;when patients do not attend this hosptial&quot;</span><span class="p">)</span>

<span class="c1"># To group the hospitals into 34</span>
<span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ed</span> <span class="o">=</span> <span class="mi">34</span>
<span class="n">inc</span> <span class="o">=</span> <span class="n">ed</span>
<span class="n">max_size</span> <span class="o">=</span> <span class="n">n_hospitals</span>

<span class="c1"># Plot properties</span>
<span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
<span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
<span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
 
<span class="c1"># Create figure with 4 subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>

<span class="c1"># Create four subplots</span>
<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">not_attend_stroketeam_groups</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">labels</span><span class="o">=</span><span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">whis</span><span class="o">=</span><span class="mi">999999</span><span class="p">,</span><span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Shap values of one-hot encoded feature&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ed</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shows the range of contributions to the prediction from this hospital when patients do not attend this hosptial
</pre></div>
</div>
<img alt="../_images/9d0e768cec5e4809e05e7850f5d5890b50b9018787bd5f4d7b8a1cb7b4a01f88.png" src="../_images/9d0e768cec5e4809e05e7850f5d5890b50b9018787bd5f4d7b8a1cb7b4a01f88.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Two box plots on 1 plot (spread of SHAP when instance attend, and not attend, </span>
<span class="c1">#   hospital)</span>

<span class="c1"># Create a figure with 35 hospitals in each to aid visually</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shows the range of contributions to the prediction from this hospital &quot;</span>
      <span class="s2">&quot;when patients 1) do [black], and 2) do not [orange] attend this &quot;</span>
      <span class="s2">&quot;hosptial&quot;</span><span class="p">)</span>

<span class="c1"># To group the hospitals into 34</span>
<span class="n">st</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ed</span> <span class="o">=</span> <span class="mi">34</span>
<span class="n">inc</span> <span class="o">=</span> <span class="n">ed</span>
<span class="n">max_size</span> <span class="o">=</span> <span class="n">n_hospitals</span>

<span class="c1"># Create figure with 4 subplots</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>

<span class="c1"># Create four subplots</span>
<span class="k">for</span> <span class="n">subplot</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># The contribution from this hospital when patients do not attend this </span>
    <span class="c1">#   hosptial</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">not_attend_stroketeam_groups</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">labels</span><span class="o">=</span><span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span><span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>
        
    <span class="c1"># The contribution from this hospital when patients do attend this hosptial</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">attend_stroketeam_groups</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">labels</span><span class="o">=</span><span class="n">df_hosp_shap_values</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">],</span>
               <span class="n">whis</span><span class="o">=</span><span class="mi">99999</span><span class="p">,</span><span class="n">patch_artist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">notch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">capprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">whiskerprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">flierprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">c1</span><span class="p">),</span>
               <span class="n">meanprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SHAP values of one-hot encoded feature&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">st</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ed</span><span class="o">+</span><span class="n">inc</span><span class="p">,</span><span class="n">max_size</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shows the range of contributions to the prediction from this hospital when patients 1) do [black], and 2) do not [orange] attend this hosptial
</pre></div>
</div>
<img alt="../_images/825b4d8fa61203f1f41351a2a8ac0f2beca0dfd729c64610c49dc071bf909737.png" src="../_images/825b4d8fa61203f1f41351a2a8ac0f2beca0dfd729c64610c49dc071bf909737.png" />
</div>
</div>
<p>Does it help understanding to represent this as histograms?</p>
<p>Create three matrix of histograms.</p>
<ul class="simple">
<li><p>One with all the instances to each hosptial</p></li>
<li><p>One with just the instances that attend each hosptial</p></li>
<li><p>One with just the instances that don’t attend each hosptial.</p></li>
</ul>
<p>One with all the instances to each hosptial (forcing same axis ranges)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the largest value used for the y axis in all of the histograms in the </span>
<span class="c1">#   subplots (use this to set the max for each subplot)</span>
<span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">x_min</span> <span class="o">=</span> <span class="mi">99</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="c1"># Plot histogram</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">])</span>
    <span class="c1"># Get axis limits</span>
    <span class="n">ylims</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="c1"># Store if greater than found so far</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Get axis limits</span>
    <span class="n">xlims</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="c1"># Store if greater than found so far</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># Don&#39;t display plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># Define width of histogram bins based on the x axis range</span>
<span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">/</span><span class="mi">20</span>

<span class="c1"># Setup figure with subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> 
    <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
    <span class="n">create_histogram_with_colours</span><span class="p">(</span><span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">bin_width</span><span class="p">),</span>
            <span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP value for </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of instances&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">y_max</span><span class="o">*</span><span class="mf">1.1</span><span class="p">))</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Define figure display</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="c1">#plt.tight_layout(pad=2)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b1a71a854f16e36d1d2bd0343e8489a2a7a16eda71be9c794786eca48753f5da.png" src="../_images/b1a71a854f16e36d1d2bd0343e8489a2a7a16eda71be9c794786eca48753f5da.png" />
</div>
</div>
<p>One with just the instances that attend each hosptial</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup figure with subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> 
    <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">X_combined</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span> <span class="c1">#drop &quot;team_&quot;</span>
    <span class="n">shap_values_not_attend</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="n">shap_values_not_attend</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
    <span class="n">create_histogram_with_colours</span><span class="p">(</span><span class="n">shap_values_not_attend</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="c1">#    ax.hist(shap_values_not_attend, bins=20)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP value for </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of instances </span><span class="se">\n</span><span class="s2">(not attend hosptial)&quot;</span><span class="p">)</span>
<span class="c1">#    ax.set_ylim(0, y_max)</span>
<span class="c1">#    ax.set_xlim(x_min, x_max)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="c1">#plt.tight_layout(pad=2)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6561d60f306673c3002bbfa834eb01adfcf99ef7a66458c6cd1551ed25f798e2.png" src="../_images/6561d60f306673c3002bbfa834eb01adfcf99ef7a66458c6cd1551ed25f798e2.png" />
</div>
</div>
<p>One with just the instances that don’t attend each hosptial.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup figure with subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> 
    <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">X_combined</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span> <span class="c1">#drop &quot;team_&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="c1"># Those that didn&#39;t attend</span>
    <span class="n">shap_values_not_attend</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="n">shap_values_not_attend</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
    <span class="n">create_histogram_with_colours</span><span class="p">(</span><span class="n">shap_values_not_attend</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<span class="c1">#    ax.hist(shap_values_not_attend, bins=20)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP value for </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of instances </span><span class="se">\n</span><span class="s2">(not attend hosptial)&quot;</span><span class="p">)</span>
<span class="c1">#    ax.set_ylim(0, y_max)</span>
<span class="c1">#    ax.set_xlim(x_min, x_max)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="c1">#plt.tight_layout(pad=2)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ad1299caebac8d2049ad658f436bca6e5dc268ba5947c3482c33d525e05a84c6.png" src="../_images/ad1299caebac8d2049ad658f436bca6e5dc268ba5947c3482c33d525e05a84c6.png" />
</div>
</div>
<p>Code showing the same histograms, with each having the same x axis range and y axis range</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the largest value used for the y axis in all of the histograms in the </span>
<span class="c1">#   subplots (use this to set the max for each subplot)</span>
<span class="n">y_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">x_min</span> <span class="o">=</span> <span class="mi">99</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="c1"># mask data for those that attend hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="c1"># Those that didn&#39;t attend</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">shap_values_attend</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="n">shap_values_attend</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="c1"># Plot histogram</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">shap_values_attend</span><span class="p">)</span>
    <span class="c1"># Get axis limits</span>
    <span class="n">ylims</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="c1"># Store if greater than found so far</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_max</span><span class="p">,</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Get axis limits</span>
    <span class="n">xlims</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="c1"># Store if greater than found so far</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># Don&#39;t display plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># Define width of histogram bins based on the x axis range</span>
<span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">/</span><span class="mi">20</span>

<span class="c1"># Setup figure with subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> 
    <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hospital_names</span><span class="p">:</span>
    <span class="c1"># mask data for those that attend hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="c1"># Those that didn&#39;t attend</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">shap_values_attend</span> <span class="o">=</span> <span class="n">df_hosp_shap_values</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="n">shap_values_attend</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="c1"># Plot histogram</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">shap_values_attend</span><span class="p">,</span> 
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">bin_width</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP value for </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">n_unique</span><span class="si">}</span><span class="s2"> unique values)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of instances&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">y_max</span><span class="o">*</span><span class="mf">1.1</span><span class="p">))</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Define figure display</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="c1">#plt.tight_layout(pad=2)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/56d6681dce89ac054f6088732a7ed2674da9ac21c52395ba95395c80a726e48b.png" src="../_images/56d6681dce89ac054f6088732a7ed2674da9ac21c52395ba95395c80a726e48b.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./xgb_10_features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="03a_xgb_all_data_shap_values_vs_feature_values.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fit a single XGBoost model and calculate the SHAP values</p>
      </div>
    </a>
    <a class="right-next"
       href="03c_xgb_all_data_shap_interaction_values_focus_on_ohe_hospitals.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Explore the hospital effect on thrombolysis use, using SHAP main effects from a single XGBoost model</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Explore the hospital effect on thrombolysis use, using SHAP values from a single XGBoost model</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plain-english-summary">Plain English summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-data">Model and data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aims">Aims</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-filenames">Set filenames</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-output-folders-if-needed">Create output folders if needed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-json-file">Read in JSON file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-list-of-feature-names">Get list of feature names</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edit-data">Edit data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">Divide into X (features) and y (labels)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encode-hospital-feature">One-hot encode hospital feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-model-feature-names">Get model feature names</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost-model">XGBoost model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-shap-values">Get SHAP values</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#understand-shap-values-for-the-one-hot-encoded-hospital-features">Understand SHAP values for the one-hot encoded hospital features</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#format-the-data">Format the data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#boxplot-all-hospitals-together">Boxplot (all hospitals together)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#boxplot-individual-hospitals">Boxplot (individual hospitals)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extra-code">Extra code</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Kerry Pearn, Michael Allen, Anna Laws, Richard Everson, and Martin James
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>