

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>How much of the variation in the hosptials thrombolysis rate can be attributed to the difference in the hospital processes, and to different patient populations? &#8212; SAMueL - Stroke Audit Machine Learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'xgb_10_features/03e_xgb_shap_value_and_main_effect_regressions_on_hospital_ivt_rate';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Calculate and use subset SHAP values (from a single XGBoost model) to attribute hospital IVT variation to patient mix and hospital processes" href="03f_xgb_subset_shap_value_regressions_on_hospital_ivt_rate.html" />
    <link rel="prev" title="Explore the hospital effect on thrombolysis use, using SHAP values and SHAP main effects from a single XGBoost model" href="03d_xgb_all_data_shap_values_and_interaction_values_focus_on_ohe_hospitals.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../introduction/intro.html">
  
  
  
  
  
    <p class="title logo__title">SAMueL - Stroke Audit Machine Learning</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/intro.html">
                    What would other emergency stroke teams do? Using explainable machine learning to understand variation in thrombolysis practice
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introductory content</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/glossary.html">Glossary of technical terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/odds_prob.html">Probability, odds, and SHAP values (log odds shifts)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/shap_worked_example.html">A simple worked example of Shap</a></li>
<li class="toctree-l1"><a class="reference internal" href="90_shap_interactions_on_titanic.html">Examining interactions between features with SHAP interactions: Using Titanic survival as an example</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Predicting thrombolysis use and explaining the predictions with Shap</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="91_learning_rate_optimisation.html">Evaluation of XGBoost learning rates on distribution of 10k thrombolysis rates</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_xgb_combined_fit_feature_selection.html">XGBoost feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_correlation.html">Check correlation between features selected for the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_xgb_combined_fit_accuracy_key_features.html">Measuring accuracy of XGBoost models</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_xgb_combined_shap_key_features.html">Explaining XGBoost model predictions with SHAP values</a></li>
<li class="toctree-l1"><a class="reference internal" href="03a_xgb_all_data_shap_values_vs_feature_values.html">Fit a single XGBoost model and calculate the SHAP values</a></li>
<li class="toctree-l1"><a class="reference internal" href="03b_xgb_all_data_shap_values_focus_on_ohe_hospitals.html">Explore the hospital effect on thrombolysis use, using SHAP values from a single XGBoost model</a></li>

<li class="toctree-l1"><a class="reference internal" href="03c_xgb_all_data_shap_interaction_values_focus_on_ohe_hospitals.html">Explore the hospital effect on thrombolysis use, using SHAP main effects from a single XGBoost model</a></li>

<li class="toctree-l1"><a class="reference internal" href="03d_xgb_all_data_shap_values_and_interaction_values_focus_on_ohe_hospitals.html">Explore the hospital effect on thrombolysis use, using SHAP values and SHAP main effects from a single XGBoost model</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">How much of the variation in the hosptials thrombolysis rate can be attributed to the difference in the hospital processes, and to different patient populations?</a></li>
<li class="toctree-l1"><a class="reference internal" href="03f_xgb_subset_shap_value_regressions_on_hospital_ivt_rate.html">Calculate and use <em>subset</em> SHAP values (from a single XGBoost model) to attribute hospital IVT variation to patient mix and hospital processes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Using a 10k cohort of patients to compare decision-making</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="04_xgb_10k_cohort_key_features.html">A comparison of 10k cohort thrombolysis rates across hospitals</a></li>
<li class="toctree-l1"><a class="reference internal" href="04a_xgb_10k_cohort_shap_values_interaction_values.html">A comparison of hospital SHAP values and SHAP main effect values for the 10k cohort.</a></li>
<li class="toctree-l1"><a class="reference internal" href="04b_xgb_10k_cohort_thrombolysis_subgroups.html">A comparison of expected 10k cohort thrombolysis rates across hospitals: subgroup analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="04c_xgb_10k_cohort%E2%80%8B_vs_observed_thrombolysis_subgroups.html">A comparison of actual thrombolysis rates across hospitals: subgroup analysis</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/xgb_10_features/03e_xgb_shap_value_and_main_effect_regressions_on_hospital_ivt_rate.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>How much of the variation in the hosptials thrombolysis rate can be attributed to the difference in the hospital processes, and to different patient populations?</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plain-english-summary">Plain English summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-data">Model and data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aims">Aims</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-filenames">Set filenames</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-output-folders-if-needed">Create output folders if needed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-json-file">Read in JSON file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-list-of-feature-names">Get list of feature names</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edit-data">Edit data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">Divide into X (features) and y (labels)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encode-hospital-feature">One-hot encode hospital feature</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost-model">XGBoost model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-shap-values">Get SHAP values</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-the-shap-value-for-patient-features-compare-to-the-thrombolysis-rate-of-the-hospital">How does the SHAP value for patient features compare to the thrombolysis rate of the hospital?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-regressions-to-processed-data">Fit regressions to processed data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-regression-of-each-feature-vs-hosptial-thrombolysis-rate">Linear regression of each feature vs. hosptial thrombolysis rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-all-features-vs-ivt-rate">Multiple regression on all features vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-features-excluding-attended-hosptial-vs-ivt-rate">Multiple regression on features (excluding attended hosptial) vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-just-patient-characteristics-vs-ivt-rate">Multiple regression on just patient characteristics vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-just-hospital-processes-vs-ivt-rate">Multiple regression on just hospital processes vs IVT rate</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#repeat-using-shap-main-effect">Repeat using SHAP main effect</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-shap-interaction-values">Get SHAP interaction values</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Linear regression of each feature vs. hosptial thrombolysis rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Multiple regression on all features vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Multiple regression on features (excluding attended hosptial) vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Multiple regression on just patient characteristics vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Multiple regression on just hospital processes vs IVT rate</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="how-much-of-the-variation-in-the-hosptials-thrombolysis-rate-can-be-attributed-to-the-difference-in-the-hospital-processes-and-to-different-patient-populations">
<h1>How much of the variation in the hosptials thrombolysis rate can be attributed to the difference in the hospital processes, and to different patient populations?<a class="headerlink" href="#how-much-of-the-variation-in-the-hosptials-thrombolysis-rate-can-be-attributed-to-the-difference-in-the-hospital-processes-and-to-different-patient-populations" title="Permalink to this heading">#</a></h1>
<section id="plain-english-summary">
<h2>Plain English summary<a class="headerlink" href="#plain-english-summary" title="Permalink to this heading">#</a></h2>
<p>When fitting a machine learning model to data to make a prediction, it is now possible, with the use of the SHAP library, to allocate contributions of the prediction onto the feature values. This means that we can now turn these black box methods into transparent models and describe what the model used to obtain it’s prediction.</p>
<p>SHAP values are calculated for each feature of each instance for a fitted model. In addition there is the SHAP base value which is the same value for all of the instances. The base value represents the models best guess for any instance without any extra knowledge about the instance (this can also be thought of as the “expected value”). It is possible to obtain the models prediction of an instance by taking the sum of the SHAP base value and each of the SHAP values for the features. This allows the prediction from a model to be transparant, and we can rank the features by their importance in determining the prediction for each instance.</p>
<p>The SHAP values for each feature are comprised of the feature’s main effect (what is due to the feature value, the standalone effect) and all of the pairwise interaction effects with each of the other features (a value per feature pairings).</p>
<p>In this notebook we will use the single model fitted to all of the data, no test set (from notebook 03a) and focus on understanding the amount of variance in hospital IVT that is captured in feature SHAP values (from notebook 03a) and SHAP main effects (from notebook 03c) using linear regressions and multiple linear regressions.</p>
<p>SHAP values are in the same units as the model output (for XGBoost these are in log odds).</p>
<p>Here we read in an already fitted XGBoost model to the SAMueL dataset (and the SHAP values), to predict whether a patient recieves thrombolysis from the values of 10 features, using all data to train (no test set). We explore the relationship between SHAP values and SHAP main effect and the hospital IVT rate.</p>
<p>We find that thrombolysis rate may be well predicted from just the average main effect SHAP values for each feature at each hospital. Hospital ID and hopsital processes (arrival-to-scan time) explain the majority (at least two thirds) of the between-hospital variation in thrombolysis use. Patient characteristics at each hopsital explain about one third of the variation in thrombolysis use.</p>
</section>
<section id="model-and-data">
<h2>Model and data<a class="headerlink" href="#model-and-data" title="Permalink to this heading">#</a></h2>
<p>Using the XGBoost model trained on all of the data (no test set used) from notebook 03a_xgb_combined_shap_key_features.ipynb. The 10 features in the model are:</p>
<ul class="simple">
<li><p>Arrival-to-scan time: Time from arrival at hospital to scan (mins)</p></li>
<li><p>Infarction: Stroke type (1 = infarction, 0 = haemorrhage)</p></li>
<li><p>Stroke severity: Stroke severity (NIHSS) on arrival</p></li>
<li><p>Precise onset time: Onset time type (1 = precise, 0 = best estimate)</p></li>
<li><p>Prior disability level: Disability level (modified Rankin Scale) before stroke</p></li>
<li><p>Stroke team: Stroke team attended</p></li>
<li><p>Use of AF anticoagulents: Use of atrial fibrillation anticoagulant (1 = Yes, 0 = No)</p></li>
<li><p>Onset-to-arrival time: Time from onset of stroke to arrival at hospital (mins)</p></li>
<li><p>Onset during sleep: Did stroke occur in sleep?</p></li>
<li><p>Age: Age (as middle of 5 year age bands)</p></li>
</ul>
<p>And one target feature:</p>
<ul class="simple">
<li><p>Thrombolysis: Did the patient receive thrombolysis (0 = No, 1 = Yes)</p></li>
</ul>
</section>
<section id="aims">
<h2>Aims<a class="headerlink" href="#aims" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Using XGBoost model fitted on all the data (no test set) using 10 features</p></li>
<li><p>Using SHAP values previously calculated</p></li>
<li><p>Understand the amount of variance in hospital IVT that is captured in feature SHAP values and SHAP main effects (using regressions and multiple regressions)</p></li>
<li><p>Divide the features into two groups: patient features and hosptial features</p></li>
</ul>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this heading">#</a></h2>
<p>Mean SHAP values, including interactions, for patients attending each hopsital explain 93% of between-hospital variation in thrombolysis rate. The mean main effect SHAP values at each hopsital explain 94% of between-hospital variation in thrombolysis rate.</p>
<p>Stroke team ID and processes (arrival-to scan time) explained 75% of the between-hopsital variation in thrombolysis. Combining patient characteristics explained 34% of the between-hopsital variation in thrombolysis.</p>
<p>It is perhaps a little suprising that thrombolysis rate may be so welll predicted just from average SHAP feature values at each hopsital.</p>
<p>When examining average feature SHAP effects (main effect only) for each team, the three features that most explain variation in thrombolysis rates were mean SHAP values for:</p>
<ul class="simple">
<li><p>Stroke team (r-squared = 0.56)</p></li>
<li><p>Arrival-to-scan time (r-squared = 0.24)</p></li>
<li><p>Stroke severity  (r-squared = 0.12)</p></li>
</ul>
</section>
<section id="import-libraries">
<h2>Import libraries<a class="headerlink" href="#import-libraries" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Import machine learning methods</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="c1"># Import shap for shapley values</span>
<span class="kn">import</span> <span class="nn">shap</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># .floor and .ceil</span>
<span class="kn">import</span> <span class="nn">math</span> 

<span class="c1"># So can take deep copy</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-filenames">
<h2>Set filenames<a class="headerlink" href="#set-filenames" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up strings (describing the model) to use in filenames</span>
<span class="n">number_of_features_to_use</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xgb_</span><span class="si">{</span><span class="n">number_of_features_to_use</span><span class="si">}</span><span class="s1">_features&#39;</span>
<span class="n">notebook</span> <span class="o">=</span> <span class="s1">&#39;03e&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-output-folders-if-needed">
<h2>Create output folders if needed<a class="headerlink" href="#create-output-folders-if-needed" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./saved_models&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./output&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./predictions&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-json-file">
<h2>Read in JSON file<a class="headerlink" href="#read-in-json-file" title="Permalink to this heading">#</a></h2>
<p>Contains a dictionary for plain English feature names for the 8 features selected in the model. Use these as the column titles in the DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./output/01_feature_name_dict.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">dict_feature_name</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this heading">#</a></h2>
<p>Data has previously been split into 5 stratified k-fold splits.</p>
<p>The model used in this notebook is fitted using all of the data (rather than train/test splits used to assess accuracy). We will join up all of the test data (by definition, each instance exists only once across all of the 5 test sets)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;../data/kfold_5fold/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise empty list</span>
<span class="n">test_data_kfold</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Read in the names of the selected features for the model</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./output/01_feature_selection.csv&#39;</span><span class="p">)</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])[:</span><span class="n">number_of_features_to_use</span><span class="p">]</span>
<span class="c1"># And add the target feature name: S2Thrombolysis</span>
<span class="n">key_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">)</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Read in test set, restrict to chosen features, rename titles, &amp; store</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;test_</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">key_features</span><span class="p">]</span>
    <span class="n">test</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dict_feature_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_data_kfold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="c1"># Join all the test sets. Set &quot;ignore_index = True&quot; to reset the index in the</span>
<span class="c1">#   new dataframe (to run from 0 to n-1), otherwise get duplicate index values</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">test_data_kfold</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-list-of-feature-names">
<h2>Get list of feature names<a class="headerlink" href="#get-list-of-feature-names" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_data_kfold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="edit-data">
<h2>Edit data<a class="headerlink" href="#edit-data" title="Permalink to this heading">#</a></h2>
<section id="divide-into-x-features-and-y-labels">
<h3>Divide into X (features) and y (labels)<a class="headerlink" href="#divide-into-x-features-and-y-labels" title="Permalink to this heading">#</a></h3>
<p>We will separate out our features (the data we use to make a prediction) from our label (what we are trying to predict).
By convention our features are called <code class="docutils literal notranslate"><span class="pre">X</span></code> (usually upper case to denote multiple features), and the label (thrombolysis or not) <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Average thromboylsis (this is the expected outcome of each patient, without knowing anything about the patient)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average treatment: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average treatment: 0.3
</pre></div>
</div>
</div>
</div>
</section>
<section id="one-hot-encode-hospital-feature">
<h3>One-hot encode hospital feature<a class="headerlink" href="#one-hot-encode-hospital-feature" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Keep copy of original, with &#39;Stroke team&#39; not one-hot encoded</span>
<span class="n">X_combined</span> <span class="o">=</span> <span class="n">X_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># One-hot encode &#39;Stroke team&#39;</span>
<span class="n">X_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_data</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
<span class="n">X_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_data</span><span class="p">,</span> <span class="n">X_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get feature names</span>
<span class="n">feature_names_ohe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="xgboost-model">
<h2>XGBoost model<a class="headerlink" href="#xgboost-model" title="Permalink to this heading">#</a></h2>
<p>An XGBoost model was trained on the full dataset (rather than train/test splits used to assess accuracy) in notebook 03a. These models are saved f’./saved_models/03a_{model_text}.p’.</p>
</section>
<section id="get-shap-values">
<h2>Get SHAP values<a class="headerlink" href="#get-shap-values" title="Permalink to this heading">#</a></h2>
<p>SHAP values give the contribution that each feature has on the models prediction, per instance. A SHAP value is returned for each feature, for each instance.</p>
<p>‘Raw’ SHAP values from XGBoost model are log odds ratios.</p>
<p>In notebook 03a we used the TreeExplainer from the shap library (https://shap.readthedocs.io/en/latest/index.html) to calculate the SHAP values. This is a fast and exact method to estimate SHAP values for tree models and ensembles of tree.</p>
<p>Load SHAP values from pickle (calculated in notebook 03a).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03a_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_values_extended.p&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
    <span class="n">shap_values_extended</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The explainer returns the base value which is the same value for all instances [shap_value.base_values], the shap values per feature [shap_value.values]. It also returns the feature dataset values [shap_values.data]. You can (sometimes!) access the feature names from the explainer [explainer.data_feature_names].</p>
<p>Let’s take a look at the data held for the first instance:</p>
<ul class="simple">
<li><p>.values has the SHAP value for each of the four features.</p></li>
<li><p>.base_values has the best guess value without knowing anything about the instance.</p></li>
<li><p>.data has each of the feature values</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_values_extended</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.values =
array([ 7.56502628e-01,  4.88319576e-01,  1.10273695e+00,  4.40223962e-01,
        4.98975307e-01,  2.02812225e-01, -2.62601525e-01,  3.69181409e-02,
        2.30234995e-01,  3.20923195e-04, -6.03703642e-03, -7.17267860e-04,
        0.00000000e+00, -4.91688668e-04,  1.20360847e-03,  1.77788886e-03,
       -4.34198463e-03, -2.76021136e-04, -2.79896380e-03,  3.52182891e-03,
       -2.73969141e-04,  8.53505917e-03, -5.28220041e-03, -8.25227005e-04,
        6.20208494e-03,  6.92215608e-03, -6.32244349e-03, -3.35367222e-04,
        7.81939551e-03, -4.71850217e-06, -4.25534381e-05,  6.48253039e-03,
        8.43156071e-04, -6.28353562e-04, -1.25156669e-02, -7.92063680e-03,
       -1.99409085e-03, -5.05548809e-03, -3.90118686e-03,  1.30317558e-03,
        0.00000000e+00, -6.48246554e-04,  1.19629130e-03,  8.26304778e-04,
        1.28053436e-02,  2.55714403e-03, -3.20375757e-03,  4.23251512e-03,
       -7.19791185e-03,  4.02670400e-03,  3.75146419e-03,  8.31848301e-04,
        3.45067866e-03,  3.92199913e-03,  1.05317042e-04,  9.53648426e-03,
        2.34490633e-03, -1.05699897e-03, -7.75758363e-03,  1.09220366e-03,
        0.00000000e+00,  5.15310653e-03, -1.28013985e-02,  7.28079583e-03,
        1.98326469e-03,  2.40865033e-04,  6.70310017e-03,  1.18395500e-03,
        8.82393331e-04,  2.83133984e-03,  2.06021918e-03, -8.22589453e-03,
        5.11038816e-03, -3.25066457e-03, -1.15480982e-02,  9.36000666e-04,
        2.03671609e-03, -2.02708528e-03, -5.31264208e-03,  2.42300611e-03,
        3.16989725e-04,  3.67143471e-03, -5.07418578e-03, -2.68517504e-03,
        3.30522249e-04, -6.63852552e-03, -1.63316587e-03,  1.75383547e-03,
       -4.12231544e-03,  1.20234396e-03, -6.25999365e-03,  0.00000000e+00,
       -1.00428164e-02, -1.76329317e-03,  3.12283775e-03,  4.69124934e-04,
       -1.22163491e-03,  2.30912305e-03,  9.43152234e-04,  1.22348359e-03,
        5.29656609e-05, -9.66969132e-03,  3.44762520e-06, -5.46710449e-04,
        4.26546484e-03,  4.65912558e-03,  1.30611981e-04, -2.89813057e-03,
       -2.98934802e-03, -1.47398096e-03, -2.31104009e-02, -3.47609469e-03,
       -5.73671749e-03,  3.97895870e-04,  9.02379164e-04, -5.86819311e-04,
       -1.79305486e-03, -5.28960605e-04, -2.10736915e-02,  3.50499223e-03,
       -2.04754542e-04, -2.86527374e-03,  1.52953295e-03, -3.72403156e-06,
        1.42271689e-03, -2.97368824e-04,  5.06201060e-04,  5.77868486e-04,
       -1.44459037e-02,  3.30785802e-03, -2.37809308e-03, -7.35214865e-03,
        3.36531224e-03,  1.49519066e-03, -2.46208580e-03,  7.20066251e-04,
        6.83251710e-04, -1.92034326e-03,  2.39002449e-03, -8.96935933e-04,
        4.85493708e-03], dtype=float32)

.base_values =
-1.1629876

.data =
array([ 17. ,   1. ,  14. ,   1. ,   0. ,   0. , 186. ,   0. ,  47.5,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   1. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ])
</pre></div>
</div>
</div>
</div>
<section id="how-does-the-shap-value-for-patient-features-compare-to-the-thrombolysis-rate-of-the-hospital">
<h3>How does the SHAP value for patient features compare to the thrombolysis rate of the hospital?<a class="headerlink" href="#how-does-the-shap-value-for-patient-features-compare-to-the-thrombolysis-rate-of-the-hospital" title="Permalink to this heading">#</a></h3>
<p>Create dataframe containing the hospital’s IVT rate and mean SHAP value for each feature (for those patients that attend the hospital).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get SHAP values</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_values_extended</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Get list of unique stroke team names</span>
<span class="n">unique_stroketeams_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate IVT rate per hosptial</span>
<span class="n">df_hosp_ivt_rate</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s2">&quot;Thrombolysis&quot;</span><span class="p">]</span>
<span class="n">df_hosp_ivt_rate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Stroke team
AGNOF1041H    0.352468
AKCGO9726K    0.369748
AOBTM3098N    0.218803
APXEE8191H    0.226481
ATDID5461S    0.240385
                ...   
YPKYH1768F    0.246057
YQMZV4284N    0.236170
ZBVSO0975W    0.250000
ZHCLE1578P    0.223639
ZRRCV7012C    0.157670
Name: Thrombolysis, Length: 132, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create dataframe with hospital as index, column per feature, containing</span>
<span class="c1"># mean SHAP value for feature for patients that attend that hospital</span>

<span class="c1"># Initialise list</span>
<span class="n">mean_values_hosp</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">unique_stroketeams_list</span><span class="p">:</span>
<span class="c1">#    calculate mean SHAP for the patients that attend hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="n">mean_values_hosp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">df_mean_shap_values_per_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mean_values_hosp</span><span class="p">,</span> 
                                            <span class="n">index</span><span class="o">=</span><span class="n">unique_stroketeams_list</span><span class="p">,</span>
                                            <span class="n">columns</span><span class="o">=</span><span class="n">feature_names_ohe</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_shap_values_per_hosp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
      <th>team_AGNOF1041H</th>
      <th>...</th>
      <th>team_XKAWN3771U</th>
      <th>team_XPABC1435F</th>
      <th>team_XQAGA4299B</th>
      <th>team_XWUBX0795L</th>
      <th>team_YEXCH8391J</th>
      <th>team_YPKYH1768F</th>
      <th>team_YQMZV4284N</th>
      <th>team_ZBVSO0975W</th>
      <th>team_ZHCLE1578P</th>
      <th>team_ZRRCV7012C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AOBTM3098N</th>
      <td>-0.706683</td>
      <td>-0.827253</td>
      <td>-0.164386</td>
      <td>0.023894</td>
      <td>0.008445</td>
      <td>-0.062407</td>
      <td>-0.079294</td>
      <td>-0.094993</td>
      <td>-0.040437</td>
      <td>0.001599</td>
      <td>...</td>
      <td>-0.008356</td>
      <td>0.003196</td>
      <td>0.002574</td>
      <td>-0.002853</td>
      <td>0.000365</td>
      <td>0.000367</td>
      <td>-0.001572</td>
      <td>0.002756</td>
      <td>-0.001949</td>
      <td>0.003640</td>
    </tr>
    <tr>
      <th>QQUVD2066Z</th>
      <td>0.136372</td>
      <td>-0.980927</td>
      <td>-0.131322</td>
      <td>0.193710</td>
      <td>-0.059096</td>
      <td>-0.078017</td>
      <td>-0.043302</td>
      <td>0.027973</td>
      <td>-0.029430</td>
      <td>0.001890</td>
      <td>...</td>
      <td>-0.006836</td>
      <td>0.002609</td>
      <td>0.003206</td>
      <td>-0.004560</td>
      <td>0.000569</td>
      <td>0.000358</td>
      <td>-0.001619</td>
      <td>0.002432</td>
      <td>-0.002055</td>
      <td>0.002883</td>
    </tr>
    <tr>
      <th>JHDQL1362V</th>
      <td>-0.402815</td>
      <td>-1.126089</td>
      <td>-0.295140</td>
      <td>0.032842</td>
      <td>-0.039683</td>
      <td>-0.010591</td>
      <td>-0.094071</td>
      <td>-0.054438</td>
      <td>-0.011553</td>
      <td>0.002150</td>
      <td>...</td>
      <td>-0.007632</td>
      <td>0.002562</td>
      <td>0.003296</td>
      <td>-0.004491</td>
      <td>0.000480</td>
      <td>0.000294</td>
      <td>-0.001585</td>
      <td>0.002335</td>
      <td>-0.001919</td>
      <td>0.002991</td>
    </tr>
    <tr>
      <th>BXXZS5063A</th>
      <td>-0.630360</td>
      <td>-0.652467</td>
      <td>-0.130985</td>
      <td>-0.327233</td>
      <td>0.161356</td>
      <td>-0.135734</td>
      <td>-0.036724</td>
      <td>0.009042</td>
      <td>-0.018232</td>
      <td>-0.000024</td>
      <td>...</td>
      <td>-0.010076</td>
      <td>0.003345</td>
      <td>0.003047</td>
      <td>-0.002476</td>
      <td>0.000285</td>
      <td>0.000417</td>
      <td>-0.001705</td>
      <td>0.002453</td>
      <td>-0.001873</td>
      <td>0.003620</td>
    </tr>
    <tr>
      <th>IUMNL9626U</th>
      <td>-1.191899</td>
      <td>-0.707900</td>
      <td>-0.556744</td>
      <td>0.202532</td>
      <td>-0.077063</td>
      <td>-0.044510</td>
      <td>-0.186686</td>
      <td>0.028765</td>
      <td>-0.011223</td>
      <td>0.001455</td>
      <td>...</td>
      <td>-0.007012</td>
      <td>0.003013</td>
      <td>0.003101</td>
      <td>-0.003294</td>
      <td>0.000428</td>
      <td>0.000353</td>
      <td>-0.001492</td>
      <td>0.002573</td>
      <td>-0.002082</td>
      <td>0.002913</td>
    </tr>
    <tr>
      <th>PAYNN3649Z</th>
      <td>-0.200419</td>
      <td>-1.407759</td>
      <td>-0.190069</td>
      <td>-0.042549</td>
      <td>-0.072930</td>
      <td>-0.030307</td>
      <td>-0.101289</td>
      <td>-0.002426</td>
      <td>-0.024898</td>
      <td>0.001213</td>
      <td>...</td>
      <td>-0.007339</td>
      <td>0.002914</td>
      <td>0.003123</td>
      <td>-0.003681</td>
      <td>0.000472</td>
      <td>0.000399</td>
      <td>-0.001778</td>
      <td>0.002519</td>
      <td>-0.002033</td>
      <td>0.003257</td>
    </tr>
    <tr>
      <th>HONZP0443O</th>
      <td>-0.115365</td>
      <td>-1.775631</td>
      <td>-0.104938</td>
      <td>-0.091275</td>
      <td>-0.140787</td>
      <td>-0.074620</td>
      <td>-0.048155</td>
      <td>-0.045987</td>
      <td>-0.009660</td>
      <td>0.001759</td>
      <td>...</td>
      <td>-0.008071</td>
      <td>0.002626</td>
      <td>0.002954</td>
      <td>-0.004755</td>
      <td>0.000428</td>
      <td>0.000342</td>
      <td>-0.001757</td>
      <td>0.002184</td>
      <td>-0.002297</td>
      <td>0.003339</td>
    </tr>
    <tr>
      <th>NZECY6641V</th>
      <td>-0.605714</td>
      <td>-1.111112</td>
      <td>-0.105084</td>
      <td>-0.021646</td>
      <td>0.061730</td>
      <td>-0.105097</td>
      <td>-0.076584</td>
      <td>-0.061997</td>
      <td>-0.004997</td>
      <td>0.000793</td>
      <td>...</td>
      <td>-0.008988</td>
      <td>0.003355</td>
      <td>0.002555</td>
      <td>-0.002640</td>
      <td>0.000349</td>
      <td>0.000422</td>
      <td>-0.001669</td>
      <td>0.002710</td>
      <td>-0.002102</td>
      <td>0.003704</td>
    </tr>
    <tr>
      <th>AGNOF1041H</th>
      <td>0.126956</td>
      <td>-1.027696</td>
      <td>-0.168953</td>
      <td>0.049088</td>
      <td>0.038974</td>
      <td>-0.056876</td>
      <td>-0.039101</td>
      <td>-0.019409</td>
      <td>0.003548</td>
      <td>-0.026516</td>
      <td>...</td>
      <td>-0.007271</td>
      <td>0.001575</td>
      <td>0.002990</td>
      <td>-0.006388</td>
      <td>0.000473</td>
      <td>0.000147</td>
      <td>-0.001514</td>
      <td>0.002490</td>
      <td>-0.001605</td>
      <td>0.002535</td>
    </tr>
    <tr>
      <th>XQAGA4299B</th>
      <td>-0.483651</td>
      <td>-0.920830</td>
      <td>-0.268562</td>
      <td>-0.084444</td>
      <td>-0.028964</td>
      <td>-0.091729</td>
      <td>-0.080115</td>
      <td>-0.039649</td>
      <td>-0.069931</td>
      <td>0.001583</td>
      <td>...</td>
      <td>-0.007951</td>
      <td>0.002682</td>
      <td>-0.508688</td>
      <td>-0.003387</td>
      <td>0.000409</td>
      <td>0.000374</td>
      <td>-0.001626</td>
      <td>0.002407</td>
      <td>-0.002044</td>
      <td>0.003146</td>
    </tr>
  </tbody>
</table>
<p>10 rows × 141 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add IVT rate to dataframe</span>
<span class="n">df_mean_shap_values_per_hosp</span> <span class="o">=</span> <span class="n">df_mean_shap_values_per_hosp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_hosp_ivt_rate</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_shap_values_per_hosp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
      <th>team_AGNOF1041H</th>
      <th>...</th>
      <th>team_XPABC1435F</th>
      <th>team_XQAGA4299B</th>
      <th>team_XWUBX0795L</th>
      <th>team_YEXCH8391J</th>
      <th>team_YPKYH1768F</th>
      <th>team_YQMZV4284N</th>
      <th>team_ZBVSO0975W</th>
      <th>team_ZHCLE1578P</th>
      <th>team_ZRRCV7012C</th>
      <th>Thrombolysis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AOBTM3098N</th>
      <td>-0.706683</td>
      <td>-0.827253</td>
      <td>-0.164386</td>
      <td>0.023894</td>
      <td>0.008445</td>
      <td>-0.062407</td>
      <td>-0.079294</td>
      <td>-0.094993</td>
      <td>-0.040437</td>
      <td>0.001599</td>
      <td>...</td>
      <td>0.003196</td>
      <td>0.002574</td>
      <td>-0.002853</td>
      <td>0.000365</td>
      <td>0.000367</td>
      <td>-0.001572</td>
      <td>0.002756</td>
      <td>-0.001949</td>
      <td>0.003640</td>
      <td>0.218803</td>
    </tr>
    <tr>
      <th>QQUVD2066Z</th>
      <td>0.136372</td>
      <td>-0.980927</td>
      <td>-0.131322</td>
      <td>0.193710</td>
      <td>-0.059096</td>
      <td>-0.078017</td>
      <td>-0.043302</td>
      <td>0.027973</td>
      <td>-0.029430</td>
      <td>0.001890</td>
      <td>...</td>
      <td>0.002609</td>
      <td>0.003206</td>
      <td>-0.004560</td>
      <td>0.000569</td>
      <td>0.000358</td>
      <td>-0.001619</td>
      <td>0.002432</td>
      <td>-0.002055</td>
      <td>0.002883</td>
      <td>0.456376</td>
    </tr>
    <tr>
      <th>JHDQL1362V</th>
      <td>-0.402815</td>
      <td>-1.126089</td>
      <td>-0.295140</td>
      <td>0.032842</td>
      <td>-0.039683</td>
      <td>-0.010591</td>
      <td>-0.094071</td>
      <td>-0.054438</td>
      <td>-0.011553</td>
      <td>0.002150</td>
      <td>...</td>
      <td>0.002562</td>
      <td>0.003296</td>
      <td>-0.004491</td>
      <td>0.000480</td>
      <td>0.000294</td>
      <td>-0.001585</td>
      <td>0.002335</td>
      <td>-0.001919</td>
      <td>0.002991</td>
      <td>0.292797</td>
    </tr>
    <tr>
      <th>BXXZS5063A</th>
      <td>-0.630360</td>
      <td>-0.652467</td>
      <td>-0.130985</td>
      <td>-0.327233</td>
      <td>0.161356</td>
      <td>-0.135734</td>
      <td>-0.036724</td>
      <td>0.009042</td>
      <td>-0.018232</td>
      <td>-0.000024</td>
      <td>...</td>
      <td>0.003345</td>
      <td>0.003047</td>
      <td>-0.002476</td>
      <td>0.000285</td>
      <td>0.000417</td>
      <td>-0.001705</td>
      <td>0.002453</td>
      <td>-0.001873</td>
      <td>0.003620</td>
      <td>0.248529</td>
    </tr>
    <tr>
      <th>IUMNL9626U</th>
      <td>-1.191899</td>
      <td>-0.707900</td>
      <td>-0.556744</td>
      <td>0.202532</td>
      <td>-0.077063</td>
      <td>-0.044510</td>
      <td>-0.186686</td>
      <td>0.028765</td>
      <td>-0.011223</td>
      <td>0.001455</td>
      <td>...</td>
      <td>0.003013</td>
      <td>0.003101</td>
      <td>-0.003294</td>
      <td>0.000428</td>
      <td>0.000353</td>
      <td>-0.001492</td>
      <td>0.002573</td>
      <td>-0.002082</td>
      <td>0.002913</td>
      <td>0.185751</td>
    </tr>
    <tr>
      <th>PAYNN3649Z</th>
      <td>-0.200419</td>
      <td>-1.407759</td>
      <td>-0.190069</td>
      <td>-0.042549</td>
      <td>-0.072930</td>
      <td>-0.030307</td>
      <td>-0.101289</td>
      <td>-0.002426</td>
      <td>-0.024898</td>
      <td>0.001213</td>
      <td>...</td>
      <td>0.002914</td>
      <td>0.003123</td>
      <td>-0.003681</td>
      <td>0.000472</td>
      <td>0.000399</td>
      <td>-0.001778</td>
      <td>0.002519</td>
      <td>-0.002033</td>
      <td>0.003257</td>
      <td>0.277852</td>
    </tr>
    <tr>
      <th>HONZP0443O</th>
      <td>-0.115365</td>
      <td>-1.775631</td>
      <td>-0.104938</td>
      <td>-0.091275</td>
      <td>-0.140787</td>
      <td>-0.074620</td>
      <td>-0.048155</td>
      <td>-0.045987</td>
      <td>-0.009660</td>
      <td>0.001759</td>
      <td>...</td>
      <td>0.002626</td>
      <td>0.002954</td>
      <td>-0.004755</td>
      <td>0.000428</td>
      <td>0.000342</td>
      <td>-0.001757</td>
      <td>0.002184</td>
      <td>-0.002297</td>
      <td>0.003339</td>
      <td>0.264286</td>
    </tr>
    <tr>
      <th>NZECY6641V</th>
      <td>-0.605714</td>
      <td>-1.111112</td>
      <td>-0.105084</td>
      <td>-0.021646</td>
      <td>0.061730</td>
      <td>-0.105097</td>
      <td>-0.076584</td>
      <td>-0.061997</td>
      <td>-0.004997</td>
      <td>0.000793</td>
      <td>...</td>
      <td>0.003355</td>
      <td>0.002555</td>
      <td>-0.002640</td>
      <td>0.000349</td>
      <td>0.000422</td>
      <td>-0.001669</td>
      <td>0.002710</td>
      <td>-0.002102</td>
      <td>0.003704</td>
      <td>0.245763</td>
    </tr>
    <tr>
      <th>AGNOF1041H</th>
      <td>0.126956</td>
      <td>-1.027696</td>
      <td>-0.168953</td>
      <td>0.049088</td>
      <td>0.038974</td>
      <td>-0.056876</td>
      <td>-0.039101</td>
      <td>-0.019409</td>
      <td>0.003548</td>
      <td>-0.026516</td>
      <td>...</td>
      <td>0.001575</td>
      <td>0.002990</td>
      <td>-0.006388</td>
      <td>0.000473</td>
      <td>0.000147</td>
      <td>-0.001514</td>
      <td>0.002490</td>
      <td>-0.001605</td>
      <td>0.002535</td>
      <td>0.352468</td>
    </tr>
    <tr>
      <th>XQAGA4299B</th>
      <td>-0.483651</td>
      <td>-0.920830</td>
      <td>-0.268562</td>
      <td>-0.084444</td>
      <td>-0.028964</td>
      <td>-0.091729</td>
      <td>-0.080115</td>
      <td>-0.039649</td>
      <td>-0.069931</td>
      <td>0.001583</td>
      <td>...</td>
      <td>0.002682</td>
      <td>-0.508688</td>
      <td>-0.003387</td>
      <td>0.000409</td>
      <td>0.000374</td>
      <td>-0.001626</td>
      <td>0.002407</td>
      <td>-0.002044</td>
      <td>0.003146</td>
      <td>0.218579</td>
    </tr>
  </tbody>
</table>
<p>10 rows × 142 columns</p>
</div></div></div>
</div>
<p>Add in the mean SHAP value for the hospital feature (already calculated in notebook 03c)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./output/03d_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;_hospital_shap_vs_ivt_rate.csv&#39;</span><span class="p">)</span>
<span class="n">df_hosp_shap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">df_hosp_shap</span> <span class="o">=</span> <span class="n">df_hosp_shap</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;hospital&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_shap_values_per_hosp</span> <span class="o">=</span> <span class="n">df_mean_shap_values_per_hosp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_hosp_shap</span><span class="p">,</span> 
                                                                 <span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;_h&quot;</span><span class="p">)</span>
<span class="n">df_mean_shap_values_per_hosp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
      <th>team_AGNOF1041H</th>
      <th>...</th>
      <th>team_YEXCH8391J</th>
      <th>team_YPKYH1768F</th>
      <th>team_YQMZV4284N</th>
      <th>team_ZBVSO0975W</th>
      <th>team_ZHCLE1578P</th>
      <th>team_ZRRCV7012C</th>
      <th>Thrombolysis</th>
      <th>shap_mean_sv</th>
      <th>Thrombolysis_h</th>
      <th>shap_mean_me</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AOBTM3098N</th>
      <td>-0.706683</td>
      <td>-0.827253</td>
      <td>-0.164386</td>
      <td>0.023894</td>
      <td>0.008445</td>
      <td>-0.062407</td>
      <td>-0.079294</td>
      <td>-0.094993</td>
      <td>-0.040437</td>
      <td>0.001599</td>
      <td>...</td>
      <td>0.000365</td>
      <td>0.000367</td>
      <td>-0.001572</td>
      <td>0.002756</td>
      <td>-0.001949</td>
      <td>0.003640</td>
      <td>0.218803</td>
      <td>-0.401549</td>
      <td>0.218803</td>
      <td>-0.390772</td>
    </tr>
    <tr>
      <th>QQUVD2066Z</th>
      <td>0.136372</td>
      <td>-0.980927</td>
      <td>-0.131322</td>
      <td>0.193710</td>
      <td>-0.059096</td>
      <td>-0.078017</td>
      <td>-0.043302</td>
      <td>0.027973</td>
      <td>-0.029430</td>
      <td>0.001890</td>
      <td>...</td>
      <td>0.000569</td>
      <td>0.000358</td>
      <td>-0.001619</td>
      <td>0.002432</td>
      <td>-0.002055</td>
      <td>0.002883</td>
      <td>0.456376</td>
      <td>0.629639</td>
      <td>0.456376</td>
      <td>0.625144</td>
    </tr>
    <tr>
      <th>JHDQL1362V</th>
      <td>-0.402815</td>
      <td>-1.126089</td>
      <td>-0.295140</td>
      <td>0.032842</td>
      <td>-0.039683</td>
      <td>-0.010591</td>
      <td>-0.094071</td>
      <td>-0.054438</td>
      <td>-0.011553</td>
      <td>0.002150</td>
      <td>...</td>
      <td>0.000480</td>
      <td>0.000294</td>
      <td>-0.001585</td>
      <td>0.002335</td>
      <td>-0.001919</td>
      <td>0.002991</td>
      <td>0.292797</td>
      <td>0.010272</td>
      <td>0.292797</td>
      <td>0.040766</td>
    </tr>
    <tr>
      <th>BXXZS5063A</th>
      <td>-0.630360</td>
      <td>-0.652467</td>
      <td>-0.130985</td>
      <td>-0.327233</td>
      <td>0.161356</td>
      <td>-0.135734</td>
      <td>-0.036724</td>
      <td>0.009042</td>
      <td>-0.018232</td>
      <td>-0.000024</td>
      <td>...</td>
      <td>0.000285</td>
      <td>0.000417</td>
      <td>-0.001705</td>
      <td>0.002453</td>
      <td>-0.001873</td>
      <td>0.003620</td>
      <td>0.248529</td>
      <td>0.020597</td>
      <td>0.248529</td>
      <td>-0.039883</td>
    </tr>
    <tr>
      <th>IUMNL9626U</th>
      <td>-1.191899</td>
      <td>-0.707900</td>
      <td>-0.556744</td>
      <td>0.202532</td>
      <td>-0.077063</td>
      <td>-0.044510</td>
      <td>-0.186686</td>
      <td>0.028765</td>
      <td>-0.011223</td>
      <td>0.001455</td>
      <td>...</td>
      <td>0.000428</td>
      <td>0.000353</td>
      <td>-0.001492</td>
      <td>0.002573</td>
      <td>-0.002082</td>
      <td>0.002913</td>
      <td>0.185751</td>
      <td>-0.847366</td>
      <td>0.185751</td>
      <td>-0.814281</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>WSFVN0229E</th>
      <td>-1.055860</td>
      <td>-0.471481</td>
      <td>-0.355870</td>
      <td>-0.107223</td>
      <td>-0.016413</td>
      <td>0.001053</td>
      <td>-0.049371</td>
      <td>-0.007234</td>
      <td>-0.046051</td>
      <td>0.000914</td>
      <td>...</td>
      <td>0.000322</td>
      <td>0.000387</td>
      <td>-0.001667</td>
      <td>0.002300</td>
      <td>-0.002183</td>
      <td>0.003451</td>
      <td>0.252941</td>
      <td>0.109983</td>
      <td>0.252941</td>
      <td>0.119907</td>
    </tr>
    <tr>
      <th>PSNKC7508G</th>
      <td>-0.524928</td>
      <td>-1.070266</td>
      <td>-0.061160</td>
      <td>0.066380</td>
      <td>-0.051209</td>
      <td>-0.073205</td>
      <td>-0.028887</td>
      <td>-0.014873</td>
      <td>-0.016516</td>
      <td>0.001007</td>
      <td>...</td>
      <td>0.000392</td>
      <td>0.000421</td>
      <td>-0.001802</td>
      <td>0.002870</td>
      <td>-0.002280</td>
      <td>0.003722</td>
      <td>0.319038</td>
      <td>-0.004237</td>
      <td>0.319038</td>
      <td>0.000200</td>
    </tr>
    <tr>
      <th>EQPWM6065O</th>
      <td>-0.607676</td>
      <td>-1.112876</td>
      <td>-0.114227</td>
      <td>-0.165922</td>
      <td>-0.069612</td>
      <td>-0.056396</td>
      <td>-0.046210</td>
      <td>-0.169364</td>
      <td>-0.003832</td>
      <td>0.000949</td>
      <td>...</td>
      <td>0.000350</td>
      <td>0.000439</td>
      <td>-0.001336</td>
      <td>0.002453</td>
      <td>-0.002153</td>
      <td>0.003819</td>
      <td>0.313088</td>
      <td>0.483091</td>
      <td>0.313088</td>
      <td>0.552636</td>
    </tr>
    <tr>
      <th>TXYJJ1019H</th>
      <td>-0.336146</td>
      <td>-0.928714</td>
      <td>-0.225783</td>
      <td>-0.106874</td>
      <td>-0.098462</td>
      <td>-0.033309</td>
      <td>-0.065516</td>
      <td>0.016631</td>
      <td>-0.030836</td>
      <td>0.001079</td>
      <td>...</td>
      <td>0.000412</td>
      <td>0.000452</td>
      <td>-0.001669</td>
      <td>0.002441</td>
      <td>-0.002105</td>
      <td>0.003442</td>
      <td>0.275946</td>
      <td>0.057981</td>
      <td>0.275946</td>
      <td>0.084655</td>
    </tr>
    <tr>
      <th>SMVTP6284P</th>
      <td>-0.166540</td>
      <td>-1.239263</td>
      <td>-0.207496</td>
      <td>-0.190194</td>
      <td>0.033157</td>
      <td>0.060705</td>
      <td>-0.037140</td>
      <td>-0.072448</td>
      <td>0.049891</td>
      <td>0.001157</td>
      <td>...</td>
      <td>0.000386</td>
      <td>0.000500</td>
      <td>-0.001650</td>
      <td>0.002300</td>
      <td>-0.001926</td>
      <td>0.003335</td>
      <td>0.360875</td>
      <td>0.606678</td>
      <td>0.360875</td>
      <td>0.616175</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 145 columns</p>
</div></div></div>
</div>
</section>
<section id="fit-regressions-to-processed-data">
<h3>Fit regressions to processed data<a class="headerlink" href="#fit-regressions-to-processed-data" title="Permalink to this heading">#</a></h3>
<p>We will fit</p>
<ul class="simple">
<li><p>a linear regression for all the features against a target feature (thrombolysis rate).</p></li>
<li><p>using multiple linear regression to predict the hospitals thrombolysis rate from a subset of features.</p></li>
</ul>
<p>Define a function to fit and plot a linear regression between hospital thrombolysis rate and the SHAP value for a list of features (mean for those instances that attend the hospital)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_regressions</span><span class="p">(</span><span class="n">df_hosp_mean</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">x_label_text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit and plot a linear regression for all the features in the features list</span>
<span class="sd">    against the target feature (Thrombolysis rate).</span>
<span class="sd">    </span>
<span class="sd">    df_hosp_mean [pandas DataFrame]: column per feature, row per hospital, value</span>
<span class="sd">                              is mean for instances that attend that hospital</span>
<span class="sd">    features [list]: Features to individually fit a linear regression against </span>
<span class="sd">                     the hospital thrombolysis rate</span>
<span class="sd">    x_label_text [str]: Text to use in first part of x axis label string</span>
<span class="sd">    Return []: empty</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">n_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="n">n_features</span> <span class="o">/</span> <span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">((</span><span class="mi">6</span><span class="o">*</span><span class="n">cols</span><span class="p">),(</span><span class="mi">6</span><span class="o">*</span><span class="n">rows</span><span class="p">)))</span>
    
    <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span> 
        <span class="c1"># Setup data for chart</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df_hosp_mean</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_hosp_mean</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>

        <span class="c1"># Fit a regression line to the x2 points</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> \
            <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">r_square</span> <span class="o">=</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span>

        <span class="c1"># Create scatter plot with regression line</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">count</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_label_text</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(mean of the instances that attend the hospital)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="c1"># Add  text</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> 
              <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept</span><span class="p">)))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R squared: </span><span class="si">{</span><span class="n">r_square</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">p: &#39;</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">formula: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    
        <span class="n">x_placement</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>
        <span class="n">y_placement</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_placement</span><span class="p">,</span> <span class="n">y_placement</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                 <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>

        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Define a function to fit and plot a multiple regression on a set of features vs hostpial thrombolysis rate</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df_hosp_mean</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">x_label_text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
                                     <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    df_hosp_mean contains the data, features contain the columns to plot as a </span>
<span class="sd">    multiple regression against the thrombolysis rate.</span>
<span class="sd">    </span>
<span class="sd">    df_hosp_mean [DataFrame]:column per feature, row per hospital, value is </span>
<span class="sd">                             mean for instances that attend that hospital</span>
<span class="sd">    features [list]: list of feature names (column titles in df_hosp_mean) to </span>
<span class="sd">                     include in the multiple regression</span>
<span class="sd">    x_label_text [str]: Text to use in x axis label</span>
<span class="sd">    ax [matplotlib ax object]: matplotlib ax object</span>
<span class="sd">    return [matplotlib ax object]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">df_hosp_mean</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df_hosp_mean</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>

    <span class="n">regr</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>
    <span class="n">regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">df_reg_coeff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">features</span><span class="p">,</span> 
                                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;coeff&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df_reg_coeff</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># performance</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1"># Fit a regression line to the obs and pred IVT use</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> \
        <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">r_square</span> <span class="o">=</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">y_pred_line</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span>
    
    <span class="c1"># Create scatter plot with regression line</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span> <span class="p">(</span><span class="n">y_pred_line</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">axis_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">)</span>
    <span class="n">axis_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axis_min</span><span class="p">,</span> <span class="n">axis_max</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axis_min</span><span class="p">,</span> <span class="n">axis_max</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Hospital thrombolysis rate (predicted</span><span class="si">{</span><span class="n">x_label_text</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Hospital thrombolysis rate (observed)&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="c1"># Add  text</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slope</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;x + &#39;</span> <span class="o">+</span> 
          <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intercept</span><span class="p">)))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;R squared: </span><span class="si">{</span><span class="n">r_square</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">p: &#39;</span>
             <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="se">\n</span><span class="s1">formula: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">x_placement</span> <span class="o">=</span> <span class="n">axis_min</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="p">(</span><span class="n">axis_max</span> <span class="o">-</span> <span class="n">axis_min</span><span class="p">)</span>
    <span class="n">y_placement</span> <span class="o">=</span> <span class="n">axis_max</span> <span class="o">-</span> <span class="mf">0.15</span><span class="o">*</span><span class="p">(</span><span class="n">axis_max</span> <span class="o">-</span> <span class="n">axis_min</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_placement</span><span class="p">,</span> <span class="n">y_placement</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="linear-regression-of-each-feature-vs-hosptial-thrombolysis-rate">
<h4>Linear regression of each feature vs. hosptial thrombolysis rate<a class="headerlink" href="#linear-regression-of-each-feature-vs-hosptial-thrombolysis-rate" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">,</span><span class="s1">&#39;Infarction&#39;</span><span class="p">,</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Precise onset time&#39;</span><span class="p">,</span><span class="s1">&#39;Prior disability level&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Use of AF anticoagulants&#39;</span><span class="p">,</span><span class="s1">&#39;Onset-to-arrival time&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Onset during sleep&#39;</span><span class="p">,</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;shap_mean_sv&#39;</span><span class="p">]</span>

<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;SHAP values for&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_mean_shap_values_per_hosp</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regression between hosptial IVT rate and SHAP value for features &quot;</span>
      <span class="s2">&quot;(mean for those instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">plot_regressions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Regression between hosptial IVT rate and SHAP value for features (mean for those instances that attend the hospital)
</pre></div>
</div>
<img alt="../_images/93bd982cffe29836385d2070d52e91344ea25234f8d3b8ccf24e8aacf8a28d64.png" src="../_images/93bd982cffe29836385d2070d52e91344ea25234f8d3b8ccf24e8aacf8a28d64.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="multiple-regression-on-all-features-vs-ivt-rate">
<h4>Multiple regression on all features vs IVT rate<a class="headerlink" href="#multiple-regression-on-all-features-vs-ivt-rate" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP value for all &quot;</span>
      <span class="s2">&quot;features (mean for those instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP value for all features (mean for those instances that attend the hospital)

                             coeff
Arrival-to-scan time      0.066249
Infarction                0.034880
Stroke severity           0.089651
Precise onset time        0.116825
Prior disability level    0.090232
Use of AF anticoagulants  0.129920
Onset-to-arrival time    -0.098246
Onset during sleep        0.068122
Age                       0.178001
shap_mean_sv              0.109368
</pre></div>
</div>
<img alt="../_images/84e67c43f870a0cca8ab159ffee050dd6c038de16b9752288f70cb8847ed23ef.png" src="../_images/84e67c43f870a0cca8ab159ffee050dd6c038de16b9752288f70cb8847ed23ef.png" />
</div>
</div>
</section>
<section id="multiple-regression-on-features-excluding-attended-hosptial-vs-ivt-rate">
<h4>Multiple regression on features (excluding attended hosptial) vs IVT rate<a class="headerlink" href="#multiple-regression-on-features-excluding-attended-hosptial-vs-ivt-rate" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">,</span><span class="s1">&#39;Infarction&#39;</span><span class="p">,</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Precise onset time&#39;</span><span class="p">,</span><span class="s1">&#39;Prior disability level&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Use of AF anticoagulants&#39;</span><span class="p">,</span><span class="s1">&#39;Onset-to-arrival time&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Onset during sleep&#39;</span><span class="p">,</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP value for features &quot;</span>
      <span class="s2">&quot;(mean for those instances that attend the hospital), excluding &quot;</span>
      <span class="s2">&quot;attended hospital SHAP&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP value for features (mean for those instances that attend the hospital), excluding attended hospital SHAP

                             coeff
Arrival-to-scan time      0.079886
Infarction                0.063246
Stroke severity           0.111067
Precise onset time        0.046224
Prior disability level    0.050308
Use of AF anticoagulants  0.036244
Onset-to-arrival time    -0.088946
Onset during sleep        0.074848
Age                       0.785148
</pre></div>
</div>
<img alt="../_images/dd3077074b6a2ebb8e60ed2be54e34711a0840a9d53f3d97b59f7f5faa04dce1.png" src="../_images/dd3077074b6a2ebb8e60ed2be54e34711a0840a9d53f3d97b59f7f5faa04dce1.png" />
</div>
</div>
</section>
<section id="multiple-regression-on-just-patient-characteristics-vs-ivt-rate">
<h4>Multiple regression on just patient characteristics vs IVT rate<a class="headerlink" href="#multiple-regression-on-just-patient-characteristics-vs-ivt-rate" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Infarction&#39;</span><span class="p">,</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Precise onset time&#39;</span><span class="p">,</span><span class="s1">&#39;Prior disability level&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Use of AF anticoagulants&#39;</span><span class="p">,</span><span class="s1">&#39;Onset-to-arrival time&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Onset during sleep&#39;</span><span class="p">,</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP value for just &quot;</span>
      <span class="s2">&quot;patient features (mean for those instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP value for just patient features (mean for those instances that attend the hospital)

                             coeff
Infarction                0.041041
Stroke severity           0.136061
Precise onset time        0.060148
Prior disability level    0.047838
Use of AF anticoagulants -0.058462
Onset-to-arrival time     0.071181
Onset during sleep        0.111865
Age                       1.062042
</pre></div>
</div>
<img alt="../_images/15a1b09d7ed3f69b8c2b1f98b814174680c73c6ae5c2b5a9a8a99ef829e2873d.png" src="../_images/15a1b09d7ed3f69b8c2b1f98b814174680c73c6ae5c2b5a9a8a99ef829e2873d.png" />
</div>
</div>
</section>
<section id="multiple-regression-on-just-hospital-processes-vs-ivt-rate">
<h4>Multiple regression on just hospital processes vs IVT rate<a class="headerlink" href="#multiple-regression-on-just-hospital-processes-vs-ivt-rate" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">,</span><span class="s1">&#39;shap_mean_sv&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP value for features &quot;</span>
      <span class="s2">&quot;(mean for those instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP value for features (mean for those instances that attend the hospital)

                         coeff
Arrival-to-scan time  0.079994
shap_mean_sv          0.106429
</pre></div>
</div>
<img alt="../_images/892a7585ed643d71e66279dd1734ea49720b78e9781a62ec34dc55eb349cb902.png" src="../_images/892a7585ed643d71e66279dd1734ea49720b78e9781a62ec34dc55eb349cb902.png" />
</div>
</div>
<p>Is there a correlation between IVT rate and proportion ischemeic?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate infarction rate per hosptial</span>
<span class="n">df_hosp_isch_rate</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s2">&quot;Infarction&quot;</span><span class="p">]</span>
<span class="n">df_hosp_isch_ivt_rate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_hosp_isch_rate</span><span class="p">,</span> <span class="n">df_hosp_ivt_rate</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_hosp_isch_ivt_rate</span> <span class="o">=</span> <span class="n">df_hosp_isch_ivt_rate</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Infarction&quot;</span><span class="p">:</span><span class="s2">&quot;Proportion infarction&quot;</span><span class="p">})</span>
<span class="n">df_hosp_isch_ivt_rate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Proportion infarction</th>
      <th>Thrombolysis</th>
    </tr>
    <tr>
      <th>Stroke team</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AGNOF1041H</th>
      <td>0.846154</td>
      <td>0.352468</td>
    </tr>
    <tr>
      <th>AKCGO9726K</th>
      <td>0.916667</td>
      <td>0.369748</td>
    </tr>
    <tr>
      <th>AOBTM3098N</th>
      <td>0.866667</td>
      <td>0.218803</td>
    </tr>
    <tr>
      <th>APXEE8191H</th>
      <td>0.783972</td>
      <td>0.226481</td>
    </tr>
    <tr>
      <th>ATDID5461S</th>
      <td>0.817308</td>
      <td>0.240385</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>YPKYH1768F</th>
      <td>0.854890</td>
      <td>0.246057</td>
    </tr>
    <tr>
      <th>YQMZV4284N</th>
      <td>0.859574</td>
      <td>0.236170</td>
    </tr>
    <tr>
      <th>ZBVSO0975W</th>
      <td>0.821759</td>
      <td>0.250000</td>
    </tr>
    <tr>
      <th>ZHCLE1578P</th>
      <td>0.869898</td>
      <td>0.223639</td>
    </tr>
    <tr>
      <th>ZRRCV7012C</th>
      <td>0.863636</td>
      <td>0.157670</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Proportion infarction&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regression between hosptial IVT rate and proportion of patients with &quot;</span>
      <span class="s2">&quot;infarction&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">plot_regressions</span><span class="p">(</span><span class="n">df_hosp_isch_ivt_rate</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Regression between hosptial IVT rate and proportion of patients with infarction
</pre></div>
</div>
<img alt="../_images/341c5b6e5b186ecbb56a8071410d8c8ba3a9b3386b377782ee41131cdb5377f8.png" src="../_images/341c5b6e5b186ecbb56a8071410d8c8ba3a9b3386b377782ee41131cdb5377f8.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>()
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="repeat-using-shap-main-effect">
<h2>Repeat using SHAP main effect<a class="headerlink" href="#repeat-using-shap-main-effect" title="Permalink to this heading">#</a></h2>
<section id="get-shap-interaction-values">
<h3>Get SHAP interaction values<a class="headerlink" href="#get-shap-interaction-values" title="Permalink to this heading">#</a></h3>
<p>A SHAP interaction value is returned for each pair of features (including with itself, which is known as the main effect), for each instance. The SHAP value for a feature is the sum of it’s pair-wise feature interactions.</p>
<p>We used the TreeExplainer (from the shap library: https://shap.readthedocs.io/en/latest/index.html) to calculate the SHAP interaction values (notebook 03c).</p>
<p>‘Raw’ SHAP interaction values from XGBoost model are log odds ratios.</p>
<p>Load from pickle (from notebook 03c).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03c_</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s1">_shap_interactions.p&#39;</span>

<span class="c1"># Load SHAP interaction</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
    <span class="n">shap_interactions</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 4.87 ms, sys: 2.71 s, total: 2.72 s
Wall time: 2.72 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_interactions</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(88792, 141, 141)
</pre></div>
</div>
</div>
</div>
<p>Get main effect for each feature for each patient</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise list</span>
<span class="n">shap_main_effects</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each patient</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shap_interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="c1"># Get the main effect value for each of the features</span>
    <span class="n">main_effects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">shap_interactions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">shap_main_effects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_effects</span><span class="p">)</span>

<span class="c1"># Put main effects in dataframe with features as column title</span>
<span class="n">df_hosp_shap_main_effects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">shap_main_effects</span><span class="p">,</span> 
                                         <span class="n">columns</span><span class="o">=</span><span class="n">feature_names_ohe</span><span class="p">)</span>

<span class="c1"># Only keep the hospital one-hot encoded feature for the attended hospital</span>

<span class="c1"># Initialise list</span>
<span class="n">shap_of_team_attended</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each patient</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shap_interactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">shap_of_team_attended</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;team_</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># Store the SHAP values for the hospital attended</span>
<span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shap_of_team_attended</span>

<span class="c1"># remove thrombolysis</span>
<span class="n">feature_names_keep</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_hosp_shap_main_effects</span> <span class="o">=</span> <span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="n">feature_names_keep</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hosp_shap_main_effects</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Stroke team</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.676277</td>
      <td>0.338386</td>
      <td>0.862582</td>
      <td>0.430773</td>
      <td>0.322120</td>
      <td>-0.187852</td>
      <td>0.135322</td>
      <td>-0.441546</td>
      <td>0.042960</td>
      <td>0.231744</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.447184</td>
      <td>0.339734</td>
      <td>0.297246</td>
      <td>0.434184</td>
      <td>0.331810</td>
      <td>-0.580359</td>
      <td>0.138708</td>
      <td>0.165874</td>
      <td>0.048222</td>
      <td>0.235642</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-2.979032</td>
      <td>0.321163</td>
      <td>-1.694299</td>
      <td>0.420702</td>
      <td>0.379625</td>
      <td>-1.192582</td>
      <td>0.148083</td>
      <td>0.001259</td>
      <td>0.039560</td>
      <td>0.125615</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.336959</td>
      <td>-8.517138</td>
      <td>0.747195</td>
      <td>0.435908</td>
      <td>0.358994</td>
      <td>0.977001</td>
      <td>0.161105</td>
      <td>0.071381</td>
      <td>0.043983</td>
      <td>0.042129</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.847006</td>
      <td>0.340107</td>
      <td>0.851986</td>
      <td>0.437559</td>
      <td>0.336050</td>
      <td>0.070702</td>
      <td>0.143654</td>
      <td>0.160698</td>
      <td>0.044551</td>
      <td>0.053406</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create dataframe with hospital as index, column per feature, containing</span>
<span class="c1"># mean SHAP main effect for feature for patients that attend that hospital</span>

<span class="c1"># Initialise list</span>
<span class="n">mean_shap_main_effect_hosp</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># For each hosptial</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">unique_stroketeams_list</span><span class="p">:</span>
<span class="c1">#    calcualte mean shap main effect for the patients that attend hospital</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Stroke team&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
    <span class="n">mean_shap_main_effect_hosp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_hosp_shap_main_effects</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="c1"># Create DataFrame</span>
<span class="n">df_mean_shap_main_effect_per_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mean_shap_main_effect_hosp</span><span class="p">,</span> 
                                                   <span class="n">index</span><span class="o">=</span><span class="n">unique_stroketeams_list</span><span class="p">,</span>
                                                   <span class="n">columns</span><span class="o">=</span><span class="n">feature_names_keep</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_shap_main_effect_per_hosp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Stroke team</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AOBTM3098N</th>
      <td>-0.781391</td>
      <td>-0.837082</td>
      <td>-0.149835</td>
      <td>0.049635</td>
      <td>0.012531</td>
      <td>-0.390772</td>
      <td>-0.062263</td>
      <td>-0.046660</td>
      <td>-0.067334</td>
      <td>-0.044815</td>
    </tr>
    <tr>
      <th>QQUVD2066Z</th>
      <td>0.134090</td>
      <td>-1.002392</td>
      <td>-0.125507</td>
      <td>0.202943</td>
      <td>-0.073116</td>
      <td>0.625144</td>
      <td>-0.089202</td>
      <td>-0.036222</td>
      <td>0.032351</td>
      <td>-0.044030</td>
    </tr>
    <tr>
      <th>JHDQL1362V</th>
      <td>-0.395021</td>
      <td>-1.125387</td>
      <td>-0.302660</td>
      <td>0.041979</td>
      <td>-0.042290</td>
      <td>0.040766</td>
      <td>-0.012047</td>
      <td>-0.075419</td>
      <td>-0.042522</td>
      <td>-0.012828</td>
    </tr>
    <tr>
      <th>BXXZS5063A</th>
      <td>-0.710763</td>
      <td>-0.646758</td>
      <td>-0.114046</td>
      <td>-0.364860</td>
      <td>0.151970</td>
      <td>-0.039883</td>
      <td>-0.155382</td>
      <td>-0.020414</td>
      <td>0.011284</td>
      <td>-0.020753</td>
    </tr>
    <tr>
      <th>IUMNL9626U</th>
      <td>-1.202068</td>
      <td>-0.696896</td>
      <td>-0.542578</td>
      <td>0.238191</td>
      <td>-0.152271</td>
      <td>-0.814282</td>
      <td>-0.035247</td>
      <td>-0.065188</td>
      <td>0.035691</td>
      <td>-0.023318</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>WSFVN0229E</th>
      <td>-1.081844</td>
      <td>-0.438762</td>
      <td>-0.408264</td>
      <td>-0.137084</td>
      <td>-0.028605</td>
      <td>0.119907</td>
      <td>-0.001400</td>
      <td>-0.026640</td>
      <td>0.005162</td>
      <td>-0.036282</td>
    </tr>
    <tr>
      <th>PSNKC7508G</th>
      <td>-0.531692</td>
      <td>-1.067373</td>
      <td>-0.089513</td>
      <td>0.069251</td>
      <td>-0.050202</td>
      <td>0.000200</td>
      <td>-0.076808</td>
      <td>-0.007752</td>
      <td>-0.006380</td>
      <td>-0.018600</td>
    </tr>
    <tr>
      <th>EQPWM6065O</th>
      <td>-0.568333</td>
      <td>-1.142110</td>
      <td>-0.129391</td>
      <td>-0.191133</td>
      <td>-0.076851</td>
      <td>0.552636</td>
      <td>-0.057563</td>
      <td>-0.027554</td>
      <td>-0.118624</td>
      <td>0.000485</td>
    </tr>
    <tr>
      <th>TXYJJ1019H</th>
      <td>-0.303832</td>
      <td>-0.943076</td>
      <td>-0.200153</td>
      <td>-0.123385</td>
      <td>-0.105447</td>
      <td>0.084655</td>
      <td>-0.044026</td>
      <td>-0.050865</td>
      <td>0.021769</td>
      <td>-0.032892</td>
    </tr>
    <tr>
      <th>SMVTP6284P</th>
      <td>-0.138389</td>
      <td>-1.217001</td>
      <td>-0.158511</td>
      <td>-0.270623</td>
      <td>0.026254</td>
      <td>0.616175</td>
      <td>0.059980</td>
      <td>-0.042928</td>
      <td>-0.068234</td>
      <td>0.032218</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 10 columns</p>
</div></div></div>
</div>
<p>Add thrombolysis rate</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_mean_shap_main_effect_per_hosp</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">df_mean_shap_main_effect_per_hosp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_hosp_ivt_rate</span><span class="p">))</span>
<span class="n">df_mean_shap_main_effect_per_hosp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Arrival-to-scan time</th>
      <th>Infarction</th>
      <th>Stroke severity</th>
      <th>Precise onset time</th>
      <th>Prior disability level</th>
      <th>Stroke team</th>
      <th>Use of AF anticoagulants</th>
      <th>Onset-to-arrival time</th>
      <th>Onset during sleep</th>
      <th>Age</th>
      <th>Thrombolysis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AOBTM3098N</th>
      <td>-0.781391</td>
      <td>-0.837082</td>
      <td>-0.149835</td>
      <td>0.049635</td>
      <td>0.012531</td>
      <td>-0.390772</td>
      <td>-0.062263</td>
      <td>-0.046660</td>
      <td>-0.067334</td>
      <td>-0.044815</td>
      <td>0.218803</td>
    </tr>
    <tr>
      <th>QQUVD2066Z</th>
      <td>0.134090</td>
      <td>-1.002392</td>
      <td>-0.125507</td>
      <td>0.202943</td>
      <td>-0.073116</td>
      <td>0.625144</td>
      <td>-0.089202</td>
      <td>-0.036222</td>
      <td>0.032351</td>
      <td>-0.044030</td>
      <td>0.456376</td>
    </tr>
    <tr>
      <th>JHDQL1362V</th>
      <td>-0.395021</td>
      <td>-1.125387</td>
      <td>-0.302660</td>
      <td>0.041979</td>
      <td>-0.042290</td>
      <td>0.040766</td>
      <td>-0.012047</td>
      <td>-0.075419</td>
      <td>-0.042522</td>
      <td>-0.012828</td>
      <td>0.292797</td>
    </tr>
    <tr>
      <th>BXXZS5063A</th>
      <td>-0.710763</td>
      <td>-0.646758</td>
      <td>-0.114046</td>
      <td>-0.364860</td>
      <td>0.151970</td>
      <td>-0.039883</td>
      <td>-0.155382</td>
      <td>-0.020414</td>
      <td>0.011284</td>
      <td>-0.020753</td>
      <td>0.248529</td>
    </tr>
    <tr>
      <th>IUMNL9626U</th>
      <td>-1.202068</td>
      <td>-0.696896</td>
      <td>-0.542578</td>
      <td>0.238191</td>
      <td>-0.152271</td>
      <td>-0.814282</td>
      <td>-0.035247</td>
      <td>-0.065188</td>
      <td>0.035691</td>
      <td>-0.023318</td>
      <td>0.185751</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>WSFVN0229E</th>
      <td>-1.081844</td>
      <td>-0.438762</td>
      <td>-0.408264</td>
      <td>-0.137084</td>
      <td>-0.028605</td>
      <td>0.119907</td>
      <td>-0.001400</td>
      <td>-0.026640</td>
      <td>0.005162</td>
      <td>-0.036282</td>
      <td>0.252941</td>
    </tr>
    <tr>
      <th>PSNKC7508G</th>
      <td>-0.531692</td>
      <td>-1.067373</td>
      <td>-0.089513</td>
      <td>0.069251</td>
      <td>-0.050202</td>
      <td>0.000200</td>
      <td>-0.076808</td>
      <td>-0.007752</td>
      <td>-0.006380</td>
      <td>-0.018600</td>
      <td>0.319038</td>
    </tr>
    <tr>
      <th>EQPWM6065O</th>
      <td>-0.568333</td>
      <td>-1.142110</td>
      <td>-0.129391</td>
      <td>-0.191133</td>
      <td>-0.076851</td>
      <td>0.552636</td>
      <td>-0.057563</td>
      <td>-0.027554</td>
      <td>-0.118624</td>
      <td>0.000485</td>
      <td>0.313088</td>
    </tr>
    <tr>
      <th>TXYJJ1019H</th>
      <td>-0.303832</td>
      <td>-0.943076</td>
      <td>-0.200153</td>
      <td>-0.123385</td>
      <td>-0.105447</td>
      <td>0.084655</td>
      <td>-0.044026</td>
      <td>-0.050865</td>
      <td>0.021769</td>
      <td>-0.032892</td>
      <td>0.275946</td>
    </tr>
    <tr>
      <th>SMVTP6284P</th>
      <td>-0.138389</td>
      <td>-1.217001</td>
      <td>-0.158511</td>
      <td>-0.270623</td>
      <td>0.026254</td>
      <td>0.616175</td>
      <td>0.059980</td>
      <td>-0.042928</td>
      <td>-0.068234</td>
      <td>0.032218</td>
      <td>0.360875</td>
    </tr>
  </tbody>
</table>
<p>132 rows × 11 columns</p>
</div></div></div>
</div>
<section id="id1">
<h4>Linear regression of each feature vs. hosptial thrombolysis rate<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">,</span><span class="s1">&#39;Infarction&#39;</span><span class="p">,</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Precise onset time&#39;</span><span class="p">,</span><span class="s1">&#39;Prior disability level&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Use of AF anticoagulants&#39;</span><span class="p">,</span><span class="s1">&#39;Onset-to-arrival time&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Onset during sleep&#39;</span><span class="p">,</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span>

<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;SHAP values for&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_mean_shap_main_effect_per_hosp</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regression between hosptial IVT rate and SHAP main effect for features &quot;</span>
      <span class="s2">&quot;(mean for those instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">plot_regressions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Regression between hosptial IVT rate and SHAP main effect for features (mean for those instances that attend the hospital)
</pre></div>
</div>
<img alt="../_images/e1d50bd7c5b6715c3df6d00d90976efcd78bf9612a14c32d0ad7e2a0867bfdfd.png" src="../_images/e1d50bd7c5b6715c3df6d00d90976efcd78bf9612a14c32d0ad7e2a0867bfdfd.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>()
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h4>Multiple regression on all features vs IVT rate<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP main effect for &quot;</span>
      <span class="s2">&quot;all features (mean for those instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP main effect for all features (mean for those instances that attend the hospital)

                             coeff
Arrival-to-scan time      0.057707
Infarction                0.039323
Stroke severity           0.096127
Precise onset time        0.120060
Prior disability level    0.114161
Use of AF anticoagulants  0.125367
Onset-to-arrival time    -0.038941
Onset during sleep        0.119999
Age                       0.063427
Stroke team               0.113671
</pre></div>
</div>
<img alt="../_images/41e7a50219556d7ac7bb17ab256d6b2ab6203b5cce5dabef9978d1cd820e349c.png" src="../_images/41e7a50219556d7ac7bb17ab256d6b2ab6203b5cce5dabef9978d1cd820e349c.png" />
</div>
</div>
</section>
<section id="id3">
<h4>Multiple regression on features (excluding attended hosptial) vs IVT rate<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">,</span><span class="s1">&#39;Infarction&#39;</span><span class="p">,</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Precise onset time&#39;</span><span class="p">,</span><span class="s1">&#39;Prior disability level&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Use of AF anticoagulants&#39;</span><span class="p">,</span><span class="s1">&#39;Onset-to-arrival time&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Onset during sleep&#39;</span><span class="p">,</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP main effect for &quot;</span>
      <span class="s2">&quot;features (mean for those instances that attend the hospital), excluding &quot;</span>
      <span class="s2">&quot;attended hospital SHAP main effect&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP main effect for features (mean for those instances that attend the hospital), excluding attended hospital SHAP main effect

                             coeff
Arrival-to-scan time      0.077741
Infarction                0.066426
Stroke severity           0.106478
Precise onset time        0.038122
Prior disability level    0.038869
Use of AF anticoagulants  0.078658
Onset-to-arrival time    -0.277673
Onset during sleep        0.139637
Age                       0.667224
</pre></div>
</div>
<img alt="../_images/ab80c3937b0d31291c63eca64fb54a97f2260f124e97a09ef376bf49643a05c6.png" src="../_images/ab80c3937b0d31291c63eca64fb54a97f2260f124e97a09ef376bf49643a05c6.png" />
</div>
</div>
</section>
<section id="id4">
<h4>Multiple regression on just patient characteristics vs IVT rate<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Infarction&#39;</span><span class="p">,</span><span class="s1">&#39;Stroke severity&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Precise onset time&#39;</span><span class="p">,</span><span class="s1">&#39;Prior disability level&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Use of AF anticoagulants&#39;</span><span class="p">,</span><span class="s1">&#39;Onset-to-arrival time&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Onset during sleep&#39;</span><span class="p">,</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP main effect for &quot;</span>
      <span class="s2">&quot;just patient features (mean for those instances that attend the &quot;</span>
      <span class="s2">&quot;hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP main effect for just patient features (mean for those instances that attend the hospital)

                             coeff
Infarction                0.044203
Stroke severity           0.161030
Precise onset time        0.052356
Prior disability level    0.041763
Use of AF anticoagulants  0.004634
Onset-to-arrival time    -0.332927
Onset during sleep        0.216029
Age                       0.793500
</pre></div>
</div>
<img alt="../_images/0175ea09587220185a5cae81542851fc9ccc2496b2525e81018f1bb0d01b7620.png" src="../_images/0175ea09587220185a5cae81542851fc9ccc2496b2525e81018f1bb0d01b7620.png" />
</div>
</div>
</section>
<section id="id5">
<h4>Multiple regression on just hospital processes vs IVT rate<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arrival-to-scan time&#39;</span><span class="p">,</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple regression between hosptial IVT rate and SHAP main effect for &quot;</span>
      <span class="s2">&quot; hospital features (mean for those instances that attend the hospital)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">fit_and_plot_multiple_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiple regression between hosptial IVT rate and SHAP main effect for  hospital features (mean for those instances that attend the hospital)

                         coeff
Arrival-to-scan time  0.078443
Stroke team           0.104766
</pre></div>
</div>
<img alt="../_images/2e31edee14f60e9ce681299f06b9b61b36bde6ba000f18852f04b29fc238939a.png" src="../_images/2e31edee14f60e9ce681299f06b9b61b36bde6ba000f18852f04b29fc238939a.png" />
</div>
</div>
<p>We can improve the division of patient features and hosptial features.</p>
<p>Since we’re splitting the features into two groups (hospital features, and patient features) to fit a multiple regression, we can improve what we include in the SHAP value.</p>
<p>So far we have looked at the two extremes: SHAP values (includes all interactions) and main effect (no interactions).</p>
<p>Next let’s only include the SHAP interactions for the features that are in the same regression. So only the main effect and the interactions that are with the other features in the multiple regression. Let’s call this the <em>subset</em> SHAP value.</p>
<p>This will exclude any SHAP interactions that are between the hospital features and patient features - and will remove any leakage of patient information into hospital SHAP, and hospital information into patient SHAP.</p>
<p>Calculate subset SHAP values and fit a multiple regression on these in notebook 03f_xgb_subset_shap_value_regressions_on_hospital_ivt_rate.ipynb.</p>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./xgb_10_features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="03d_xgb_all_data_shap_values_and_interaction_values_focus_on_ohe_hospitals.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Explore the hospital effect on thrombolysis use, using SHAP values and SHAP main effects from a single XGBoost model</p>
      </div>
    </a>
    <a class="right-next"
       href="03f_xgb_subset_shap_value_regressions_on_hospital_ivt_rate.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Calculate and use <em>subset</em> SHAP values (from a single XGBoost model) to attribute hospital IVT variation to patient mix and hospital processes</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plain-english-summary">Plain English summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-and-data">Model and data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aims">Aims</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-filenames">Set filenames</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-output-folders-if-needed">Create output folders if needed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-json-file">Read in JSON file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-list-of-feature-names">Get list of feature names</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edit-data">Edit data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">Divide into X (features) and y (labels)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encode-hospital-feature">One-hot encode hospital feature</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost-model">XGBoost model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-shap-values">Get SHAP values</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-the-shap-value-for-patient-features-compare-to-the-thrombolysis-rate-of-the-hospital">How does the SHAP value for patient features compare to the thrombolysis rate of the hospital?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-regressions-to-processed-data">Fit regressions to processed data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-regression-of-each-feature-vs-hosptial-thrombolysis-rate">Linear regression of each feature vs. hosptial thrombolysis rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-all-features-vs-ivt-rate">Multiple regression on all features vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-features-excluding-attended-hosptial-vs-ivt-rate">Multiple regression on features (excluding attended hosptial) vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-just-patient-characteristics-vs-ivt-rate">Multiple regression on just patient characteristics vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-regression-on-just-hospital-processes-vs-ivt-rate">Multiple regression on just hospital processes vs IVT rate</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#repeat-using-shap-main-effect">Repeat using SHAP main effect</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#get-shap-interaction-values">Get SHAP interaction values</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Linear regression of each feature vs. hosptial thrombolysis rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Multiple regression on all features vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Multiple regression on features (excluding attended hosptial) vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Multiple regression on just patient characteristics vs IVT rate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Multiple regression on just hospital processes vs IVT rate</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Kerry Pearn, Michael Allen, Anna Laws, Richard Everson, and Martin James
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>