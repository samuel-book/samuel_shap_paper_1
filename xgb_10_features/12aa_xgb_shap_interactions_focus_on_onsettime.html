
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Precise Onset Time &#8212; Using explainable machine learning to understand variation in thrombolysis practice</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Stroke Severity" href="12ab_xgb_shap_interactions_focus_on_severity.html" />
    <link rel="prev" title="Describing model predictions, using SHAP values and SHAP interactions" href="12a_xgb_shap_interactions.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Using explainable machine learning to understand variation in thrombolysis practice</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/intro.html">
                    Summary and outline
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introductory content
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../key_notebooks_redundant/outline.html">
   Outline of notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/data.html">
   Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/glossary.html">
   Glossary of technical terms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/odds_prob.html">
   Probability, odds, and SHAP values (log odds shifts)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/shap_worked_example.html">
   A simple worked example of Shap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="90_shap_interactions_on_titanic.html">
   Examining interactions between features with SHAP interactions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Predicting thrombolysis use and explaining the predictions with Shap
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_xgb_combined_fit_feature_selection.html">
   XGBoost feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_correlation.html">
   Check correlation between features selected for the model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_xgb_combined_fit_accuracy_key_features.html">
   Measuring accuracy of XGBoost models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02a_xgb_combined_fit_most_thrombolysable_patients.html">
   An anlysis of the characteristics of the most thrombolysable patient at each hopsital
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_xgb_combined_shap_key_features.html">
   Explaining XGBoost model predictions with SHAP values
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Comparing thrombolysis decisions between hospitals
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="04_compare_10k_cohort_key_features.html">
   A comparison of 10k cohort thrombolysis rates across hospitals, and comparison with hospital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_compare_benchmark_decisions_key_features.html">
   Compare local thrombolysis decisions with benchmark decisions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units.html">
   Comparing Shap values between high and low thrombolysing hospitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_plot_thrombolysis_at_high_vs_low_thrombolysing_units.html">
   Plotting thrombolysis rate by feature value for low and high thrombolysing hopsitals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03c_xgb_shap_values_and_interaction_values_focus_on_ohe_hospitals.html">
   Explaining XGBoost model predictions with SHAP values: Analysis of hopsital SHAP values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12a_xgb_shap_interactions.html">
   Describing model predictions, using SHAP values and SHAP interactions
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Precise Onset Time
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12ab_xgb_shap_interactions_focus_on_severity.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Stroke Severity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12ac_xgb_shap_interactions_focus_on_disability.html">
   Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with pre-stroke disability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="20_synthetic_patients.html">
   Investigating the effect of patient features by varying feature values in artificial patients
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="50_bagging_variation.html">
   Evaluating variation in model predictions and predicted 10k thrombolysis rate using bootstrap models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="91_learning_rate_optimisation.html">
   Evaluation of XGBoost learning rates on distribution of 10k thrombolysis rates
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/xgb_10_features/12aa_xgb_shap_interactions_focus_on_onsettime.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-modules">
   Import modules
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-xgboost-model">
   Fit XGBoost model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">
   Divide into X (features) and y (labels)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#one-hot-encode-hospitals">
   One hot encode hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Fit XGBoost model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-shap-values">
   Get SHAP values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-shap-interaction-values">
   Get SHAP interaction values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#look-at-one-feature-precise-onset-time">
   Look at one feature: ‘Precise onset time’
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shap-interaction-matrix-show-mean-absolute-values">
     SHAP interaction matrix: show mean absolute values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-proportion-of-shap-that-is-from-the-interactions-calculated-from-the-absolute-mean">
     The proportion of SHAP that is from the interactions: calculated from the absolute mean
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-dependence-plots-for-the-chosen-feature">
   SHAP dependence plots for the chosen feature
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#show-a-comparison-of-teams-with-different-interaction-direction">
   Show a comparison of teams with different interaction direction
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Precise Onset Time</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plain-english-summary">
   Plain English summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-and-data">
   Model and data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#aims">
   Aims
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-modules">
   Import modules
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-output-folders-if-needed">
   Create output folders if needed
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#read-in-json-file">
   Read in JSON file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-xgboost-model">
   Fit XGBoost model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#divide-into-x-features-and-y-labels">
   Divide into X (features) and y (labels)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#one-hot-encode-hospitals">
   One hot encode hospitals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Fit XGBoost model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-shap-values">
   Get SHAP values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-shap-interaction-values">
   Get SHAP interaction values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#look-at-one-feature-precise-onset-time">
   Look at one feature: ‘Precise onset time’
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shap-interaction-matrix-show-mean-absolute-values">
     SHAP interaction matrix: show mean absolute values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-proportion-of-shap-that-is-from-the-interactions-calculated-from-the-absolute-mean">
     The proportion of SHAP that is from the interactions: calculated from the absolute mean
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-dependence-plots-for-the-chosen-feature">
   SHAP dependence plots for the chosen feature
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#show-a-comparison-of-teams-with-different-interaction-direction">
   Show a comparison of teams with different interaction direction
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="describing-model-predictions-using-shap-values-and-shap-interactions-focusing-on-how-hospitals-interact-with-precise-onset-time">
<h1>Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Precise Onset Time<a class="headerlink" href="#describing-model-predictions-using-shap-values-and-shap-interactions-focusing-on-how-hospitals-interact-with-precise-onset-time" title="Permalink to this headline">#</a></h1>
<section id="plain-english-summary">
<h2>Plain English summary<a class="headerlink" href="#plain-english-summary" title="Permalink to this headline">#</a></h2>
<p>Having a 139 x 139 matrix of plots to digest is impossible. Here we focus just on the feature Precise Onset Time and look at the 138 plots showing the relationships between this feature and the 138 others (of which 132 are hospital one hot encoded features).</p>
<p>When fitting a machine learning model to data to make a prediction, it is now possible, with the use of the SHAP library, to allocate contributions of the prediction onto the feature values. This means that we can now turn these black box methods into transparent models and describe what the model used to obtain it’s prediction.</p>
<p>SHAP values are calculated for each feature of each instance for a fitted model. In addition there is the SHAP base value which is the same value for all of the instances. The base value represents the models best guess for any instance without any extra knowledge about the instance (this can also be thought of as the “expected value”). It is possible to obtain the models prediction of an instance by taking the sum of the SHAP base value and each of the SHAP values for the features. This allows the prediction from a model to be transparant, and we can rank the features by their importance in determining the prediction for each instance.</p>
<p>In our previous notebooks (03_xgb_combined_shap_key_features.ipynb) we saw that a feature with the same value in multiple instances (such as all of the patients that attend hospital A), the feature (Hospital A) does not necessarily have the same SHAP value in all of those instances. This means that the feature value alone is not a clear indication of the impact it will have on the prediction - this is due to there being feature interactions, such that SHAP values for a feature are influenced by the other feature values. This means that SHAP values are instance dependent (as they are also capturing the interactions between pairs of feature values). The SHAP values therefore are in turn made up of a main effect (what is due to the feature value, the standalone effect) and also the interactions with the other features (a value per feature pairings).</p>
<p>[Note: In this notebook we will refer to the parts of the SHAP value consistently as base value, main effect, and interactions, where the term SHAP feature value refers to the sum of the main effect and interactions].</p>
<p>SHAP values are in the same units as the model output (for XGBoost these are in log odds).</p>
<p>Here we fit an XGBoost model to the SAMueL dataset, to predict whether a patient recieves thrombolysis from the values of eight features. We calculate the SHAP values (base, main effect and feature interactions) of this fitted model and show the most useful way (that we have found) to present all of these values in order to gain the most insight into how the model is working. At present this is using a grid of SHAP dependency plots.</p>
<p>This notebook is based on the blog <a class="reference external" href="https://towardsdatascience.com/analysing-interactions-with-shap-8c4a2bc11c2a">https://towardsdatascience.com/analysing-interactions-with-shap-8c4a2bc11c2a</a></p>
</section>
<section id="model-and-data">
<h2>Model and data<a class="headerlink" href="#model-and-data" title="Permalink to this headline">#</a></h2>
<p>XGBoost model was trained on all of the data (no test set used). The 10 features in the model are:</p>
<ul class="simple">
<li><p>Arrival-to-scan time: Time from arrival at hospital to scan (mins)</p></li>
<li><p>Infarction: Stroke type (1 = infarction, 0 = haemorrhage)</p></li>
<li><p>Stroke severity: Stroke severity (NIHSS) on arrival</p></li>
<li><p>Precise onset time: Onset time type (1 = precise, 0 = best estimate)</p></li>
<li><p>Prior disability level: Disability level (modified Rankin Scale) before stroke</p></li>
<li><p>Stroke team: Stroke team attended</p></li>
<li><p>Use of AF anticoagulents: Use of atrial fibrillation anticoagulant (1 = Yes, 0 = No)</p></li>
<li><p>Onset-to-arrival time: Time from onset of stroke to arrival at hospital (mins)</p></li>
<li><p>Onset during sleep: Did stroke occur in sleep?</p></li>
<li><p>Age: Age (as middle of 5 year age bands)</p></li>
</ul>
<p>And one target feature:</p>
<ul class="simple">
<li><p>Thrombolysis: Did the patient recieve thrombolysis (0 = No, 1 = Yes)</p></li>
</ul>
</section>
<section id="aims">
<h2>Aims<a class="headerlink" href="#aims" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Fit XGBoost model using feature data to predict whether patient gets thrombolysis</p></li>
<li><p>Calculate the SHAP main effect and SHAP interaction values</p></li>
<li><p>Understand the SHAP main effect and SHAP interaction values</p></li>
<li><p>Find the best way to display these values in order to gain the most insight into the relationships that the model is using</p></li>
</ul>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>SHAP interactions are awesome!</p></li>
<li><p>Viewing them as a grid of SHAP dependency plots clearly shows the overall relationships that the model uses to derive it’s predictions for the whole dataset, and allows us to see different patterns in different hopsitals.</p></li>
<li><p>The main effect of the <em>precise onset time</em> is that if onset time is known precicely then SHAP (log odds) is increased by 0.42, otherwise it is reduced by 0.85.</p></li>
<li><p>The interaction between the hopsital and precise onset time then adjusts this main effect. Some hopsitals strengthen the effect, and other hopsitals atenuate the effect.</p></li>
</ul>
</section>
<section id="import-modules">
<h2>Import modules<a class="headerlink" href="#import-modules" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Import machine learning methods</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="c1"># Import shap for shapley values</span>
<span class="kn">import</span> <span class="nn">shap</span> <span class="c1"># `pip install shap` if neeed</span>

<span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/michael/miniconda3/envs/samuel/lib/python3.8/site-packages/xgboost/compat.py:36: FutureWarning: pandas.Int64Index is deprecated and will be removed from pandas in a future version. Use pandas.Index with the appropriate dtype instead.
  from pandas import MultiIndex, Int64Index
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-output-folders-if-needed">
<h2>Create output folders if needed<a class="headerlink" href="#create-output-folders-if-needed" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./saved_models&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-json-file">
<h2>Read in JSON file<a class="headerlink" href="#read-in-json-file" title="Permalink to this headline">#</a></h2>
<p>Contains a dictionary for plain English feature names for the 8 features selected in the model. Use these as the column titles in the DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./output/01_feature_name_dict.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">feature_name_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline">#</a></h2>
<p>Data has previously been split into 5 stratified k-fold splits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;../data/kfold_5fold/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialise empty lists</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="c1"># Read in the names of the selected features for the model</span>
<span class="n">number_of_features_to_use</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./output/01_feature_selection.csv&#39;</span><span class="p">)</span>
<span class="n">key_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])[:</span><span class="n">number_of_features_to_use</span><span class="p">]</span>
<span class="c1"># And add the target feature name: S2Thrombolysis</span>
<span class="n">key_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">)</span>

<span class="c1"># For each k-fold split</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="c1"># Read in training set, restrict to chosen features, rename titles, &amp; store</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;train_</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">key_features</span><span class="p">]</span>
    <span class="n">train</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">feature_name_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
    <span class="c1"># Read in test set, restrict to chosen features, rename titles, &amp; store</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;test_</span><span class="si">{0}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">key_features</span><span class="p">]</span>
    <span class="n">test</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">feature_name_dict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For this exercise, train the model using all the data. Join up all of the test data (by definition, each instance exists only once across all of the 5 test sets)</p>
<p>Set “ignore_index = True” to reset the index from 0 to (n-1), otherwise get duplicate values in the index</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-xgboost-model">
<h2>Fit XGBoost model<a class="headerlink" href="#fit-xgboost-model" title="Permalink to this headline">#</a></h2>
<p>Fit XGBoost model</p>
</section>
<section id="divide-into-x-features-and-y-labels">
<h2>Divide into X (features) and y (labels)<a class="headerlink" href="#divide-into-x-features-and-y-labels" title="Permalink to this headline">#</a></h2>
<p>We will separate out our features (the data we use to make a prediction) from our label (what we are trying to predict).
By convention our features are called <code class="docutils literal notranslate"><span class="pre">X</span></code> (usually upper case to denote multiple features), and the label (thrombolysis or not) <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Thrombolysis&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Average thromboylsis (this is the expected outcome of each patient, without knowing anything about the patient)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average treatment: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average treatment: 0.3
</pre></div>
</div>
</div>
</div>
</section>
<section id="one-hot-encode-hospitals">
<h2>One hot encode hospitals<a class="headerlink" href="#one-hot-encode-hospitals" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">X_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Stroke team&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h2>Fit XGBoost model<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>We will fit a model to all of the data (rather than train/test splits used to assess accuracy).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#model = XGBClassifier(verbosity = 0, seed=42, learning_rate=0.5)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[08:27:33] WARNING: /tmp/abs_40obctay9q/croots/recipe/xgboost-split_1659548945886/work/src/learner.cc:1115: Starting in XGBoost 1.3.0, the default evaluation metric used with the objective &#39;binary:logistic&#39; was changed from &#39;error&#39; to &#39;logloss&#39;. Explicitly set eval_metric if you&#39;d like to restore the old behavior.
</pre></div>
</div>
<div class="output text_html"><style>#sk-container-id-1 {color: black;background-color: white;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>XGBClassifier(base_score=0.5, booster=&#x27;gbtree&#x27;, colsample_bylevel=1,
              colsample_bynode=1, colsample_bytree=1, enable_categorical=False,
              gamma=0, gpu_id=-1, importance_type=None,
              interaction_constraints=&#x27;&#x27;, learning_rate=0.5, max_delta_step=0,
              max_depth=6, min_child_weight=1, missing=nan,
              monotone_constraints=&#x27;()&#x27;, n_estimators=100, n_jobs=36,
              num_parallel_tree=1, predictor=&#x27;auto&#x27;, random_state=42,
              reg_alpha=0, reg_lambda=1, scale_pos_weight=1, subsample=1,
              tree_method=&#x27;exact&#x27;, validate_parameters=1, verbosity=None)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">XGBClassifier</label><div class="sk-toggleable__content"><pre>XGBClassifier(base_score=0.5, booster=&#x27;gbtree&#x27;, colsample_bylevel=1,
              colsample_bynode=1, colsample_bytree=1, enable_categorical=False,
              gamma=0, gpu_id=-1, importance_type=None,
              interaction_constraints=&#x27;&#x27;, learning_rate=0.5, max_delta_step=0,
              max_depth=6, min_child_weight=1, missing=nan,
              monotone_constraints=&#x27;()&#x27;, n_estimators=100, n_jobs=36,
              num_parallel_tree=1, predictor=&#x27;auto&#x27;, random_state=42,
              reg_alpha=0, reg_lambda=1, scale_pos_weight=1, subsample=1,
              tree_method=&#x27;exact&#x27;, validate_parameters=1, verbosity=None)</pre></div></div></div></div></div></div></div>
</div>
<p>Get the predictions for each patient (in terms of the classification, and the probability of being in either class)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate the models accuracy</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model accuracy: 0.878
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-shap-values">
<h2>Get SHAP values<a class="headerlink" href="#get-shap-values" title="Permalink to this headline">#</a></h2>
<p>TreeExplainer is a fast and exact method to estimate SHAP values for tree models and ensembles of trees.
Using this we can calculate the SHAP values.</p>
<p>Either load from pickle (if file exists), or calculate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># Set up method to estimate SHAP values for tree models and ensembles of trees</span>

<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03a_xgb_shap_explainer_object.p&#39;</span>
<span class="n">file_exists</span> <span class="o">=</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
    <span class="c1"># Load SHAP interaction</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Set up method to estimate SHAP values for tree models &amp; ensembles of trees</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Save using pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">explainer</span><span class="p">,</span> <span class="n">filehandler</span><span class="p">)</span>

<span class="c1"># Get SHAP values</span>

<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03a_xgb_shap_values_explainer_object.p&#39;</span>
<span class="n">file_exists</span> <span class="o">=</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
    <span class="c1"># Load explainer</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Get SHAP values</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># Save using pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shap_values</span> <span class="p">,</span> <span class="n">filehandler</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 4.49 s, sys: 210 ms, total: 4.7 s
Wall time: 148 ms
</pre></div>
</div>
</div>
</div>
<p>The explainer returns the base value which is the same value for all instances [shap_value.base_values], the shap values per feature [shap_value.values]. It also returns the feature dataset values [shap_values.data]. You can (sometimes!) access the feature names from the explainer [explainer.data_feature_names].</p>
<p>Let’s take a look at the data held for the first instance:</p>
<ul class="simple">
<li><p>.values has the SHAP value for each of the four features.</p></li>
<li><p>.base_values has the best guess value without knowing anything about the instance.</p></li>
<li><p>.data has each of the feature values</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.values =
array([ 7.56502628e-01,  4.88319576e-01,  1.10273695e+00,  4.40223962e-01,
        4.98975307e-01,  2.02812225e-01, -2.62601525e-01,  3.69181409e-02,
        2.30234995e-01,  3.20923195e-04, -6.03703642e-03, -7.17267860e-04,
        0.00000000e+00, -4.91688668e-04,  1.20360847e-03,  1.77788886e-03,
       -4.34198463e-03, -2.76021136e-04, -2.79896380e-03,  3.52182891e-03,
       -2.73969141e-04,  8.53505917e-03, -5.28220041e-03, -8.25227005e-04,
        6.20208494e-03,  6.92215608e-03, -6.32244349e-03, -3.35367222e-04,
        7.81939551e-03, -4.71850217e-06, -4.25534381e-05,  6.48253039e-03,
        8.43156071e-04, -6.28353562e-04, -1.25156669e-02, -7.92063680e-03,
       -1.99409085e-03, -5.05548809e-03, -3.90118686e-03,  1.30317558e-03,
        0.00000000e+00, -6.48246554e-04,  1.19629130e-03,  8.26304778e-04,
        1.28053436e-02,  2.55714403e-03, -3.20375757e-03,  4.23251512e-03,
       -7.19791185e-03,  4.02670400e-03,  3.75146419e-03,  8.31848301e-04,
        3.45067866e-03,  3.92199913e-03,  1.05317042e-04,  9.53648426e-03,
        2.34490633e-03, -1.05699897e-03, -7.75758363e-03,  1.09220366e-03,
        0.00000000e+00,  5.15310653e-03, -1.28013985e-02,  7.28079583e-03,
        1.98326469e-03,  2.40865033e-04,  6.70310017e-03,  1.18395500e-03,
        8.82393331e-04,  2.83133984e-03,  2.06021918e-03, -8.22589453e-03,
        5.11038816e-03, -3.25066457e-03, -1.15480982e-02,  9.36000666e-04,
        2.03671609e-03, -2.02708528e-03, -5.31264208e-03,  2.42300611e-03,
        3.16989725e-04,  3.67143471e-03, -5.07418578e-03, -2.68517504e-03,
        3.30522249e-04, -6.63852552e-03, -1.63316587e-03,  1.75383547e-03,
       -4.12231544e-03,  1.20234396e-03, -6.25999365e-03,  0.00000000e+00,
       -1.00428164e-02, -1.76329317e-03,  3.12283775e-03,  4.69124934e-04,
       -1.22163491e-03,  2.30912305e-03,  9.43152234e-04,  1.22348359e-03,
        5.29656609e-05, -9.66969132e-03,  3.44762520e-06, -5.46710449e-04,
        4.26546484e-03,  4.65912558e-03,  1.30611981e-04, -2.89813057e-03,
       -2.98934802e-03, -1.47398096e-03, -2.31104009e-02, -3.47609469e-03,
       -5.73671749e-03,  3.97895870e-04,  9.02379164e-04, -5.86819311e-04,
       -1.79305486e-03, -5.28960605e-04, -2.10736915e-02,  3.50499223e-03,
       -2.04754542e-04, -2.86527374e-03,  1.52953295e-03, -3.72403156e-06,
        1.42271689e-03, -2.97368824e-04,  5.06201060e-04,  5.77868486e-04,
       -1.44459037e-02,  3.30785802e-03, -2.37809308e-03, -7.35214865e-03,
        3.36531224e-03,  1.49519066e-03, -2.46208580e-03,  7.20066251e-04,
        6.83251710e-04, -1.92034326e-03,  2.39002449e-03, -8.96935933e-04,
        4.85493708e-03], dtype=float32)

.base_values =
-1.1629876

.data =
array([ 17. ,   1. ,  14. ,   1. ,   0. ,   0. , 186. ,   0. ,  47.5,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   1. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,   0. ,
         0. ,   0. ,   0. ,   0. ,   0. ,   0. ])
</pre></div>
</div>
</div>
</div>
<p>There is one of these for each instance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_values</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(88792, 141)
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-shap-interaction-values">
<h2>Get SHAP interaction values<a class="headerlink" href="#get-shap-interaction-values" title="Permalink to this headline">#</a></h2>
<p>Use the TreeExplainer to also calculate the SHAP main effect and SHAP interaction values (the sum of which give the SHAP values for each feature).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./output/03a_xgb_shap_interaction_array.p&#39;</span>
<span class="n">file_exists</span> <span class="o">=</span> <span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">file_exists</span><span class="p">:</span>
    <span class="c1"># Load SHAP interaction</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">shap_interaction</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Get SHAP interaction values</span>
    <span class="n">shap_interaction</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_interaction_values</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># Save using pickle</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandler</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">shap_interaction</span><span class="p">,</span> <span class="n">filehandler</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 6.77 ms, sys: 2.99 s, total: 2.99 s
Wall time: 2.99 s
</pre></div>
</div>
</div>
</div>
<p>SHAP interaction values have a matrix of values (per pair of features) per instance.<br />
In this case, each of the 891 instances has a 4x4 matrix of SHAP interaction values (with the SHAP main effect on the diagonal positions).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_interaction</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(88792, 141, 141)
</pre></div>
</div>
</div>
</div>
<p>Show SHAP interation matrix (with main effect on the diagonal positions) for the first instance. Notice how the SHAP interation for pairs of features are symmetrical across the diagonal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap_interaction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 6.76276624e-01,  4.08733338e-02,  1.05852485e-02, ...,
         1.75262336e-04,  1.55542511e-05, -3.98763688e-04],
       [ 4.08733785e-02,  3.38386327e-01,  5.30318618e-02, ...,
         0.00000000e+00,  0.00000000e+00,  6.54254109e-07],
       [ 1.05856061e-02,  5.30319214e-02,  8.62581849e-01, ...,
         1.82669377e-04,  3.62747931e-04,  8.75864644e-05],
       ...,
       [ 1.75237656e-04,  0.00000000e+00,  1.82688236e-04, ...,
         3.14869266e-03,  0.00000000e+00,  3.90200876e-06],
       [ 1.55568123e-05,  0.00000000e+00,  3.62753868e-04, ...,
         0.00000000e+00, -1.80786219e-03,  0.00000000e+00],
       [-3.98725271e-04,  6.55651093e-07,  8.76188278e-05, ...,
         3.90200876e-06,  0.00000000e+00,  3.13467532e-03]], dtype=float32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="look-at-one-feature-precise-onset-time">
<h2>Look at one feature: ‘Precise onset time’<a class="headerlink" href="#look-at-one-feature-precise-onset-time" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chosen_feature</span> <span class="o">=</span> <span class="s1">&#39;Precise onset time&#39;</span>
</pre></div>
</div>
</div>
</div>
<section id="shap-interaction-matrix-show-mean-absolute-values">
<h3>SHAP interaction matrix: show mean absolute values<a class="headerlink" href="#shap-interaction-matrix-show-mean-absolute-values" title="Permalink to this headline">#</a></h3>
<p>Here we see the absolute mean of the SHAP interaction values for all of the instances.</p>
<p>Show data for the feature Precise Onset Time. The value in the column “Precise onset time” shows the main effect for the feature, and the other values show the SHAP interaction for pairs of features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_abs_interactions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shap_interaction</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mean_abs_interactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">chosen_feature</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                    Arrival-to-scan time  Infarction  Stroke severity  \
Precise onset time                  0.03        0.07             0.06   

                    Precise onset time  Prior disability level  \
Precise onset time                0.58                    0.02   

                    Use of AF anticoagulants  Onset-to-arrival time  \
Precise onset time                      0.01                   0.01   

                    Onset during sleep   Age  team_AGNOF1041H  ...  \
Precise onset time                0.02  0.01              0.0  ...   

                    team_XKAWN3771U  team_XPABC1435F  team_XQAGA4299B  \
Precise onset time              0.0              0.0              0.0   

                    team_XWUBX0795L  team_YEXCH8391J  team_YPKYH1768F  \
Precise onset time              0.0              0.0              0.0   

                    team_YQMZV4284N  team_ZBVSO0975W  team_ZHCLE1578P  \
Precise onset time              0.0              0.0              0.0   

                    team_ZRRCV7012C  
Precise onset time              0.0  

[1 rows x 141 columns]
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-proportion-of-shap-that-is-from-the-interactions-calculated-from-the-absolute-mean">
<h3>The proportion of SHAP that is from the interactions: calculated from the absolute mean<a class="headerlink" href="#the-proportion-of-shap-that-is-from-the-interactions-calculated-from-the-absolute-mean" title="Permalink to this headline">#</a></h3>
<p>Looking at all of the instances together, what proportion of the SHAP value comes from the SHAP interations and what from the main effect (for the feature “Precise onset time”)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_shap</span> <span class="o">=</span> <span class="n">mean_abs_interactions</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Precise onset time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">main_shap</span> <span class="o">=</span> <span class="n">mean_abs_interactions</span><span class="p">[</span><span class="s2">&quot;Precise onset time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Precise onset time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">interaction_shap</span> <span class="o">=</span> <span class="n">total_shap</span> <span class="o">-</span> <span class="n">main_shap</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;For feature &quot;Precise onset time&quot;, the proportion of the SHAP values coming from the interactions are: &#39;</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">interaction_shap</span><span class="o">/</span><span class="n">total_shap</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;For feature &quot;Precise onset time&quot;, the proportion of the SHAP values coming from the main effects are: &#39;</span>
      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">main_shap</span><span class="o">/</span><span class="n">total_shap</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For feature &quot;Precise onset time&quot;, the proportion of the SHAP values coming from the interactions are: 0.371
For feature &quot;Precise onset time&quot;, the proportion of the SHAP values coming from the main effects are: 0.629
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="shap-dependence-plots-for-the-chosen-feature">
<h2>SHAP dependence plots for the chosen feature<a class="headerlink" href="#shap-dependence-plots-for-the-chosen-feature" title="Permalink to this headline">#</a></h2>
<p>We will now show all of the SHAP interaction values between the chosen feature and all of the one-hot encoded hospital features.</p>
<p>Show just the row for Precise Onset Known vs the 132 hosptials (display them as a grid of subplots, but this is not a matrix, there is no logic to their position in the grid apart from the order in which they appear in the dataset)</p>
<p>Resources used to make the grid of dependence plots: <a class="reference external" href="https://stackoverflow.com/questions/58510005/python-shap-package-how-to-plot-a-grid-of-dependence-plots">https://stackoverflow.com/questions/58510005/python-shap-package-how-to-plot-a-grid-of-dependence-plots</a> <br />
(for future reference, but not yet used here: <a class="reference external" href="https://gist.github.com/eddjberry/3c1818a780d3cb17390744d6e215ba4d">https://gist.github.com/eddjberry/3c1818a780d3cb17390744d6e215ba4d</a>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get list of hospital one hot encoded column titles</span>
<span class="n">hospital_names_ohe</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;^team&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
<span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hospital_names_ohe</span><span class="p">)</span>

<span class="c1"># Number of subplots per row (the number of columns)</span>
<span class="n">ncols</span> <span class="o">=</span> <span class="mi">4</span>
<span class="k">if</span> <span class="p">(</span><span class="n">n_hospitals</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_hospitals</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">n_hospitals</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Show dependency plots from the row</span>

<span class="c1"># Set up the matrix of subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="n">nrows</span><span class="p">,</span> 
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncols</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># Plot each SHAP independence (and main effect on diagonal)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">f2</span> <span class="ow">in</span> <span class="n">hospital_names_ohe</span><span class="p">:</span>

    <span class="c1"># Add more jitter the fewer categories the feature has</span>
    <span class="n">n_categories</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">chosen_feature</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">x_jitter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_categories</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>

    <span class="c1"># Plot data</span>
    <span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span>
        <span class="p">(</span><span class="n">chosen_feature</span><span class="p">,</span> <span class="n">f2</span><span class="p">),</span> <span class="n">shap_interaction</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">x_jitter</span><span class="o">=</span><span class="n">x_jitter</span><span class="p">,</span> 
        <span class="n">display_features</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>

    <span class="c1"># Add line at Shap = 0</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">chosen_feature</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>   
    
    <span class="c1"># Tailor which plots get which information</span>
    <span class="c1">#   First column gets y label</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SHAP interaction value&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>

    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Visual properties of figure</span>
<span class="n">dimension</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">ncols</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">dimension</span> <span class="o">*</span> <span class="p">(</span><span class="n">nrows</span><span class="o">/</span><span class="n">ncols</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span>
<span class="c1">#plt.tight_layout(pad=2)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/12aa_xgb_shap_interactions_focus_on_onsettime_44_0.png" src="../_images/12aa_xgb_shap_interactions_focus_on_onsettime_44_0.png" />
</div>
</div>
<p>How to interpret.</p>
<p>Interested in where the red dots are (attending this hospital). Can ignore the blue dots for now.</p>
<p>If red dots are negative for column 0 (best guess) and positive for column 1 (precise) then the interaction between precise onset time and this hospital is that having a precise onset time contributes to a more likely thrombolysis decision, and best estimate contributes to a less likely thrombolysis decision. (This is what we would expect).</p>
<p>If red dots are positive for column 0 (best guess) and negative for column 1 (precise) then the interaction between precise onset time and this hospital is that having a precise onset time contributes to a less likely thrombolysis decision, and best estimate contributes to a more likely thrombolysis decision. (This is the opposite to what we would expect).</p>
<p>If red dots are neutral for both column 0 (best guess) and column 1 (precise) then there is no interaction between precise onset time and this hospital - this hospital does not appear to use this information for it’s thrombolysis decision making.</p>
<p>Show just the column for Precise Onset Known vs the 132 hosptials (display them as a grid of subplots, but this is not a matrix, there is no logic to their position in the grid apart from the order in which they appear in the dataset)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show dependency plots from the column</span>

<span class="c1"># Set up the matrix of subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="n">nrows</span><span class="p">,</span> 
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncols</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">f1</span> <span class="ow">in</span> <span class="n">hospital_names_ohe</span><span class="p">:</span>

    <span class="c1"># Add more jitter the fewer categories the feature has</span>
    <span class="n">n_categories</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">x_jitter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_categories</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>

    <span class="c1"># Plot data</span>
    <span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span>
        <span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">chosen_feature</span><span class="p">),</span> <span class="n">shap_interaction</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">x_jitter</span><span class="o">=</span><span class="n">x_jitter</span><span class="p">,</span> 
        <span class="n">display_features</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>

    <span class="c1"># Add line at Shap = 0</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>   
    
    <span class="c1"># Remove 0 column (all the information is in the &quot;1&quot; attended hospital column)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">))</span>
    
    <span class="c1"># Tailor which plots get which information</span>
    <span class="c1">#   First column gets y label</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SHAP interaction value&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
<span class="c1">#    #   Last column legend</span>
<span class="c1">#    if not ((count+1)/ncols).is_integer():</span>
<span class="c1">#        axes[count].legend().set_visible(False)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Visual properties of figure</span>
<span class="n">dimension</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">ncols</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">dimension</span> <span class="o">*</span> <span class="p">(</span><span class="n">nrows</span><span class="o">/</span><span class="n">ncols</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span>
<span class="c1">#plt.tight_layout(pad=2)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/12aa_xgb_shap_interactions_focus_on_onsettime_47_0.png" src="../_images/12aa_xgb_shap_interactions_focus_on_onsettime_47_0.png" />
</div>
</div>
</section>
<section id="show-a-comparison-of-teams-with-different-interaction-direction">
<h2>Show a comparison of teams with different interaction direction<a class="headerlink" href="#show-a-comparison-of-teams-with-different-interaction-direction" title="Permalink to this headline">#</a></h2>
<p>team_HZNVT9936G has a greater aversion to giving thrombolysis than the main effect of stroke onste time type.</p>
<p>team_FAJKD7118X has a reduced aversion to giving thrombolysis than the main effect of stroke onste time type.</p>
<p>Examining the <em>precise onset time</em> main effects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature</span>  <span class="o">=</span> <span class="s2">&quot;Precise onset time&quot;</span>
<span class="n">feature_loc</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
<span class="n">feature_main_effect</span> <span class="o">=</span> <span class="n">shap_interaction</span><span class="p">[:,</span><span class="n">feature_loc</span><span class="p">,</span> <span class="n">feature_loc</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Precise onset time&quot;</span><span class="p">:</span><span class="s2">&quot;values&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;main effect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_main_effect</span>

<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;values&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>main effect</th>
    </tr>
    <tr>
      <th>values</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.848683</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.423840</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Examining the <em>team</em> main effects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">f1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;team_HZNVT9936G&#39;</span><span class="p">,</span><span class="s1">&#39;team_FAJKD7118X&#39;</span><span class="p">]:</span>
    <span class="n">feature_loc</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">feature_main_effect</span> <span class="o">=</span> <span class="n">shap_interaction</span><span class="p">[:,</span><span class="n">feature_loc</span><span class="p">,</span> <span class="n">feature_loc</span><span class="p">]</span>
    <span class="n">feature_shap_value</span> <span class="o">=</span> <span class="n">shap_interaction</span><span class="p">[:,</span><span class="n">feature_loc</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">f1</span><span class="p">:</span><span class="s2">&quot;data value&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;main effect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_main_effect</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;shap value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_shap_value</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hosptial </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="s2"> SHAP (main effect &amp; values) for patients attending (1) and not (0)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;data value&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="nb">print</span> <span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hosptial team_HZNVT9936G SHAP (main effect &amp; values) for patients attending (1) and not (0)
            main effect  shap value
data value                         
0             -0.001734   -0.001082
1              0.262858    0.037823

Hosptial team_FAJKD7118X SHAP (main effect &amp; values) for patients attending (1) and not (0)
            main effect  shap value
data value                         
0              0.008062    0.006787
1             -0.265043   -0.259819
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show dependency plots from the column</span>

<span class="c1"># Set up the matrix of subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
    <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">f1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;team_HZNVT9936G&#39;</span><span class="p">,</span><span class="s1">&#39;team_FAJKD7118X&#39;</span><span class="p">]:</span>

    <span class="c1"># Add more jitter the fewer categories the feature has</span>
    <span class="n">n_categories</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">x_jitter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.7</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_categories</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>

    <span class="c1"># Plot data</span>
    <span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span>
        <span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">chosen_feature</span><span class="p">),</span> <span class="n">shap_interaction</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">x_jitter</span><span class="o">=</span><span class="n">x_jitter</span><span class="p">,</span> 
        <span class="n">display_features</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>

    <span class="c1"># Add line at Shap = 0</span>
    <span class="n">n_classes</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_classes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>   
    
    <span class="c1"># Remove 0 column (all the information is in the &quot;1&quot; attended hospital column)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">))</span>
    
    <span class="c1"># Tailor which plots get which information</span>
    <span class="c1">#   First column gets y label</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SHAP interaction value&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./output/12aa_onset_time_type_interaction_example.jpg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/12aa_xgb_shap_interactions_focus_on_onsettime_53_0.png" src="../_images/12aa_xgb_shap_interactions_focus_on_onsettime_53_0.png" />
</div>
</div>
<p>Notes:</p>
<ul class="simple">
<li><p>The main effect of the <em>precise onset time</em> is that if onset time is known precicely then SHAP (log odds) is increased by 0.42, otherwise it is reduced by 0.85.</p></li>
<li><p><em>team_HZNVT9936G</em> has a slightly higher main effect for hopsital SHAP (0.26) than <em>team_FAJKD7118X -0.27)</em>. <em>team_HZNVT9936G</em> also has interactions that strengthen the effect of <em>precise onset time</em> whereas <em>team_FAJKD7118X</em> has interactions values that attenuate the main effect of <em>precise onset time</em>.</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./xgb_10_features"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="12a_xgb_shap_interactions.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Describing model predictions, using SHAP values and SHAP interactions</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="12ab_xgb_shap_interactions_focus_on_severity.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Describing model predictions, using SHAP values and SHAP interactions focusing on how Hospitals interact with Stroke Severity</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Kerry Pearn & Michael Allen<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>